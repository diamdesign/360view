import*as THREE from"three";import{OrbitControls}from"three/examples/jsm/controls/OrbitControls";import{CSS2DRenderer,CSS2DObject}from"three/addons/renderers/CSS2DRenderer.js";import{rootHTML,haspassHTML}from"./360template.min.js";import{buildComments}from"./comments.min.js";import{receiveMessage,dataURItoBlob}from"./functions.min.js";import{testInternetSpeed,xhrSend,getUrlParameter,formatNumber,copyToClipboard}from"./functions.min.js";var listItems,marker,editmode,userSubscriber,userInteracted=!1,dataType="",markerData=[],highSpeed=!1,sceneType="image",overidePassword=!1;const eventListenerPromise=new Promise((e=>{window.addEventListener("message",(function(t){const o=receiveMessage(t);o&&e(o)}),!1)}));async function waitForEventListener(){const e=await eventListenerPromise;editmode=e.editmode,userSubscriber=e.subscriber,console.log("Edit mode:",editmode,"Subscriber:",userSubscriber)}function imageClickHandler(e){e.stopPropagation();const t=document.querySelector("#root"),o=document.createElement("div"),n=e.target.cloneNode(!0),r="zoom-div-"+Date.now();o.id=r,o.classList.add("zoomedimage");const a=n.src;n.src=a.replace(/(-low640)(\.\w+)$/,"$2"),n.classList.remove("zoom-image"),o.appendChild(n),t.appendChild(o),o.addEventListener("click",(function(){t.removeChild(o)}))}waitForEventListener();const root=new THREE.Group;window.addEventListener("load",(function(){testInternetSpeed().then((e=>{console.log("Internet speed:",e,"Kbps"),e>=1e3?(console.log("High-speed connection detected. Load high-quality."),highSpeed=!0):(console.log("Low-speed connection detected. Load low-quality."),highSpeed=!1)})).catch((e=>{console.error("Error testing internet speed:",e)}))}));const embedId=getUrlParameter("i");var locId=getUrlParameter("loc");locId||(locId=1);const baseUri="localhost/360/",uri="i="+embedId+"&loc="+locId;var userID=null,creatorID=null,projectID=null,locationID=null,subscriber=0,startLocX=0,startLocY=0,currentLocX=0,currentLocY=0,selectStartLocation=locId,shareLink=baseUri+"watch/?="+embedId+"&loc="+selectStartLocation+"&x="+startLocX+"&y="+startLocY,embedLink=baseUri+"embed/?="+embedId+"&loc"+selectStartLocation+"&x="+startLocX+"&y"+startLocY,setEmbedWidth="640",setEmbedHeight="480",embedIframeLink=`<iframe width="${setEmbedWidth}" height="${setEmbedHeight}" src="${embedLink}" title="360 player"></iframe>`;function updateShareLink(){shareLink=baseUri+"watch/?="+embedId+"&loc="+selectStartLocation+"&x="+startLocX+"&y="+startLocY,embedIframeLink=`<iframe width="${setEmbedWidth}" height="${setEmbedHeight}" src="${embedLink=baseUri+"embed/?="+embedId+"&loc="+selectStartLocation}" title="360 player"></iframe>`}const fileCheckData="../php/checkdata.php",fileGetData="../php/getdata.php";function buildHtml(){document.getElementById("root").innerHTML=rootHTML}function buildPasswordHtml(){document.getElementById("root").innerHTML=haspassHTML,document.querySelector("#haspass-password").focus(),document.querySelector("#enter-password").addEventListener("click",(e=>{e.preventDefault();const t=document.querySelector("#haspass-login form"),o=document.querySelector("#haspass-password").value.trim();t.insertAdjacentHTML("beforebegin",'<div class="loader"></div>');const n=document.querySelector(".loader");if(t.style.display="none",""===o)return alert("Password can not be empty."),t.style.display="block",void n.remove();if(o.length<5)return alert("Password must be 5 letters or longer."),t.style.display="block",void n.remove();xhrSend("POST","../php/checkpass.php","i="+embedId+"&loc="+locId+"&pass="+o).then((e=>{console.log(e),e.success?(document.querySelector("#haspass-login").remove(),xhrSend("POST",fileGetData,uri).then((e=>{console.log(e),overidePassword=!0,buildHtml(),start(e)})).catch((e=>{console.error("Start after password check. XHR request failed:",e)}))):setTimeout((()=>{alert("Wrong password."),t.style.display="block",n.remove()}),3e3)})).catch((e=>{console.error("Check password. XHR request failed:",e)}))}))}const parser=new DOMParser;function start(e){e.hasOwnProperty("project")?(dataType="project",projectID=e.project.id):dataType="location",userID=e.user.id,creatorID=e.creator.id,subscriber=e.user.subscriber,console.log("Data Type:",dataType),editmode&&document.querySelector("#logo").classList.add("editmode");const t="http://localhost/360/",o=document.querySelector("#root"),n=document.getElementById("view-container"),r=document.querySelector("#zoombtn"),a=document.querySelector("#zoomlevel"),i=document.querySelector("#mapbtn"),s=document.querySelector(".rightbuttons"),l=document.querySelector("#fullscreenbtn"),c=document.getElementById("locations"),d=document.getElementById("angleIndicator"),u=document.querySelector("#indicatorbtn"),m=document.querySelector("#closesharebtn"),p=document.querySelector("#share"),v=document.querySelector("#sharebtn"),y=document.querySelector("#closeinfobtn"),h=document.querySelector("#info"),f=document.querySelector("#infobtn"),g=document.querySelector("#resizer"),b=(document.querySelector("#likebtn"),document.querySelector("#commentbtn")),L=document.querySelector("#comments"),E=document.querySelector("#btn-playvideo"),S=document.querySelector("#videoplayer"),w=document.querySelector("#playvideo"),q=document.querySelector("#videoduration"),k=document.querySelector("#caption"),x=document.querySelector("#captionselect"),T=document.querySelector("#captionselect ul"),I=document.querySelector("#scrollable"),H=document.querySelector("#labels"),$=document.querySelector("#settings"),A=document.getElementById("brightness"),R=document.getElementById("contrast"),C=document.getElementById("saturation"),M=document.getElementById("ambient"),j=document.getElementById("volume"),_=document.getElementById("brightnessNo"),D=document.getElementById("contrastNo"),P=document.getElementById("saturationNo"),F=document.getElementById("ambientNo"),N=document.getElementById("volumeNo"),B=document.querySelector(".settingsbtn"),X=document.getElementById("reset"),z=document.querySelector(".closebtn"),W=document.querySelector(".show-loc"),O=document.querySelector(".show-info"),U=document.querySelector(".show-music"),Y=document.querySelector("#info-location"),G=document.querySelector("#info-details"),V=document.querySelector("#music");W.addEventListener("click",(()=>{Y.style.display="block",document.querySelector("#info-location").scrollTop=0,G.style.display="none",V.style.display="none",O.classList.remove("showactive"),U.classList.remove("showactive"),W.classList.add("showactive")})),O.addEventListener("click",(()=>{G.style.display="block",document.querySelector("#info-details").scrollTop=0,Y.style.display="none",V.style.display="none",W.classList.remove("showactive"),U.classList.remove("showactive"),O.classList.add("showactive")})),U.addEventListener("click",(()=>{V.style.display="block",document.querySelector("#info-details").scrollTop=0,Y.style.display="none",G.style.display="none",W.classList.remove("showactive"),O.classList.remove("showactive"),U.classList.add("showactive")}));const Q=document.querySelector(".show-link"),J=document.querySelector(".show-embed"),Z=document.querySelector("#share-link"),K=document.querySelector("#share-embed");Q.addEventListener("click",(()=>{Z.style.display="block",K.style.display="none",Q.classList.add("showactive"),J.classList.remove("showactive")})),J.addEventListener("click",(()=>{K.style.display="block",Z.style.display="none",Q.classList.remove("showactive"),J.classList.add("showactive")}));const ee=460,te=680;let oe,ne,re,ae=!1;function ie(e,t=null){var o,n,r,a,i=e.target.closest(".edit-mc");i&&(i.getAttribute("data-id")?(n=i.getAttribute("data-id"),r="marker",o=document.querySelector('.marker-content[data-id="'+n+'"]')):(n=locationID,r="info",o=document.getElementById("info-location")));if("h1"===t||"h2"===t||"p"===t||"ul"===t){let t=e.target.value.trim();if(""===t){let e=i.parentNode;return 2===e.querySelectorAll(".edit-mc").length&&(e.querySelector(".edit-mc").style.display="block"),void i.remove()}document.querySelector("#logo").classList.add("saving");var s=function(e){var t=/{([^}]*)}/g;if(!t.test(e))return e;var o=e.match(t),n="<ul>";return o.forEach((function(e){var t=e.replace(/{|}/g,"").trim();n+="<li>"+t+"</li>"})),n+="</ul>"}(t);e.target.parentNode.innerHTML=s}else if("button"===t){let t;var l=e.target.closest(".edit-mc"),c=l.querySelector(".addbuttonlink"),d=l.querySelector(".addbuttontext");if(!c||!d)return void console.log("Input elements not found");var u,m=c.value.trim(),p=d.value.trim();if(m.startsWith("http"))t="external",u=`<a href="${m}" class="button externallink" target="_blank" data-external="true">${p}</a>`;else{if(isNaN(m)||!Number.isInteger(Number(m)))return void alert("You can only have a number or start your link with http.");t="internal",u=`<div class="button gotobutton" data-order_id="${parseInt(m)}">${p}</div>`}e.target.parentNode.insertAdjacentHTML("beforeend",u),"internal"===t&&l.querySelector(".gotobutton").addEventListener("click",(e=>{let t=e.target.getAttribute("data-order_id");listItems.forEach((e=>{e.classList.remove("active")}));document.querySelector(`#locationlist [data-id="${t.toString()}"]`).classList.add("active"),Ue(parseInt(t))})),e.target.parentNode.querySelectorAll("*").forEach((e=>{e.classList.contains("gotobutton")||e.classList.contains("externallink")||e.remove()}))}else if("youtube"===t){var v=e.target.value.trim();if(""===v){let e=i.parentNode;return 2===e.querySelectorAll(".edit-mc").length&&(e.querySelector(".edit-mc").style.display="block"),void i.remove()}document.querySelector("#logo").classList.add("saving");if(!/<iframe.*?src=".*?\/\/(?:www\.|)youtu(?:\.be\/|be\.com\/embed\/)([a-zA-Z0-9_-]+)(?:\?[^"]*)?".*?<\/iframe>/.test(v))return void alert("We did not recognize the embeded code as a youtube embed.");e.target.parentNode.innerHTML=v,document.querySelector("#logo").classList.add("saving")}else if("image"===t){var y=o.querySelector(".editimage").value.trim(),h=o.querySelector(".new-image img");if(""===y&&!h){console.log("Empty fields");let e=i.parentNode;return 2===e.querySelectorAll(".edit-mc").length&&(e.querySelector(".edit-mc").style.display="block"),void i.remove()}document.querySelector("#logo").classList.add("saving");let e=i.querySelector(".edit-image");if(h){if(subscriber>="1"){var f=h.getAttribute("data-filename");f=f.replace(/\.[^.]+$/,"");var g=h.src,b=dataURItoBlob(g);console.log("Image found");const t=new FileReader;t.readAsDataURL(b),t.onload=function(){console.log("XHR Save Image..."),e.innerHTML="";var o={user_id:userID,projectid:projectID,locationid:locationID,image:t.result,filename:f},n=JSON.stringify(o);console.log(o);xhrSend("POST","../php/saveimage.php",n).then((t=>{t.error&&console.error("Save image. XHR response ERROR:",t.error),t.success&&console.log("Save image. Success",t.success),console.log("XHR sent..."),console.log(t);let o=t.path.replace(/(\.[^.]+)$/,"-low640$1");const n=new Image;n.src=o,n.style.maxWidth="100%",e.appendChild(n),e.classList.add("image","zoom-image"),i.querySelector(".zoom-image").addEventListener("click",imageClickHandler),e.classList.remove("edit-image"),setTimeout((()=>{document.querySelector("#logo").classList.remove("saving")}),1e3)})).catch((e=>{console.error("Saving content. XHR request failed:",e)}))}}}else{const t=new Image;t.src=y,t.style.maxWidth="100%",e.innerHTML="",e.appendChild(t),e.classList.add("image","zoom-image"),i.querySelector(".zoom-image").addEventListener("click",imageClickHandler),e.classList.remove("edit-image")}}else document.querySelector("#logo").classList.add("saving");a=o.innerHTML;let L=parser.parseFromString(a,"text/html");L.querySelectorAll(".edit-markercontent").forEach((e=>{e.parentNode.removeChild(e)})),L.querySelector(".firstedit").remove(),L.querySelectorAll(".edit-mc").forEach((e=>{e.removeAttribute("data-id"),Array.from(e.querySelectorAll("input, textarea")).some((e=>e.matches("input, textarea")))&&e.remove()})),L.querySelectorAll("span").forEach((e=>{e.remove()}));var E={type:r,id:n,html:L.body.innerHTML},S=JSON.stringify(E);xhrSend("POST","../php/savecontent.php",S).then((e=>{e.error&&console.error("Save content. XHR response ERROR:",e.error),console.log("Content saved..."),setTimeout((()=>{document.querySelector("#logo").classList.remove("saving")}),1e3)})).catch((e=>{console.error("Saving content. XHR request failed:",e)}))}function se(e){ae=!0,oe=e.clientX||e.touches[0].clientX,ne=parseInt(document.defaultView.getComputedStyle(h).width,10),document.body.addEventListener("mousemove",le),document.body.addEventListener("touchmove",le),document.body.addEventListener("mouseup",ce),document.body.addEventListener("touchstart",ce),document.body.addEventListener("selectend",ce)}function le(e){if(!ae)return;const t=e.clientX||e.touches[0].clientX;let o=ne-(t-oe);o=Math.max(ee,Math.min(te,o)),h.style.width=o+"px"}function ce(){ae=!1,document.removeEventListener("mousemove",le),document.removeEventListener("touchmove",le),document.removeEventListener("mouseup",ce),document.removeEventListener("touchstart",ce),document.removeEventListener("selectend",ce)}function de(){if(0===parseFloat(c.style.bottom)){let e=c.getBoundingClientRect().height;c.style.bottom="-"+e+"px",u.classList.remove("rotate180")}else u.classList.add("rotate180"),c.style.bottom="0"}function ue(){c.style.opacity="1",d.style.opacity="1",B.style.opacity="1",r.style.opacity="1",i.style.opacity="1",s.style.opacity="1"}function me(){c.style.opacity="0",d.style.opacity="0",B.style.opacity="0",r.style.opacity="0",i.style.opacity="0",s.style.opacity="0"}function pe(){clearTimeout(re),"1"!==r.style.opacity&&ue(),re=setTimeout((()=>{me()}),7e3)}function ve(){$.style.right="0px",B.style.opacity="0"}g.addEventListener("mousedown",se),g.addEventListener("touchstart",se),g.addEventListener("selectstart",se),u.addEventListener("click",de),u.addEventListener("touchstart",de),u.addEventListener("selectend",de),ue(),document.addEventListener("keydown",(e=>{if("h"===e.key||"H"===e.key){const e=document.querySelector("#view-container"),t=document.querySelector("#outside"),o=document.querySelectorAll("input, textarea");let n=!1;if(o.forEach((e=>{e.contains(document.activeElement)&&(n=!0)})),n)return;"none"===e.style.display?(e.style.display="block",t.style.display="block"):(e.style.display="none",t.style.display="none")}})),re=setTimeout((()=>{me()}),7e3),document.addEventListener("mousemove",(function(e){pe()})),document.addEventListener("touchmove",(function(e){pe()})),B.addEventListener("click",ve),B.addEventListener("touchstart",ve),B.addEventListener("selectstart",ve);const ye=document.querySelector("#locationlist");e.locations.forEach((e=>{ye.insertAdjacentHTML("afterbegin","<li></li>")})),"project"===dataType&&e.project&&!0===e.project.showlocations||document.querySelector("#indicatorbtn").remove();let he=75;const fe=new THREE.Scene,ge=new THREE.PerspectiveCamera(he,window.innerWidth/window.innerHeight,.1,1e3),be=new THREE.WebGLRenderer({alpha:!1});be.setSize(window.innerWidth,window.innerHeight),be.setClearColor(0),o.appendChild(be.domElement);const Le=new CSS2DRenderer;Le.setSize(window.innerWidth,window.innerHeight),Le.domElement.style.position="absolute",Le.domElement.style.top="0px",Le.domElement.style.pointerEvents="none",o.appendChild(Le.domElement);const Ee=new OrbitControls(ge,be.domElement);Ee.enablePan=!1,Ee.enableDamping=!0,Ee.dampingFactor=.05,Ee.rotateSpeed=-1,Ee.autoRotate=!1,Ee.autoRotateSpeed*=.25,ge.position.set(0,0,0),ge.rotation.order="YXZ";Ve(new THREE.Vector3(0,0,0),(new THREE.Quaternion).setFromEuler(new THREE.Euler(0,150,0))),Ee.minDistance=30,Ee.maxDistance=280,Ee.zoomSpeed=3;const Se=document.createElement("video");let we,qe,ke;const xe=new THREE.SphereGeometry(360,180,180),Te=new THREE.DataTexture(new Uint8Array([0,0,0]),1,1,THREE.RGBFormat);Te.needsUpdate=!0;const Ie=new THREE.MeshStandardMaterial({map:Te,side:THREE.DoubleSide}),He=new THREE.Mesh(xe,Ie);fe.add(He),fe.add(root);let $e,Ae=4;function Re(e){Ae=e,$e&&fe.remove($e),$e=new THREE.AmbientLight(16777215,e),fe.add($e)}function Ce(){be.render(fe,ge),Le.render(fe,ge)}function Me(){requestAnimationFrame(Me),Ee.update(),document.querySelectorAll(".marker").forEach((e=>{let t=e.style.transform;if(t.includes("translate")&&t.includes("px")){let o=t.match(/translate\(([^,]+)px, ([^,]+)px\)/);if(o){let t=Math.round(parseFloat(o[1])),n=Math.round(parseFloat(o[2]));e.style.transform=`translate(${t}px, ${n}px)`}}})),Ce();const e=-Math.atan2(ge.position.x,ge.position.z);d.style.transform=`translate(-50%, -50%) rotate(${e}rad)`}function je(e,t){const o=t.getViewerPose();if(o){const e=o.views;for(let t of e){const e=xrLayer.getViewport(t),o=t.projectionMatrix;be.setViewport(e.x,e.y,e.width,e.height),be.setProjectionMatrix(o),be.render(fe,ge)}}t.session.requestAnimationFrame(je)}Re(3.5),"xr"in navigator?(console.log("WebXR is supported in this browser."),"requestDevice"in navigator.xr?navigator.xr.requestDevice().then((e=>{console.log("XR device obtained:",e),e.requestSession({immersive:!0}).then((e=>{console.log("XR session started:",e);const t=be.getContext(),o=new XRWebGLLayer(e,t);e.updateRenderState({baseLayer:o}),e.requestAnimationFrame(je)})).catch((e=>{console.error("Failed to start XR session:",e),Me()}))})).catch((e=>{console.error("Failed to obtain XR device:",e),Me()})):"requestSession"in navigator.xr?navigator.xr.requestSession("immersive-vr").then((e=>{console.log("XR session started:",e);const t=be.getContext(),o=new XRWebGLLayer(e,t);e.updateRenderState({baseLayer:o}),e.requestAnimationFrame(je)})).catch((e=>{console.error("Failed to start XR session:",e),Me()})):(console.error("WebXR APIs are present, but neither requestDevice nor requestSession methods are available."),Me())):(console.log("WebXR not supported in this browser."),Me());let _e="";console.log("Render locations list for project...");for(let ht=0;ht<e.locations.length;ht++){const ft=e.locations[ht];let gt=0===ht&&"video"===ft.file_type?"active":"",bt=ft.file_name.replace(/\.\w+$/,".jpg");if("video"===ft.file_type){sceneType="video";const Lt=bt.split(".").slice(0,-1).join(".");_e+=`<li class="${gt}" data-file="${ft.file_name}" data-id="${ft.id}" data-order_index="${ft.order_index}" data-type="${ft.file_type}">\n                            <span class="icon-video">${ft.duration}</span>\n                            <div>${ft.location_title}</div>\n                            <img src="${t}video/${Lt}-low.jpg" alt="" />\n                        </li>`}else{sceneType="image";const Et=ft.file_name.split(".").slice(0,-1).join(".");_e+=`<li class="${gt}" data-file="${ft.file_name}" data-id="${ft.id}" data-order_index="${ft.order_index}" data-type="${ft.file_type}">\n                            <div>${ft.location_title}</div>\n                            <img src="${t}img/${Et}-low.jpg" alt="" />\n                        </li>`}}function De(e){listItems.forEach((e=>{e.classList.remove("active")})),e.classList.add("active");const t=e.getAttribute("data-order_index");Ue(parseInt(t))}document.querySelector("#locationlist").innerHTML=_e,(listItems=document.querySelectorAll("#locationlist li")).forEach((e=>{e.addEventListener("click",(function(){De(e)})),e.addEventListener("touchstart",(function(){De(e)})),e.addEventListener("selectend",(function(){De(e)}))})),function t(){const o=document.querySelector("#locations .container ul li:first-child");if(o)if(locId>e.locations.length){const t=e.locations[0].order_index;Ue(parseInt(t)),o.classList.add("active")}else{document.querySelector(`#locations .container ul li[data-order_index='${locId}']`).classList.add("active"),Ue(parseInt(locId))}else setTimeout(t,1e3)}();document.querySelectorAll(".startlocations").forEach((o=>{var n="";e.locations.map((e=>{const o=e.file_name.replace(/\.\w+$/,".jpg").split(".").slice(0,-1).join("."),r="video"===e.file_type?"video":"img";n+=`<div class="start-location" data-id="${e.id}" data-order_index="${e.order_index}">\n\t\t\t\t\t<h5 class="title">${e.location_title}</h5>\n\t\t\t\t\t<div class="locimage">\n\t\t\t\t\t\t<img src="${t}${r}/${o}-low.jpg" alt="" />\n\t\t\t\t\t</div>\n\t\t\t\t</div>`})),o.innerHTML=n}));const Pe=document.querySelector("#linktoshare"),Fe=document.querySelector("#embedcode"),Ne=document.querySelectorAll(".start-location");e.locations.length<locId&&(selectStartLocation=1),Ne.forEach((e=>{e.addEventListener("click",(()=>{Ne.forEach((e=>{e.classList.remove("active")}));const t=e.getAttribute("data-order_index");Array.from(Ne).filter((function(e){return e.getAttribute("data-order_index")===t})).forEach((e=>{e.classList.add("active")})),selectStartLocation=t,updateShareLink(),Pe.querySelector("span").textContent=shareLink,Fe.querySelector("textarea").textContent=embedIframeLink}))})),document.querySelectorAll('.start-location[data-order_index="'+selectStartLocation+'"]').forEach((e=>{e.classList.add("active")})),updateShareLink(),Pe.querySelector("span").textContent=shareLink,Fe.querySelector("textarea").textContent=embedIframeLink;const Be=document.querySelector("#copylink"),Xe=document.querySelector("#copyembed");function ze(){const e=THREE.MathUtils.degToRad(currentLocX),t=THREE.MathUtils.degToRad(currentLocY);ge.position.set(e,t,ge.position.z),ge.rotation.set(e,t,ge.position.z),ge.lookAt(fe.position),ge.updateProjectionMatrix()}function We(e){e.preventDefault();const t=e.target.getAttribute("data-order_index");Ue(parseInt(t))}function Oe(e){if(!e.target.closest(".marker-container")){e.preventDefault();let t=e.target,o=t.querySelector(".hint"),n=t.querySelector(".marker-container");if("none"===getComputedStyle(n).display){if(t.classList.add("markeron"),n.style.display="block",n){n.querySelector(".marker-content").scrollTop=0;let e=n.querySelector(".soundplay");if(e){if("true"===e.getAttribute("data-autoplay")){let t=e.querySelector("audio");t&&(t.paused||(t.pause(),t.currentTime=0),t.play())}}}o.style.display="none"}else t.classList.remove("markeron"),n.style.display="none",o.style.display="block"}}function Ue(n){lt(),at(),st(),E.style.display="none",S.style.display="none";let r=document.querySelectorAll(".intlink"),a=document.querySelectorAll(".infodot");r.forEach((e=>{e.removeEventListener("click",We)})),a.forEach((e=>{e.removeEventListener("click",Oe)}));let i,s=document.querySelectorAll(".zoom-image");s.forEach((e=>{e.removeEventListener("click",imageClickHandler)})),H.innerHTML="",h.classList.remove("infoshow"),i="project"===dataType&&e.project?e.locations.find((e=>e.order_index===n)):e.locations[0],locationID=i.id;let l=i.embed_id;document.querySelector("#commentbtn").setAttribute("data-embedid",l);let c=i.file_name,d=i.file_type,u=i.info;markerData=i.markers,root.clear();const m=document.querySelector(".show-loc"),p=document.querySelector(".show-info");if(""!==markerData&&null!=markerData&&(console.log("Creating markers..."),async function(e){return new Promise((t=>{if(0===e.length)return void t();let o=0;const n=()=>{let n=document.querySelectorAll(".intlink"),a=document.querySelectorAll(".infodot");(n.length>0||a.length>0)&&(clearInterval(r),n.length>0&&n.forEach((e=>{"project"===dataType?e.addEventListener("click",We):(console.log("Not showing internal links..."),e.remove())})),a.length>0&&a.forEach((e=>{e.addEventListener("click",Oe)})),o===e.length&&t())};n();const r=setInterval(n,50);e.forEach(((e,t)=>{const{id:n,marker_title:r,pos_x:a,pos_y:i,pos_z:s,info:l,link:c,sound:d,autoplay:u,customcss:m}=e,p=new THREE.Vector3(a,i,s);let v=`<span class="hint">${r}</span>`;if("string"!=typeof c||""===c||isNaN(c))if("string"==typeof c&&""!==c)(marker=document.createElement("a")).href=c,marker.target="_blank",marker.classList.add("extlink"),marker.innerHTML=v;else{(marker=document.createElement("div")).classList.add("infodot");let e=v+`<div class="marker-container" data-id="${n}"><div class="marker-content" data-id="${n}"></div>`;marker.innerHTML=e;let o=marker.querySelector(".marker-content");o.insertAdjacentHTML("afterbegin",l);let r=marker.querySelector(".marker-container");if(editmode){let e=o.querySelectorAll(".edit-mc"),t='<div class="edit-mc firstedit"';e.length>0&&(t+=' style="display:none"'),t+="></div>",o.insertAdjacentHTML("afterbegin",t),e=o.querySelectorAll(".edit-mc"),e.forEach((e=>{e.setAttribute("data-id",n);let t='<div class="edit-markercontent">\n\t\t\t\t\t\t\t<div class="btn-add-h1">H1</div>\n\t\t\t\t\t\t\t<div class="btn-add-h2">H2</div>\n\t\t\t\t\t\t\t<div class="btn-add-p"></div>\n\t\t\t\t\t\t\t<div class="btn-add-image"></div>\n\t\t\t\t\t\t\t<div class="btn-add-ul"></div>\n\t\t\t\t\t\t\t<div class="btn-add-button"></div>\n\t\t\t\t\t\t\t<div class="btn-add-youtube"></div>\n\t\t\t\t\t\t\t<div class="btn-add-sound"></div>\n\t\t\t\t\t\t\t<div class="btn-content-edit"></div>\n\t\t\t\t\t\t\t<div class="btn-remove"></div>\n\t\t\t\t\t\t</div>';e.insertAdjacentHTML("afterbegin",t)}))}let a="";null!==d&&""!==d&&(a+='<div class="soundplay"',a+=u?` data-autoplay="${u}">`:">",editmode&&(a+=`<div class="btn-content-edit" data-id=${n}></div>\n\t\t\t\t\t\t\t<div class="btn-remove" data-id=${n}></div>`),a+=`<audio controls id="audio${t}">\n\t\t\t\t\t\t\t\t\t<source src="../sound/${d}" type="audio/mpeg">\n\t\t\t\t\t\t\t\t</audio>\n\t\t\t\t\t\t\t</div>`,r.insertAdjacentHTML("afterbegin",a))}else(marker=document.createElement("div")).dataset.id=parseInt(n),marker.dataset.order_index=parseInt(c),marker.classList.add("intlink"),marker.innerHTML=v;marker.classList.add("marker");let y=t;if(marker.id="marker"+y,""!==m&&null!==m){var h=JSON.parse(m),f="";h.forEach(((e,t)=>{f+="#marker"+y+e,t!==h.length-1&&(f+=" ")}));var g=document.querySelector("style[data-customcss]");if(g)g.textContent+=f;else{var b=document.createElement("style");b.textContent=f,b.setAttribute("data-customcss",""),document.head.appendChild(b)}}if(editmode){let e=`<div class="edit-marker" data-id="${n}">\n\t\t\t\t\t\t<div class="btn-marker-edit" data-id="${n}"></div>\n\t\t\t\t\t\t<div class="btn-marker-move" data-id="${n}"></div>\n\t\t\t\t\t\t<div class="btn-marker-delete" data-id="${n}"></div>\n\t\t\t\t\t</div>`;marker.insertAdjacentHTML("beforeend",e)}const L=new CSS2DObject(marker);L.position.copy(p),root.add(L),o++})),ge.position.set(360,0,0),ge.rotation.set(360,0,0),ge.lookAt(fe.position),ge.updateProjectionMatrix(),ge.position.x=-360,ge.rotation.x=-360,ge.lookAt(fe.position),ge.updateProjectionMatrix(),Ce(),console.log("Markers added to root.")}))}(markerData).then((()=>{setTimeout((()=>{s=document.querySelectorAll(".zoom-image"),s.forEach((e=>{e.addEventListener("click",imageClickHandler)})),console.log("Added eventlistener to images..."),console.log("Markers created.")}),100)}))),"video"===d){if(we===c)return;sceneType="video";let P=c;qe="",He.material.map=null,Se.pause(),Se.src="",we="";const F=c.split(".").slice(0,-1).join(".");if(highSpeed||(P=F+"-low.mp4",function(e,o){const n=document.createElement("video");n.src=t+"video/"+o,n.addEventListener("canplay",(function(){const t=setInterval((function(){if(4===n.readyState){clearInterval(t),e.pause();let o=e.currentTime;e.src="",e.src=n.src,e.currentTime=o,e.play(),console.log("High-quality video loaded and switched.")}}),100)}))}(Se,c)),Se.src=t+"video/"+P,Se.load(),Se.crossOrigin="anonymous",Se.loop=!0,Se.playsInline=!0,we=c,""!==i.captions){x.style.display="block";const B=document.querySelector("#captionselect ul");let X="";i.captions.forEach((e=>{X+=`<li data-caption="${e.caption_language}" data-id="${i.id}">${e.caption_language}</li>`})),X+='<li id="captionoff" class="active">Captions off</li>',B.innerHTML=X;const z=document.querySelectorAll("#captionselect ul li");function v(o){const n=o.target.getAttribute("data-id");e.locations.find((e=>e.id===parseInt(n)));const r=o.target.getAttribute("data-caption"),a=c.split(".").slice(0,-1).join("."),i=`${t}video/${a}-${r}.srt`;console.log(i),k.style.display="block",z.forEach((e=>{e.classList.remove("active")})),o.target.classList.add("active"),x.classList.add("on"),fetch(i).then((e=>e.blob())).then((e=>{!function(e){const t=new FileReader;t.onload=function(e){const t=function(e){const t=e.trim().split(/\r?\n/),o=[];let n={};for(let e=0;e<t.length;e++){const r=t[e].trim();if(r)if(n.id)if(n.start)n.text?(o.push(n),n={}):n.text=r;else{const e=r.split(" --\x3e ");if(2!==e.length){n={};continue}n.start=yt(e[0]),n.end=yt(e[1])}else n.id=parseInt(r)}return console.log(o),o}(e.target.result);console.log(t),function(e){Se.addEventListener("timeupdate",(function(){const t=Se.currentTime,o=document.getElementById("caption");for(const n of e)if(t>=n.start&&t<=n.end)return void(o.innerHTML=`<p>${n.text}</p>`);o.innerHTML=""}))}(t)},t.readAsText(e)}(e)})).catch((e=>{console.error("Error fetching or converting SRT file:",e)}))}z.forEach((e=>{e.addEventListener("click",v),e.addEventListener("touchstart",v),e.addEventListener("selectstart",v)}));const U=document.querySelector("#captionoff");function y(){z.forEach((e=>{e.classList.remove("active")})),U.classList.add("active"),x.classList.remove("on"),k.style.display="none"}U.addEventListener("click",y),U.addEventListener("touchstart",y),U.addEventListener("selectstart",y)}else x.style.display="none";function f(){"none"===T.style.display?T.style.display="block":T.style.display="none"}function g(){w.classList.contains("playing")?(w.classList.remove("playing"),Se.pause()):(w.classList.add("playing"),Se.play())}w.classList.add("playing"),x.addEventListener("click",f),x.addEventListener("touchstart",f),x.addEventListener("selectstart",f),w.addEventListener("click",g),w.addEventListener("touchstart",g),w.addEventListener("selectstart",g);const N=document.querySelector("#currenttime");function b(){const e=parseFloat(q.value);Se.currentTime=e*Se.duration;const t=I(Se.currentTime);N.textContent=t}function L(){Se.removeEventListener("timeupdate",(()=>{})),b()}function I(e){const t=Math.floor(e/3600),o=Math.floor(e%3600/60),n=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}Se.addEventListener("timeupdate",(()=>{const e=Se.currentTime/Se.duration;q.value=e.toFixed(2);const t=I(Se.currentTime);N.textContent=t})),q.addEventListener("input",b),q.addEventListener("mousedown",L),q.addEventListener("touchstart",L),q.addEventListener("selectstart",L),userInteracted?(S.style.display="flex",Se.play()):E.style.display="block",ke=new THREE.VideoTexture(Se),ke.encoding=THREE.LinearEncoding,ke.needsUpdate=!0,ke.wrapS=THREE.RepeatWrapping,ke.repeat.x=-1,ke.mapping=THREE.UVMapping,ke.encoding=THREE.sRGBEncoding,ke.gammaFactor=2.2,He.material.map=ke,He.material.needsUpdate=!0}else if("image"===d){if(qe===c)return;sceneType="image",S.style.display="none",He.material.map=null,Se.pause(),Se.src="",we="";const V=c.split(".").slice(0,-1).join(".");let Q=t+"img/"+c;highSpeed||(Q=t+"img/"+V+"-low.jpg");const J=(new THREE.TextureLoader).load(`${Q}`,(function(e){e.wrapS=THREE.RepeatWrapping,e.repeat.x=-1,e.mapping=THREE.UVMapping,e.encoding=THREE.sRGBEncoding,e.gammaFactor=2.2}));if(He.material.map=J,He.material.needsUpdate=!0,!highSpeed){!function(e,t){const o=new Image;o.src=e,o.onload=function(){const e=new THREE.Texture(o);e.needsUpdate=!0,e.wrapS=THREE.RepeatWrapping,e.repeat.x=-1,e.mapping=THREE.UVMapping,e.encoding=THREE.sRGBEncoding,e.gammaFactor=2.2,t(e)}}(t+"img/"+c,(function(e){He.material.map=e,He.material.needsUpdate=!0}))}qe=c,console.log("Image type done...")}else console.log("Invalid file type");let $=document.querySelector("#likebtn");const A=$.cloneNode(!0);if($.parentNode.replaceChild(A,$),A.querySelector(".amount").textContent=formatNumber(i.likes_count),A.setAttribute("data-id",i.id),A.classList.remove("liked"),i.has_liked&&A.classList.add("liked"),""!==u&&null!=u||editmode?(Y.style.display="block",Y.innerHTML=u,m.style.display="block",m.classList.add("showactive"),p.classList.remove("showactive")):(Y.style.display="none",m.style.display="none",p.classList.add("showactive"),G.style.display="block",document.querySelector("#info-details").scrollTop=0,W.classList.remove("showactive"),O.classList.add("showactive")),editmode){let Z=Y.querySelectorAll(".edit-mc"),K='<div class="edit-mc firstedit"';function R(e){let t=e.target.closest(".edit-mc"),o=t.parentNode;if(2===o.querySelectorAll(".edit-mc").length){o.querySelector(".firstedit").style.display="block"}t.remove(),ie(e)}function C(e,t,n){e.stopPropagation();const r=`<div id="browse-files">\n\t\t\t\t\t<h2>Select ${t}</h2>\n\t\t\t\t\t<div id="close-browse"></div>\n\t\t\t\t\t<div class="browse-filter">\n\t\t\t\t\t\t<div class="browse-showall active">Show all</div>\n\t\t\t\t\t\t<div class="browse-showproject">Project</div>\n\t\t\t\t\t\t<div class="browse-showlocation">Location</div>\n\t\t\t\t\t\t<div class="browse-grid active"></div>\n\t\t\t\t\t\t<div class="browse-list"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div id="browse-container"></div>\n\t\t\t\t</div>`;o.insertAdjacentHTML("beforeend",r);let a=`id=${userID}&type=${t}`;document.querySelector("#close-browse").addEventListener("click",(()=>{document.querySelector("#browse-files").remove()})),xhrSend("POST","../php/getfiles.php",a).then((e=>{if(e){console.log(e);const o=document.querySelector("#browse-container");let r="";"image"===t?e.forEach((e=>{let t=e.fullpath.replace(/(\.[^.]+)$/,"-low640$1");r+=`<div class="browse-item" data-browseproject="${e.project_id}" data-browselocation="${e.location_id}">\n\t\t\t\t\t\t\t\t\t\t<div class="remove-fileitem"></div>\n\t\t\t\t\t\t\t\t\t\t<div class="image zoom-image">\n\t\t\t\t\t\t\t\t\t\t\t<img src="${t}" alt="" data-id="${e.images_id}"  />\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div class="browse-filename">${e.file_name}</div>\n\t\t\t\t\t\t\t\t\t\t<div class="browse-uploaded">${e.uploaded}</div>\n\t\t\t\t\t\t\t\t\t</div>`})):"video"===t?e.forEach((e=>{r+=`<div class="browse-item"><span class="duration">${e.duration}</span><img src="${e.thumbnail}" alt="" data-source="${e.source}" /></div>`})):"sound"===t&&e.forEach((e=>{r+=`<div class="browse-item"><span class="duration">${e.duration}</span><img src="${e.thumbnail}" alt="" data-source="${e.source}" /></div>`})),o.insertAdjacentHTML("afterBegin",r);const a=document.querySelector("#browse-files"),i=document.querySelectorAll(".browse-item"),s=document.querySelector(".browse-showall"),l=document.querySelector(".browse-showproject"),c=document.querySelector(".browse-showlocation"),d=document.querySelector(".browse-grid"),u=document.querySelector(".browse-list");d.addEventListener("click",(()=>{d.classList.add("active"),u.classList.remove("active"),a.classList.remove("browselist")})),u.addEventListener("click",(()=>{d.classList.remove("active"),u.classList.add("active"),a.classList.add("browselist")})),s.addEventListener("click",(()=>{s.classList.add("active"),c.classList.remove("active"),l.classList.remove("active"),i.forEach((e=>{e.style.display="flex"}))})),l.addEventListener("click",(()=>{l.classList.add("active"),s.classList.remove("active"),c.classList.remove("active"),i.forEach((e=>{e.style.display="flex",parseInt(e.getAttribute("data-browseproject"))!==projectID&&(e.style.display="none")}))})),c.addEventListener("click",(()=>{c.classList.add("active"),s.classList.remove("active"),l.classList.remove("active"),i.forEach((e=>{e.style.display="flex",parseInt(e.getAttribute("data-browselocation"))!==locationID&&(e.style.display="none")}))}));const m=document.querySelectorAll(".remove-fileitem");"image"===t?(i.forEach((e=>{e.addEventListener("click",(e=>{e.stopPropagation();let t=e.target.closest(".browse-item").querySelector("img").getAttribute("src");n.querySelector(".editimage").value=t,document.querySelector("#browse-files").remove()}))})),m.forEach((e=>{e.addEventListener("click",(e=>{if(e.stopPropagation(),window.confirm("This will remove the file completly, are you sure?")){let t=e.target.closest(".browse-item"),o=t.querySelector("img"),n=o.getAttribute("data-id"),r=o.getAttribute("src");const a="../php/removeitem.php",i={id:n,type:"image",userid:userID},s=JSON.stringify(i);console.log(s),xhrSend("POST",a,s,"json").then((e=>{if(e.success){t.remove();document.querySelectorAll(".edit-mc").forEach((e=>{e.querySelector(`img[src="${r}"]`)&&e.remove()}))}else e.error&&alert("There was an error removing the item.",error)})).catch((e=>{console.error("Remove item image. XHR request failed:",e)}))}}))}))):"video"===t||"sound"===t&&(i.forEach((e=>{e.addEventListener("click",(e=>{e.stopPropagation();let t=e.target.closest(".browse-item").querySelector("audio").getAttribute("src");n.querySelector(".editsound").value=t,document.querySelector("#browse-files").remove()}))})),m.forEach((e=>{e.addEventListener("click",(e=>{if(e.stopPropagation(),window.confirm("This will remove the file completly, are you sure?")){let t=e.target.closest(".browse-item");const o="../php/removeitem.php",n={id:t.querySelector("audio").getAttribute("data-id"),type:"sound",userid:userID},r=JSON.stringify(n);console.log(r),xhrSend("POST",o,r,"json").then((e=>{e.success?t.remove():e.error&&alert("There was an error removing the item.",error)})).catch((e=>{console.error("Remove item image. XHR request failed:",e)}))}}))})))}else console.log("fail")})).catch((e=>{console.error("Get files (images). XHR request failed:",e)}))}function M(e,t){let o,n,r,a=e.target.closest(".edit-mc"),i=a.closest(".marker-content").closest(".marker-container"),s=a.getAttribute("data-id");if(null==s?(s=a.getAttribute("data-location_id"),n=`data-location_id="${s}"`,r=!0):(n=`data-id="${s}"`,r=!1),"h1"===t)o=`<div class="edit-mc" data-element="h1" ${n}><h1><textarea class="editheader" type="text" placeholder="Header 1"></textarea></h1></div>`;else if("h2"===t)o=`<div class="edit-mc" data-element="h2" ${n}><h2><textarea class="editheader2" type="text" placeholder="Header 2"></textarea></h2></div>`;else if("p"===t)o=`<div class="edit-mc" data-element="p" ${n}><p><textarea class="editp" type="text" placeholder="Write text here..."></textarea></p></div>`;else if("image"===t)o=`<div class="edit-mc" data-element="image" ${n}>\n\t\t\t\t\t<div class="edit-image">\n\t\t\t\t\t\t<div class="editimage-link">`,subscriber>="1"&&(o+='<div class="btn-browse-images">Browse</div>'),o+='<input type="text" class="editimage" placeholder="https://pathtoimage.com/image.jpg" />\n\t\t\t\t\t\t</div>',subscriber>="1"&&(o+='<div class="dropzone" id="dropzone">\n\t\t\t\t\t\t\t<div class="button-wrap">\n\t\t\t\t\t\t\t\t<label class="button" for="imageInput">Drop File/Browse Computer</label>\n\t\t\t\t\t\t\t\t<input type="file" id="imageInput" class="imageInput" accept="image/*">\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>'),o+='<div class="button addimagesave">Save</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>';else if("ul"===t)o=`<div class="edit-mc" data-element="ul" ${n}><p><span>"Enclose each list item within curly braces. For example: {This is line one}"</span><textarea class="editul" type="text" placeholder="Example: {This is line one}"></textarea></p></div>`;else if("button"===t)o=`<div class="edit-mc" data-element="button" ${n}><div><span>Enter an external link beginning with 'http' or type the location's order number to navigate within your project.</span><input class="editbutton addbuttonlink" type="text" placeholder="https://example.com/externallink" /><input class="editbutton addbuttontext" type="text" placeholder="Button text" /><div class="button addbuttonsave">Save</div></div></div>`;else if("youtube"===t)o=`<div class="edit-mc" data-element="youtube" ${n}><div><span>Paste your youtube embed code into the textarea.</span><textarea class="edityoutube" type="text" placeholder="Paste your Youtube embed code here..."></textarea></div></div>`;else if("sound"===t){if(i.querySelector(".soundplay"))return void alert("You can only have 1 sound per marker.");o='<div class="edit-mc">\n\t\t\t\t\t\t\t<div class="editsound-link">',subscriber>="1"&&(o+='<div class="btn-browse-sounds">Browse</div>'),o+='<input type="text" class="editsound" placeholder="https://pathtosound.com/sound.mp3" />\n\t\t\t\t\t\t\t</div>',subscriber>="1"&&(o+='<div class="dropzone" id="dropzone">\n\t\t\t\t\t\t\t\t<div class="button-wrap">\n\t\t\t\t\t\t\t\t\t<label class="button" for="soundInput">Drop File/Browse Computer</label>\n\t\t\t\t\t\t\t\t\t<input type="file" id="soundInput" class="soundInput" accept="audio/mpeg, audio/mp3">\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>'),o+='<div class="button addsoundsave">Save</div>\n\t\t\t\t\t\t</div>'}a.insertAdjacentHTML("afterend",o);let l='<div class="edit-markercontent">\n\t\t\t\t\t\t\t<div class="btn-add-h1">H1</div>\n\t\t\t\t\t\t\t<div class="btn-add-h2">H2</div>\n\t\t\t\t\t\t\t<div class="btn-add-p"></div>\n\t\t\t\t\t\t\t<div class="btn-add-image"></div>\n\t\t\t\t\t\t\t<div class="btn-add-ul"></div>\n\t\t\t\t\t\t\t<div class="btn-add-button"></div>\n\t\t\t\t\t\t\t<div class="btn-add-youtube"></div>';r||(l+='<div class="btn-add-sound"></div>'),l+='<div class="btn-content-edit"></div>\n\t\t\t\t\t\t\t<div class="btn-remove"></div>\n\t\t\t\t\t\t</div>';let c=a.nextElementSibling;c.insertAdjacentHTML("afterbegin",l),function(e,t){let o=e.target.closest(".edit-mc").nextElementSibling;if("h1"===t||"h2"===t||"p"===t||"ul"===t||"youtube"===t)o.querySelector("textarea").addEventListener("blur",(e=>{ie(e,t)}));else if("button"===t)o.querySelector(".addbuttonsave").addEventListener("click",(e=>{let o=e.target.closest(".edit-mc"),n=o.querySelector(".addbuttonlink"),r=o.querySelector(".addbuttontext"),a=n.value;""!==r.value&&""!==a?a.startsWith("http")||!isNaN(parseInt(a))?ie(e,t):alert("You can only write a http link or a number."):alert("Please provide both button text and a valid link. Use 'http' for external links or a location order number for internal navigation.")}));else if("image"===t){const r=o.querySelector(".imageInput");if(subscriber>="1"){const a=o.querySelector(".dropzone");function n(e){for(const t of e){if(!t.type.startsWith("image/"))return void alert("Please drop only image files.");{const e=new FileReader;e.readAsDataURL(t),e.onload=function(){const o=document.createElement("div");o.classList.add("new-image"),a.querySelector(".button-wrap").style.display="none";const n=new Image;n.src=e.result,n.style.maxWidth="100%",n.setAttribute("data-filename",t.name),console.log(t.name);const i=document.createElement("button");i.addEventListener("click",(function(){o.remove(),r.value="",a.querySelector(".button-wrap").style.display="block"})),o.appendChild(n),o.appendChild(i),a.appendChild(o)}}}}a.addEventListener("dragover",(e=>{e.preventDefault(),a.classList.add("dragover")})),a.addEventListener("dragleave",(()=>{a.classList.remove("dragover")})),a.addEventListener("drop",(e=>{e.preventDefault(),a.classList.remove("dragover");const t=e.dataTransfer.files;n(t)})),r.addEventListener("change",(e=>{const t=e.target.files;n(t)}))}o.querySelector(".addimagesave").addEventListener("click",(e=>{e.stopPropagation();let o=e.target.closest(".edit-mc"),n=o.querySelector(".editimage").value.trim();if(subscriber>="1"){let e=o.querySelector(".imageInput").files[0];if(""!==n&&e)return void alert("You can only save one image, either a link or upload image.")}else if(""===n)return void alert("You must enter a link to an image, to be able to save.");ie(e,t)})),o.querySelector(".btn-browse-images").addEventListener("click",(e=>{e.stopPropagation();let t=e.target.closest(".edit-mc");C(e,"image",t)}))}else if("sound"===t){const i=o.querySelector(".soundInput");if(subscriber>="1"){const s=o.querySelector(".dropzone");function n(e){for(const t of e){if("audio/mpeg"!==t.type)return void alert("Please drop only mp3 files.");{const e=new FileReader;e.readAsDataURL(t),e.onload=function(){const o=document.createElement("div");o.classList.add("new-sound"),s.querySelector(".button-wrap").style.display="none";const n=new Audio;n.src=e.result,n.controls=!0,n.setAttribute("data-filename",t.name),console.log(t.name);const r=document.createElement("button");r.addEventListener("click",(function(){o.remove(),i.value="",s.querySelector(".button-wrap").style.display="block"})),o.appendChild(n),o.appendChild(r),s.appendChild(o)}}}}s.addEventListener("dragover",(e=>{e.preventDefault(),s.classList.add("dragover")})),s.addEventListener("dragleave",(()=>{s.classList.remove("dragover")})),s.addEventListener("drop",(e=>{e.preventDefault(),s.classList.remove("dragover");const t=e.dataTransfer.files;n(t)})),i.addEventListener("change",(e=>{const t=e.target.files;n(t)}))}o.querySelector(".addsoundsave").addEventListener("click",(e=>{e.stopPropagation();let o=e.target.closest(".edit-mc"),n=o.querySelector(".editsound").value.trim();if(subscriber>="1"){let e=o.querySelector(".soundInput").files[0];if(""!==n&&e)return void alert("You can only save one sound, either a link or upload sound.")}""!==inputImageLink?ie(e,t):alert("You must enter a link to an image, to be able to save.")})),o.querySelector(".btn-browse-sounds").addEventListener("click",(e=>{e.stopPropagation();let t=e.target.closest(".edit-mc");C(e,"sound",t)}))}"h1"===t||"h2"===t||"p"===t||"ul"===t||"youtube"===t?o.querySelector("textarea").focus():"button"===t?o.querySelector("input").focus():"image"===t?o.querySelector(".editimage").focus():"sound"===t&&o.querySelector(".editsound").focus()}(event,t),c.querySelector(".btn-add-h1").addEventListener("click",(e=>M(e,"h1"))),c.querySelector(".btn-add-h2").addEventListener("click",(e=>M(e,"h2"))),c.querySelector(".btn-add-p").addEventListener("click",(e=>M(e,"p"))),c.querySelector(".btn-add-image").addEventListener("click",(e=>M(e,"image"))),c.querySelector(".btn-add-ul").addEventListener("click",(e=>M(e,"ul"))),c.querySelector(".btn-add-button").addEventListener("click",(e=>M(e,"button"))),c.querySelector(".btn-add-youtube").addEventListener("click",(e=>M(e,"youtube"))),c.querySelector(".btn-add-sound").addEventListener("click",(e=>M(e,"sound"))),c.querySelector(".btn-remove").addEventListener("click",(e=>R(e))),a.classList.value.includes("firstedit")&&(a.style.display="none")}Z.length>0&&(K+=' style="display:none"'),K+="></div>",Y.insertAdjacentHTML("afterbegin",K),Z=Y.querySelectorAll(".edit-mc"),Z.forEach((function(e){e.setAttribute("data-location_id",i.id);e.insertAdjacentHTML("afterbegin",'<div class="edit-markercontent">\n\t\t\t\t\t\t\t<div class="btn-add-h1">H1</div>\n\t\t\t\t\t\t\t<div class="btn-add-h2">H2</div>\n\t\t\t\t\t\t\t<div class="btn-add-p"></div>\n\t\t\t\t\t\t\t<div class="btn-add-image"></div>\n\t\t\t\t\t\t\t<div class="btn-add-ul"></div>\n\t\t\t\t\t\t\t<div class="btn-add-button"></div>\n\t\t\t\t\t\t\t<div class="btn-add-youtube"></div>\n\t\t\t\t\t\t\t<div class="btn-content-edit"></div>\n\t\t\t\t\t\t\t<div class="btn-remove"></div>\n\t\t\t\t\t\t</div>')})),document.querySelectorAll(".btn-add-h1").forEach((e=>{e.addEventListener("click",(e=>M(e,"h1")))})),document.querySelectorAll(".btn-add-h2").forEach((e=>{e.addEventListener("click",(e=>M(e,"h2")))})),document.querySelectorAll(".btn-add-p").forEach((e=>{e.addEventListener("click",(e=>M(e,"p")))})),document.querySelectorAll(".btn-add-image").forEach((e=>{e.addEventListener("click",(e=>M(e,"image")))})),document.querySelectorAll(".btn-add-ul").forEach((e=>{e.addEventListener("click",(e=>M(e,"ul")))})),document.querySelectorAll(".btn-add-button").forEach((e=>{e.addEventListener("click",(e=>M(e,"button")))})),document.querySelectorAll(".btn-add-youtube").forEach((e=>{e.addEventListener("click",(e=>M(e,"youtube")))})),document.querySelectorAll(".btn-add-sound").forEach((e=>{e.addEventListener("click",(e=>M(e,"sound")))})),document.querySelectorAll(".btn-content-edit").forEach((e=>{e.addEventListener("click",(e=>editElement(e)))})),document.querySelectorAll(".btn-remove").forEach((e=>{e.addEventListener("click",(e=>R(e)))}))}else{document.querySelectorAll(".edit-mc").forEach((e=>{e.classList.add("contain-html"),e.classList.remove("edit-mc")}))}function j(e){let t=e.target.getAttribute("data-order_id");listItems.forEach((e=>{e.classList.remove("active")}));const o=document.querySelector(`#locationlist [data-id="${t.toString()}"]`);console.log(o),o.classList.add("active"),Ue(parseInt(t))}console.log("Edit mode on..."),document.querySelectorAll(".gotobutton").forEach((e=>{"project"===dataType?(e.removeEventListener("click",j),e.addEventListener("click",j)):e.remove()})),console.log("Added events to all goto buttons..."),A.addEventListener("click",(function(){let e=A.classList.toggle("liked"),t=A.querySelector(".amount"),o=parseInt(t.textContent.trim());o+=e?1:-1,t.textContent=formatNumber(o)}));const _=document.querySelector(".user-details .userinfo a");_.textContent=e.user.username,_.href="https://yourwebsite.com/profile/"+e.user.username;const D=document.querySelector(".user-details .thumbnail");D.href="https://yourwebsite.com/profile/"+e.user.username;D.querySelector("img").src=e.user.thumbnail,document.querySelector("#info-details .title").textContent=i.location_title,document.querySelector("#info-details .description").textContent=i.location_description,document.querySelector(".details-likes span").textContent=formatNumber(i.likes_count),document.querySelector(".details-views span").textContent=formatNumber(i.views_count),document.querySelector(".details-created span").textContent=i.registered,document.querySelector(".details-comments span").textContent=formatNumber(i.total_comments),document.querySelector("#commentbtn .amount").textContent=formatNumber(i.total_comments),ge.updateProjectionMatrix(),console.log("End of the content creation function...")}Be.addEventListener("click",(()=>{copyToClipboard("#linktoshare span")})),Xe.addEventListener("click",(()=>{copyToClipboard("#embedcode textarea")})),document.querySelector("#lookatx").addEventListener("change",(e=>{startLocX=parseInt(e.target.value),currentLocX=parseInt(e.target.value),updateShareLink(),ze(),Pe.querySelector("span").textContent=shareLink,Fe.querySelector("textarea").textContent=embedIframeLink})),document.querySelector("#lookaty").addEventListener("change",(e=>{startLocY=parseInt(e.target.value),currentLocY=parseInt(e.target.value),updateShareLink(),ze(),Pe.querySelector("span").textContent=shareLink,Fe.querySelector("textarea").textContent=embedIframeLink})),userInteracted||E.addEventListener("click",(()=>{userInteracted=!0,S.style.display="flex",Se.play(),E.style.display="none"}));parseFloat(a.value);document.addEventListener("wheel",(function(e){if(function(e){if(e&&e.target){const t=e.target;return null!==t.closest("#scrollable")||null!==t.closest("#info")||null!==t.closest(".marker-container")||null!==t.closest("#comments")||null!==t.closest("#music")||null!==t.closest("#share")||null!==t.closest("#browse-files")}return!1}(e))return;const t=.1*e.deltaY,o=-Ee.object.position.length();Ee.rotateSpeed=.005*o,he+=.1*t,he=Math.max(10,Math.min(90,he)),ge.aspect=window.innerWidth/window.innerHeight,ge.fov=he,ge.updateProjectionMatrix(),a.value=(he-10)/80})),a.addEventListener("input",(function(){const e=parseFloat(a.value),t=10+80*e,o=Ee.maxDistance,n=Ee.minDistance,r=n+e*(o-n);ge.fov=t,ge.maxDistance=r,ge.updateProjectionMatrix()})),d.textContent="↑",n.appendChild(d),d.addEventListener("click",(()=>{Ve()}));ge.rotation.clone(),ge.position.clone();const Ye=new THREE.Vector3(0,0,0),Ge=(new THREE.Quaternion).setFromEuler(new THREE.Euler(0,0,0));function Ve(e=Ye,t=Ge){const o=(new THREE.Quaternion).setFromEuler(ge.rotation.clone()),n=(new THREE.Quaternion).setFromEuler(t),r=ge.position.clone(),a=e.clone(),i=performance.now();!function e(){const t=performance.now()-i,s=Math.min(t/1e3,1);ge.quaternion.slerpQuaternions(o,n,s),ge.position.lerpVectors(r,a,s),Ee.target.copy(ge.position).add(new THREE.Vector3(0,0,-1).applyQuaternion(ge.quaternion));const l=-Math.atan2(ge.position.x,ge.position.z);d.style.transform=`translate(-50%, -50%) rotate(${l}rad)`,t<1e3&&requestAnimationFrame(e)}()}function Qe(){document.fullscreenElement?document.exitFullscreen&&(l.classList.remove("fullscreen"),document.exitFullscreen(),o.classList.remove("rootfullscreen")):(document.documentElement.requestFullscreen(),l.classList.add("fullscreen"),o.classList.add("rootfullscreen"))}l.addEventListener("click",Qe),l.addEventListener("touchstart",Qe),l.addEventListener("selectstart",Qe),window.addEventListener("resize",(function(e){if(ge.aspect=window.innerWidth/window.innerHeight,ge.updateProjectionMatrix(),be.setSize(window.innerWidth,window.innerHeight),Le.setSize(window.innerWidth,window.innerHeight),be.setPixelRatio(window.devicePixelRatio),Ce(),0!==c.style.bottom){let e=c.getBoundingClientRect().height;c.style.bottom="-"+e+"px"}pt()})),I.addEventListener("wheel",(function(e){e.preventDefault();const t=e.deltaY;I.scrollLeft+=t}));let Je,Ze,Ke=!1;function et(){Ke=!1,I.style.cursor="grab"}function tt(e){if(!Ke)return;const t=3*(e.pageX-I.offsetLeft-Je);I.scrollLeft=Ze-t}function ot(){document.getElementsByTagName("canvas")[0].style.filter="contrast(1) brightness(1) saturate(1)",M.value="3.5",F.textContent="3.5",Re(3.5),A.value="1",_.textContent="1",R.value="1",D.textContent="1",C.value="1",P.textContent="1",j.value="1",N.textContent="1",Se.volume="1"}function nt(){B.style.opacity="1",$.style.right="-640px"}function rt(){f.style.opacity="0",h.classList.add("infoshow"),document.querySelector("#info-location").scrollTop=0}function at(){f.style.opacity="1",h.classList.remove("infoshow")}function it(){v.style.opacity="0",p.classList.add("infoshow")}function st(){v.style.opacity="1",p.classList.remove("infoshow")}function lt(){let e=document.querySelector("#commentbtn"),t=document.querySelector("#commentInputField");t&&(t.blur(),t.placeholder="Write your comment"),e.style.opacity="1";document.querySelector("#comments").innerHTML="",L.classList.remove("commentshow")}function ct(){let e=document.querySelector("#commentbtn").getAttribute("data-embedid");xhrSend("POST","../php/getcomments.php","i="+e).then((e=>{if(e){console.log(e),buildComments(e,e.creator,e.user),document.querySelector("#commentbtn .amount").textContent=e.total_comments;const t=document.querySelector("#closecommentsbtn");b.style.opacity="0",L.classList.add("commentshow"),document.querySelector("#commentInputField").focus(),t.removeEventListener("click",lt),t.removeEventListener("touchstart",lt),t.removeEventListener("selectstart",lt),t.addEventListener("click",lt),t.addEventListener("touchstart",lt),t.addEventListener("selectstart",lt)}else console.log("fail")})).catch((e=>{console.error("Get comments. XHR request failed:",e)}))}I.addEventListener("mousedown",(function(e){e.preventDefault(),Ke=!0,Je=e.pageX-I.offsetLeft,Ze=I.scrollLeft,I.style.cursor="grabbing"})),I.addEventListener("touchstart",(function(e){e.preventDefault(),Ke=!0,Je=e.pageX-I.offsetLeft,Ze=I.scrollLeft,I.style.cursor="grabbing"})),I.addEventListener("mouseup",et),I.addEventListener("touchstart",et),I.addEventListener("mouseleave",et),I.addEventListener("mousemove",(e=>{tt(e)})),I.addEventListener("touchmove",(e=>{tt(e)})),j.addEventListener("input",(()=>{const e=j.value;Se.volume=e,document.querySelectorAll("audio").forEach((t=>{t.volume=e})),N.textContent=e})),M.addEventListener("input",(()=>{const e=M.value;Re(e),F.textContent=e})),A.addEventListener("input",(()=>{const e=document.getElementsByTagName("canvas")[0],t=e.style.filter||"contrast(1) brightness(1) saturate(1)",o=parseFloat(t.match(/contrast\((\d+(\.\d+)?)\)/)[1]),n=parseFloat(t.match(/saturate\((\d+(\.\d+)?)\)/)[1]),r=A.value;e.style.filter=`contrast(${o}) brightness(${r}) saturate(${n})`,_.textContent=r})),R.addEventListener("input",(()=>{const e=document.getElementsByTagName("canvas")[0],t=e.style.filter||"contrast(1) brightness(1) saturate(1)",o=parseFloat(t.match(/brightness\((\d+(\.\d+)?)\)/)[1]),n=parseFloat(t.match(/saturate\((\d+(\.\d+)?)\)/)[1]),r=R.value;e.style.filter=`contrast(${r}) brightness(${o}) saturate(${n})`,D.textContent=r})),C.addEventListener("input",(()=>{const e=document.getElementsByTagName("canvas")[0],t=e.style.filter||"contrast(1) brightness(1) saturate(1)",o=parseFloat(t.match(/brightness\((\d+(\.\d+)?)\)/)[1]),n=parseFloat(t.match(/contrast\((\d+(\.\d+)?)\)/)[1]),r=C.value;e.style.filter=`contrast(${n}) brightness(${o}) saturate(${r})`,P.textContent=r})),X.addEventListener("click",ot),X.addEventListener("touchstart",ot),X.addEventListener("selectstart",ot),z.addEventListener("click",nt),z.addEventListener("touchstart",nt),z.addEventListener("selectstart",nt),f.addEventListener("click",rt),f.addEventListener("touchstart",rt),f.addEventListener("selectstart",rt),y.addEventListener("click",at),y.addEventListener("touchstart",at),y.addEventListener("selectstart",at),v.addEventListener("click",it),v.addEventListener("touchstart",it),v.addEventListener("selectstart",it),m.addEventListener("click",st),m.addEventListener("touchstart",st),m.addEventListener("selectstart",st),b.addEventListener("click",ct),b.addEventListener("touchstart",ct),b.addEventListener("selectstart",ct),document.addEventListener("DOMContentLoaded",(function(){}));const dt=document.getElementById("map"),ut=document.getElementById("mapimage"),mt=document.getElementById("mapimg");if(null!==e.project.map_filename){i.style.display="block",mt.src="https://snallapojkar.se/360/img/"+e.project.map_filename,e.project.map_links.forEach((e=>{let t=`<div class="maplink ${e.pos_left>50?" linktextleft":""}" data-id="${e.link_location_id}" data-order_index="${e.link_order_index}" style="top: ${e.pos_top}%; left: ${e.pos_left}%">\n            <span class="hint">${e.link_title}</span>\n        </div>`;ut.insertAdjacentHTML("beforeend",t)}));function pt(){ut.style.width="100%",ut.style.height="100%";const e=ut.clientWidth,t=ut.clientHeight,o=mt.naturalWidth,n=mt.naturalHeight;let r,a;e/t<o/n?(r=e,a=e/o*n):(a=t,r=t/n*o),ut.style.width=r+"px",ut.style.height=a+"px"}function vt(){"none"===dt.style.display||""===dt.style.display?(dt.style.display="flex",dt.querySelector("img").style.display="block",pt()):(dt.classList.add("removeblur"),dt.querySelector("img").style.display="none",setTimeout((()=>{dt.classList.remove("removeblur"),dt.style.display="none"}),600))}document.querySelectorAll(".maplink").forEach((e=>{e.addEventListener("click",(e=>{const t=parseInt(e.target.getAttribute("data-order_index"));dt.style.display="none",listItems.forEach((e=>{e.classList.remove("active")}));document.querySelector(`#locations [data-id="${t}"]`).classList.add("active"),Ue(parseInt(t))}))})),i.addEventListener("click",vt),i.addEventListener("touchstart",vt),i.addEventListener("selectstart",vt),pt()}else i.style.display="none";function yt(e){console.log(e);const[t,o,n]=e.split(":").map(parseFloat);let[r,a]=[0,0];if("string"==typeof n&&n.includes(",")){const e=n.split(",");r=parseFloat(e[0]),a=parseFloat(e[1])}else r=parseFloat(n);return 3600*t+60*o+r+a/1e3}navigator.userAgent.toLowerCase().match(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i)&&(console.log("You are using a mobile device."),window.addEventListener("deviceorientation",(function(e){ge.rotation.x=e.beta*Math.PI/180,ge.rotation.y=e.gamma*Math.PI/180,ge.rotation.z=e.alpha*Math.PI/180})))}xhrSend("POST",fileCheckData,uri).then((e=>{if(console.log(e),!e.haspass&&e.ispublic)xhrSend("POST",fileGetData,uri).then((e=>{console.log(e),buildHtml(),start(e)})).catch((e=>{console.error("Start. XHR request failed:",e)}));else{if(e.haspass&&e.ispublic)return console.log("This has password ON."),void buildPasswordHtml();if(!e.haspass&&!e.ispublic)return void console.log("This is private.");if(e.haspass&&!e.ispublic)return void console.log("This is private and has password.")}})).catch((e=>{console.error("Check if it has password. XHR request failed:",e)}));