import*as THREE from"three";import{OrbitControls}from"three/examples/jsm/controls/OrbitControls";import{CSS2DRenderer,CSS2DObject}from"three/addons/renderers/CSS2DRenderer.js";import{rootHTML,haspassHTML}from"./360template.min.js";import{buildComments}from"./comments.min.js";import{testInternetSpeed,xhrSend,getUrlParameter,formatNumber,copyToClipboard}from"./functions.min.js";var listItems,marker,userInteracted=!1,dataType="",markerData=[],highSpeed=!1,sceneType="image",overidePassword=!1;function imageClickHandler(e){const t=document.querySelector("#root"),n=document.createElement("div"),o=e.target.cloneNode(!0),r="zoom-div-"+Date.now();n.id=r,n.classList.add("zoomedimage"),o.classList.remove("zoom-image"),n.appendChild(o),t.appendChild(n),n.addEventListener("click",(function(){t.removeChild(n)}))}const root=new THREE.Group;window.addEventListener("load",(function(){testInternetSpeed().then((e=>{console.log("Internet speed:",e,"Kbps"),e>=1e3?(console.log("High-speed connection detected. Load high-quality."),highSpeed=!0):(console.log("Low-speed connection detected. Load low-quality."),highSpeed=!1)})).catch((e=>{console.error("Error testing internet speed:",e)}))}));const embedId=getUrlParameter("i");var locId=getUrlParameter("loc");locId||(locId=1);const baseUri="localhost/360/",uri="i="+embedId+"&loc="+locId;var startLocX=0,startLocY=0,currentLocX=0,currentLocY=0,selectStartLocation=locId,shareLink=baseUri+"watch/?="+embedId+"&loc="+selectStartLocation+"&x="+startLocX+"&y="+startLocY,embedLink=baseUri+"embed/?="+embedId+"&loc"+selectStartLocation+"&x="+startLocX+"&y"+startLocY,setEmbedWidth="640",setEmbedHeight="480",embedIframeLink=`<iframe width="${setEmbedWidth}" height="${setEmbedHeight}" src="${embedLink}" title="360 player"></iframe>`;function updateShareLink(){shareLink=baseUri+"watch/?="+embedId+"&loc="+selectStartLocation+"&x="+startLocX+"&y="+startLocY,embedIframeLink=`<iframe width="${setEmbedWidth}" height="${setEmbedHeight}" src="${embedLink=baseUri+"embed/?="+embedId+"&loc="+selectStartLocation}" title="360 player"></iframe>`}const fileCheckData="../php/checkdata.php",fileGetData="../php/getdata.php";function buildHtml(){document.getElementById("root").innerHTML=rootHTML}function buildPasswordHtml(){document.getElementById("root").innerHTML=haspassHTML,document.querySelector("#haspass-password").focus(),document.querySelector("#enter-password").addEventListener("click",(e=>{e.preventDefault();const t=document.querySelector("#haspass-login form"),n=document.querySelector("#haspass-password").value.trim();t.insertAdjacentHTML("beforebegin",'<div class="loader"></div>');const o=document.querySelector(".loader");if(t.style.display="none",""===n)return alert("Password can not be empty."),t.style.display="block",void o.remove();if(n.length<5)return alert("Password must be 5 letters or longer."),t.style.display="block",void o.remove();xhrSend("POST","../php/checkpass.php","i="+embedId+"&loc="+locId+"&pass="+n).then((e=>{console.log(e),e.success?(document.querySelector("#haspass-login").remove(),xhrSend("POST",fileGetData,uri).then((e=>{console.log(e),overidePassword=!0,buildHtml(),start(e)})).catch((e=>{console.error("XHR request failed:",e)}))):setTimeout((()=>{alert("Wrong password."),t.style.display="block",o.remove()}),3e3)})).catch((e=>{console.error("XHR request failed:",e)}))}))}function start(e){dataType=e.hasOwnProperty("project")?"project":"location",console.log("Data Type:",dataType);const t="http://localhost/360/",n=document.querySelector("#root"),o=document.getElementById("view-container"),r=document.querySelector("#zoombtn"),a=document.querySelector("#zoomlevel"),s=document.querySelector("#mapbtn"),i=document.querySelector(".rightbuttons"),c=document.querySelector("#fullscreenbtn"),l=document.getElementById("locations"),d=document.getElementById("angleIndicator"),u=document.querySelector("#indicatorbtn"),m=document.querySelector("#closesharebtn"),p=document.querySelector("#share"),y=document.querySelector("#sharebtn"),h=document.querySelector("#closeinfobtn"),v=document.querySelector("#info"),f=document.querySelector("#infobtn"),E=document.querySelector("#resizer"),g=(document.querySelector("#likebtn"),document.querySelector("#commentbtn")),L=document.querySelector("#comments"),S=document.querySelector("#btn-playvideo"),b=document.querySelector("#videoplayer"),k=document.querySelector("#playvideo"),w=document.querySelector("#videoduration"),q=document.querySelector("#caption"),x=document.querySelector("#captionselect"),T=document.querySelector("#captionselect ul"),H=document.querySelector("#scrollable"),I=document.querySelector("#labels"),R=document.querySelector("#settings"),C=document.getElementById("brightness"),$=document.getElementById("contrast"),_=document.getElementById("saturation"),M=document.getElementById("ambient"),A=document.getElementById("volume"),j=document.getElementById("brightnessNo"),F=document.getElementById("contrastNo"),D=document.getElementById("saturationNo"),P=document.getElementById("ambientNo"),X=document.getElementById("volumeNo"),B=document.querySelector(".settingsbtn"),N=document.getElementById("reset"),W=document.querySelector(".closebtn"),U=document.querySelector(".show-loc"),z=document.querySelector(".show-info"),O=document.querySelector("#info-location"),V=document.querySelector("#info-details");U.addEventListener("click",(()=>{O.style.display="block",document.querySelector("#info-location").scrollTop=0,V.style.display="none",U.classList.add("showactive"),z.classList.remove("showactive")})),z.addEventListener("click",(()=>{V.style.display="block",document.querySelector("#info-details").scrollTop=0,O.style.display="none",U.classList.remove("showactive"),z.classList.add("showactive")}));const Y=document.querySelector(".show-link"),G=document.querySelector(".show-embed"),Q=document.querySelector("#share-link"),J=document.querySelector("#share-embed");Y.addEventListener("click",(()=>{Q.style.display="block",J.style.display="none",Y.classList.add("showactive"),G.classList.remove("showactive")})),G.addEventListener("click",(()=>{J.style.display="block",Q.style.display="none",Y.classList.remove("showactive"),G.classList.add("showactive")}));const K=460,Z=1800;let ee,te,ne,oe=!1;function re(e){oe=!0,ee=e.clientX||e.touches[0].clientX,te=parseInt(document.defaultView.getComputedStyle(v).width,10),document.body.addEventListener("mousemove",ae),document.body.addEventListener("touchmove",ae),document.body.addEventListener("mouseup",se),document.body.addEventListener("touchstart",se),document.body.addEventListener("selectend",se)}function ae(e){if(!oe)return;const t=e.clientX||e.touches[0].clientX;let n=te-(t-ee);n=Math.max(K,Math.min(Z,n)),v.style.width=n+"px"}function se(){oe=!1,document.removeEventListener("mousemove",ae),document.removeEventListener("touchmove",ae),document.removeEventListener("mouseup",se),document.removeEventListener("touchstart",se),document.removeEventListener("selectend",se)}function ie(){if(0===parseFloat(l.style.bottom)){let e=l.getBoundingClientRect().height;l.style.bottom="-"+e+"px",u.classList.remove("rotate180")}else u.classList.add("rotate180"),l.style.bottom="0"}function ce(){l.style.opacity="1",d.style.opacity="1",B.style.opacity="1",r.style.opacity="1",s.style.opacity="1",i.style.opacity="1"}function le(){l.style.opacity="0",d.style.opacity="0",B.style.opacity="0",r.style.opacity="0",s.style.opacity="0",i.style.opacity="0"}function de(){clearTimeout(ne),"1"!==r.style.opacity&&ce(),ne=setTimeout((()=>{le()}),7e3)}function ue(){R.style.right="0px",B.style.opacity="0"}E.addEventListener("mousedown",re),E.addEventListener("touchstart",re),E.addEventListener("selectstart",re),u.addEventListener("click",ie),u.addEventListener("touchstart",ie),u.addEventListener("selectend",ie),ce(),document.addEventListener("keydown",(e=>{if("h"===e.key||"H"===e.key){const e=document.querySelector("#view-container"),t=document.querySelector("#outside");if(document.querySelector("#commentInputField").contains(document.activeElement))return;"none"===e.style.display?(e.style.display="block",t.style.display="block"):(e.style.display="none",t.style.display="none")}})),ne=setTimeout((()=>{le()}),7e3),document.addEventListener("mousemove",(function(e){de()})),document.addEventListener("touchmove",(function(e){de()})),B.addEventListener("click",ue),B.addEventListener("touchstart",ue),B.addEventListener("selectstart",ue);const me=document.querySelector("#locationlist");e.locations.forEach((e=>{me.insertAdjacentHTML("afterbegin","<li></li>")})),"project"===dataType&&e.project&&!0===e.project.showlocations||document.querySelector("#indicatorbtn").remove();let pe=75;const ye=new THREE.Scene,he=new THREE.PerspectiveCamera(pe,window.innerWidth/window.innerHeight,.1,1e3),ve=new THREE.WebGLRenderer({alpha:!1});ve.setSize(window.innerWidth,window.innerHeight),ve.setClearColor(0),n.appendChild(ve.domElement);const fe=new CSS2DRenderer;fe.setSize(window.innerWidth,window.innerHeight),fe.domElement.style.position="absolute",fe.domElement.style.top="0px",fe.domElement.style.pointerEvents="none",n.appendChild(fe.domElement);const Ee=new OrbitControls(he,ve.domElement);Ee.enablePan=!1,Ee.enableDamping=!0,Ee.dampingFactor=.05,Ee.rotateSpeed=-1,Ee.autoRotate=!1,Ee.autoRotateSpeed*=.25,he.position.set(0,0,0),he.rotation.order="YXZ";Oe(new THREE.Vector3(0,0,0),(new THREE.Quaternion).setFromEuler(new THREE.Euler(0,150,0))),Ee.minDistance=30,Ee.maxDistance=280,Ee.zoomSpeed=3;const ge=document.createElement("video");let Le,Se,be;const ke=new THREE.SphereGeometry(360,180,180),we=new THREE.DataTexture(new Uint8Array([0,0,0]),1,1,THREE.RGBFormat);we.needsUpdate=!0;const qe=new THREE.MeshStandardMaterial({map:we,side:THREE.DoubleSide}),xe=new THREE.Mesh(ke,qe);ye.add(xe),ye.add(root);let Te,He=4;function Ie(e){He=e,Te&&ye.remove(Te),Te=new THREE.AmbientLight(16777215,e),ye.add(Te)}function Re(){ve.render(ye,he),fe.render(ye,he)}function Ce(){requestAnimationFrame(Ce),Ee.update(),Re(),function(){const e=THREE.MathUtils.radToDeg(he.rotation.y),t=THREE.MathUtils.radToDeg(he.rotation.x);console.log("x:",Math.floor(e),"y:",Math.floor(t)),currentLocX=Math.floor(e),currentLocY=Math.floor(t)}();const e=-Math.atan2(he.position.x,he.position.z);d.style.transform=`translate(-50%, -50%) rotate(${e}rad)`}function $e(e,t){const n=t.getViewerPose();if(n){const e=n.views;for(let t of e){const e=xrLayer.getViewport(t),n=t.projectionMatrix;ve.setViewport(e.x,e.y,e.width,e.height),ve.setProjectionMatrix(n),ve.render(ye,he)}}t.session.requestAnimationFrame($e)}Ie(3.5),"xr"in navigator?(console.log("WebXR is supported in this browser."),"requestDevice"in navigator.xr?navigator.xr.requestDevice().then((e=>{console.log("XR device obtained:",e),e.requestSession({immersive:!0}).then((e=>{console.log("XR session started:",e);const t=ve.getContext(),n=new XRWebGLLayer(e,t);e.updateRenderState({baseLayer:n}),e.requestAnimationFrame($e)})).catch((e=>{console.error("Failed to start XR session:",e),Ce()}))})).catch((e=>{console.error("Failed to obtain XR device:",e),Ce()})):"requestSession"in navigator.xr?navigator.xr.requestSession("immersive-vr").then((e=>{console.log("XR session started:",e);const t=ve.getContext(),n=new XRWebGLLayer(e,t);e.updateRenderState({baseLayer:n}),e.requestAnimationFrame($e)})).catch((e=>{console.error("Failed to start XR session:",e),Ce()})):(console.error("WebXR APIs are present, but neither requestDevice nor requestSession methods are available."),Ce())):(console.log("WebXR not supported in this browser."),Ce());let _e="";console.log("Render locations list for project...");for(let n=0;n<e.locations.length;n++){const o=e.locations[n];let r=0===n&&"video"===o.file_type?"active":"",a=o.file_name.replace(/\.\w+$/,".jpg");if("video"===o.file_type){sceneType="video";const e=a.split(".").slice(0,-1).join(".");_e+=`<li class="${r}" data-file="${o.file_name}" data-id="${o.id}" data-order_index="${o.order_index}" data-type="${o.file_type}">\n                            <span class="icon-video">${o.duration}</span>\n                            <div>${o.location_title}</div>\n                            <img src="${t}video/${e}-low.jpg" alt="" />\n                        </li>`}else{sceneType="image";const e=o.file_name.split(".").slice(0,-1).join(".");_e+=`<li class="${r}" data-file="${o.file_name}" data-id="${o.id}" data-order_index="${o.order_index}" data-type="${o.file_type}">\n                            <div>${o.location_title}</div>\n                            <img src="${t}img/${e}-low.jpg" alt="" />\n                        </li>`}}function Me(e){listItems.forEach((e=>{e.classList.remove("active")})),e.classList.add("active");const t=e.getAttribute("data-order_index");We(parseInt(t))}document.querySelector("#locationlist").innerHTML=_e,(listItems=document.querySelectorAll("#locationlist li")).forEach((e=>{e.addEventListener("click",(function(){Me(e)})),e.addEventListener("touchstart",(function(){Me(e)})),e.addEventListener("selectend",(function(){Me(e)}))})),function t(){const n=document.querySelector("#locations .container ul li:first-child");if(n)if(locId>e.locations.length){const t=e.locations[0].order_index;We(parseInt(t)),n.classList.add("active")}else{document.querySelector(`#locations .container ul li[data-order_index='${locId}']`).classList.add("active"),We(parseInt(locId))}else setTimeout(t,1e3)}();document.querySelectorAll(".startlocations").forEach((n=>{var o="";e.locations.map((e=>{const n=e.file_name.replace(/\.\w+$/,".jpg").split(".").slice(0,-1).join("."),r="video"===e.file_type?"video":"img";o+=`<div class="start-location" data-id="${e.id}" data-order_index="${e.order_index}">\n\t\t\t\t\t<h5 class="title">${e.location_title}</h5>\n\t\t\t\t\t<div class="locimage">\n\t\t\t\t\t\t<img src="${t}${r}/${n}-low.jpg" alt="" />\n\t\t\t\t\t</div>\n\t\t\t\t</div>`})),n.innerHTML=o}));const Ae=document.querySelector("#linktoshare"),je=document.querySelector("#embedcode"),Fe=document.querySelectorAll(".start-location");e.locations.length<locId&&(selectStartLocation=1),Fe.forEach((e=>{e.addEventListener("click",(()=>{Fe.forEach((e=>{e.classList.remove("active")}));const t=e.getAttribute("data-order_index");Array.from(Fe).filter((function(e){return e.getAttribute("data-order_index")===t})).forEach((e=>{e.classList.add("active")})),selectStartLocation=t,updateShareLink(),Ae.querySelector("span").textContent=shareLink,je.querySelector("textarea").textContent=embedIframeLink}))})),document.querySelectorAll('.start-location[data-order_index="'+selectStartLocation+'"]').forEach((e=>{e.classList.add("active")})),updateShareLink(),Ae.querySelector("span").textContent=shareLink,je.querySelector("textarea").textContent=embedIframeLink;const De=document.querySelector("#copylink"),Pe=document.querySelector("#copyembed");function Xe(){const e=THREE.MathUtils.degToRad(currentLocX),t=THREE.MathUtils.degToRad(currentLocY);he.position.set(e,t,he.position.z),he.rotation.set(e,t,he.position.z),he.lookAt(ye.position),he.updateProjectionMatrix()}function Be(e){e.preventDefault();const t=e.target.getAttribute("data-order_index");We(parseInt(t))}function Ne(e){if(!e.target.closest(".marker-container")){e.preventDefault();let t=e.target,n=t.querySelector(".hint"),o=t.querySelector(".marker-container");if("none"===getComputedStyle(o).display){if(o.style.display="block",o){o.querySelector(".marker-content").scrollTop=0;let e=o.querySelector(".soundplay");if(e){if("true"===e.getAttribute("data-autoplay")){let t=e.querySelector("audio");t&&(t.paused||(t.pause(),t.currentTime=0),t.play())}}}n.style.display="none"}else o.style.display="none",n.style.display="block"}}function We(n){S.style.display="none",b.style.display="none";let o=document.querySelectorAll(".intlink"),r=document.querySelectorAll(".infodot");o.forEach((e=>{e.removeEventListener("click",Be)})),r.forEach((e=>{e.removeEventListener("click",Ne)}));let a,s=document.querySelectorAll(".zoom-image");s.forEach((e=>{e.removeEventListener("click",imageClickHandler)})),I.innerHTML="",v.classList.remove("infoshow"),a="project"===dataType&&e.project?e.locations.find((e=>e.order_index===n)):e.locations[0],document.querySelector("#commentbtn").setAttribute("data-embedid",a.embed_id);let i=a.file_name,c=a.file_type,l=a.info;if(markerData=a.markers,root.clear(),""!==markerData&&null!=markerData&&(console.log("Creating markers..."),async function(e){return new Promise((t=>{if(0===e.length)return void t();let n=0;const o=()=>{let o=document.querySelectorAll(".intlink"),a=document.querySelectorAll(".infodot");(o.length>0||a.length>0)&&(clearInterval(r),o.length>0&&o.forEach((e=>{e.addEventListener("click",Be)})),a.length>0&&a.forEach((e=>{e.addEventListener("click",Ne)})),n===e.length&&t())};o();const r=setInterval(o,50);e.forEach(((e,t)=>{const{marker_title:o,pos_x:r,pos_y:a,pos_z:s,info:i,link:c,sound:l,autoplay:d,customcss:u}=e,m=new THREE.Vector3(r,a,s);"string"!=typeof c||""===c||isNaN(c)?"string"==typeof c&&""!==c?((marker=document.createElement("a")).href=c,marker.target="_blank",marker.classList.add("extlink")):(marker=document.createElement("div")).classList.add("infodot"):((marker=document.createElement("div")).dataset.order_index=parseInt(c),marker.classList.add("intlink"));let p=t;if(marker.id="marker"+p,""!==u&&null!==u){var y=JSON.parse(u),h="";y.forEach(((e,t)=>{h+="#marker"+p+e,t!==y.length-1&&(h+=" ")}));var v=document.querySelector("style[data-customcss]");if(v)v.textContent+=h;else{var f=document.createElement("style");f.textContent=h,f.setAttribute("data-customcss",""),document.head.appendChild(f)}}let E="";null!==l&&""!==l&&(E+='<div class="soundplay"',E+=d?` data-autoplay="${d}">`:">",E+=`<audio controls id="audio${t}">\n\t\t\t\t\t\t\t\t\t<source src="../sound/${l}" type="audio/mpeg">\n\t\t\t\t\t\t\t\t</audio>\n\t\t\t\t\t\t\t</div>`),marker.classList.add("marker");let g=`<span class="hint">${o}</span><div class="marker-container"><div class="marker-content"></div>`;if(marker.innerHTML=g,marker.querySelector(".marker-content").insertAdjacentHTML("afterbegin",i),null!==l&&""!==l){marker.querySelector(".marker-container").insertAdjacentHTML("afterbegin",E)}const L=new CSS2DObject(marker);L.position.copy(m),root.add(L),n++})),he.position.set(360,0,0),he.rotation.set(360,0,0),he.lookAt(ye.position),he.updateProjectionMatrix(),he.position.x=-360,he.rotation.x=-360,he.lookAt(ye.position),he.updateProjectionMatrix(),Re(),console.log("Markers added to root.")}))}(markerData).then((()=>{setTimeout((()=>{s=document.querySelectorAll(".zoom-image"),s.forEach((e=>{e.addEventListener("click",imageClickHandler),console.log(e)})),console.log("Added eventlistener to images...",s),console.log("Markers created.")}),100)}))),"video"===c){if(Le===i)return;sceneType="video";let $=i;Se="",xe.material.map=null,ge.pause(),ge.src="",Le="";const _=a.file_name.split(".").slice(0,-1).join(".");if(highSpeed||($=_+"-low.mp4",function(e,n){const o=document.createElement("video");o.src=t+"video/"+n,o.addEventListener("canplay",(function(){const t=setInterval((function(){if(4===o.readyState){clearInterval(t),e.pause();let n=e.currentTime;e.src="",e.src=o.src,e.currentTime=n,e.play(),console.log("High-quality video loaded and switched.")}}),100)}))}(ge,i)),ge.src=t+"video/"+$,ge.load(),ge.crossOrigin="anonymous",ge.loop=!0,ge.playsInline=!0,Le=i,""!==a.captions){x.style.display="block";const A=document.querySelector("#captionselect ul");let j="";a.captions.forEach((e=>{j+=`<li data-caption="${e.caption_language}" data-id="${a.id}">${e.caption_language}</li>`})),j+='<li id="captionoff" class="active">Captions off</li>',A.innerHTML=j;const F=document.querySelectorAll("#captionselect ul li");function d(n){const o=n.target.getAttribute("data-id");let r=e.locations.find((e=>e.id===parseInt(o)));const a=n.target.getAttribute("data-caption"),s=r.file_name.split(".").slice(0,-1).join("."),i=`${t}video/${s}-${a}.srt`;console.log(i),q.style.display="block",F.forEach((e=>{e.classList.remove("active")})),n.target.classList.add("active"),x.classList.add("on"),fetch(i).then((e=>e.blob())).then((e=>{!function(e){const t=new FileReader;t.onload=function(e){const t=function(e){const t=e.trim().split(/\r?\n/),n=[];let o={};for(let e=0;e<t.length;e++){const r=t[e].trim();if(r)if(o.id)if(o.start)o.text?(n.push(o),o={}):o.text=r;else{const e=r.split(" --\x3e ");if(2!==e.length){o={};continue}o.start=ut(e[0]),o.end=ut(e[1])}else o.id=parseInt(r)}return console.log(n),n}(e.target.result);console.log(t),function(e){ge.addEventListener("timeupdate",(function(){const t=ge.currentTime,n=document.getElementById("caption");for(const o of e)if(t>=o.start&&t<=o.end)return void(n.innerHTML=`<p>${o.text}</p>`);n.innerHTML=""}))}(t)},t.readAsText(e)}(e)})).catch((e=>{console.error("Error fetching or converting SRT file:",e)}))}F.forEach((e=>{e.addEventListener("click",d),e.addEventListener("touchstart",d),e.addEventListener("selectstart",d)}));const D=document.querySelector("#captionoff");function u(){F.forEach((e=>{e.classList.remove("active")})),D.classList.add("active"),x.classList.remove("on"),q.style.display="none"}D.addEventListener("click",u),D.addEventListener("touchstart",u),D.addEventListener("selectstart",u)}else x.style.display="none";function m(){"none"===T.style.display?T.style.display="block":T.style.display="none"}function p(){k.classList.contains("playing")?(k.classList.remove("playing"),ge.pause()):(k.classList.add("playing"),ge.play())}k.classList.add("playing"),x.addEventListener("click",m),x.addEventListener("touchstart",m),x.addEventListener("selectstart",m),k.addEventListener("click",p),k.addEventListener("touchstart",p),k.addEventListener("selectstart",p);const M=document.querySelector("#currenttime");function y(){const e=parseFloat(w.value);ge.currentTime=e*ge.duration;const t=f(ge.currentTime);M.textContent=t}function h(){ge.removeEventListener("timeupdate",(()=>{})),y()}function f(e){const t=Math.floor(e/3600),n=Math.floor(e%3600/60),o=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}ge.addEventListener("timeupdate",(()=>{const e=ge.currentTime/ge.duration;w.value=e.toFixed(2);const t=f(ge.currentTime);M.textContent=t})),w.addEventListener("input",y),w.addEventListener("mousedown",h),w.addEventListener("touchstart",h),w.addEventListener("selectstart",h),userInteracted?(b.style.display="flex",ge.play()):S.style.display="block",be=new THREE.VideoTexture(ge),be.encoding=THREE.LinearEncoding,be.needsUpdate=!0,be.wrapS=THREE.RepeatWrapping,be.repeat.x=-1,be.mapping=THREE.UVMapping,be.encoding=THREE.sRGBEncoding,be.gammaFactor=2.2,xe.material.map=be,xe.material.needsUpdate=!0}else if("image"===c){if(Se===i)return;sceneType="image",b.style.display="none",xe.material.map=null,ge.pause(),ge.src="",Le="";const P=a.file_name.split(".").slice(0,-1).join(".");let X=t+"img/"+i;highSpeed||(X=t+"img/"+P+"-low.jpg");const B=(new THREE.TextureLoader).load(`${X}`,(function(e){e.wrapS=THREE.RepeatWrapping,e.repeat.x=-1,e.mapping=THREE.UVMapping,e.encoding=THREE.sRGBEncoding,e.gammaFactor=2.2}));if(xe.material.map=B,xe.material.needsUpdate=!0,!highSpeed){!function(e,t){const n=new Image;n.src=e,n.onload=function(){const e=new THREE.Texture(n);e.needsUpdate=!0,e.wrapS=THREE.RepeatWrapping,e.repeat.x=-1,e.mapping=THREE.UVMapping,e.encoding=THREE.sRGBEncoding,e.gammaFactor=2.2,t(e)}}(t+"img/"+i,(function(e){xe.material.map=e,xe.material.needsUpdate=!0}))}Se=i}else console.log("Invalid file type");const E=document.querySelector(".show-loc"),g=document.querySelector(".show-info");""!==l&&null!=l?(O.style.display="block",O.innerHTML=l,E.style.display="block",E.classList.add("showactive"),g.classList.remove("showactive")):(O.style.display="none",E.style.display="none",g.classList.add("showactive"));let L=document.querySelector("#likebtn");const H=L.cloneNode(!0);L.parentNode.replaceChild(H,L),H.querySelector(".amount").textContent=formatNumber(a.likes_count),H.setAttribute("data-id",a.id),H.classList.remove("liked"),a.has_liked&&H.classList.add("liked"),H.addEventListener("click",(function(){let e=H.classList.toggle("liked"),t=H.querySelector(".amount"),n=parseInt(t.textContent.trim());n+=e?1:-1,t.textContent=formatNumber(n)}));const R=document.querySelector(".user-details .userinfo a");R.textContent=e.user.username,R.href="https://yourwebsite.com/profile/"+e.user.username;const C=document.querySelector(".user-details .thumbnail");C.href="https://yourwebsite.com/profile/"+e.user.username;C.querySelector("img").src=e.user.thumbnail,document.querySelector("#info-details .title").textContent=a.location_title,document.querySelector("#info-details .description").textContent=a.location_description,document.querySelector(".details-likes span").textContent=formatNumber(a.likes_count),document.querySelector(".details-views span").textContent=formatNumber(a.views_count),document.querySelector(".details-created span").textContent=a.registered,document.querySelector(".details-comments span").textContent=formatNumber(a.total_comments),document.querySelector("#commentbtn .amount").textContent=formatNumber(a.total_comments),he.updateProjectionMatrix()}De.addEventListener("click",(()=>{copyToClipboard("#linktoshare span")})),Pe.addEventListener("click",(()=>{copyToClipboard("#embedcode textarea")})),document.querySelector("#lookatx").addEventListener("change",(e=>{startLocX=parseInt(e.target.value),currentLocX=parseInt(e.target.value),updateShareLink(),Xe(),Ae.querySelector("span").textContent=shareLink,je.querySelector("textarea").textContent=embedIframeLink})),document.querySelector("#lookaty").addEventListener("change",(e=>{startLocY=parseInt(e.target.value),currentLocY=parseInt(e.target.value),updateShareLink(),Xe(),Ae.querySelector("span").textContent=shareLink,je.querySelector("textarea").textContent=embedIframeLink})),userInteracted||S.addEventListener("click",(()=>{userInteracted=!0,b.style.display="flex",ge.play(),S.style.display="none"}));parseFloat(a.value);document.addEventListener("wheel",(function(e){if(function(e){if(e&&e.target){const t=e.target;return null!==t.closest("#scrollable")||null!==t.closest("#info")||null!==t.closest(".marker-container")||null!==t.closest("#comments")||null!==t.closest("#music")||null!==t.closest("#share")}return!1}(e))return;const t=.1*e.deltaY,n=-Ee.object.position.length();Ee.rotateSpeed=.005*n,pe+=.1*t,pe=Math.max(10,Math.min(90,pe)),he.aspect=window.innerWidth/window.innerHeight,he.fov=pe,he.updateProjectionMatrix(),a.value=(pe-10)/80})),a.addEventListener("input",(function(){const e=parseFloat(a.value),t=10+80*e,n=Ee.maxDistance,o=Ee.minDistance,r=o+e*(n-o);he.fov=t,he.maxDistance=r,he.updateProjectionMatrix()})),d.textContent="↑",o.appendChild(d),d.addEventListener("click",(()=>{Oe()}));he.rotation.clone(),he.position.clone();const Ue=new THREE.Vector3(0,0,0),ze=(new THREE.Quaternion).setFromEuler(new THREE.Euler(0,0,0));function Oe(e=Ue,t=ze){const n=(new THREE.Quaternion).setFromEuler(he.rotation.clone()),o=(new THREE.Quaternion).setFromEuler(t),r=he.position.clone(),a=e.clone(),s=performance.now();!function e(){const t=performance.now()-s,i=Math.min(t/1e3,1);he.quaternion.slerpQuaternions(n,o,i),he.position.lerpVectors(r,a,i),Ee.target.copy(he.position).add(new THREE.Vector3(0,0,-1).applyQuaternion(he.quaternion));const c=-Math.atan2(he.position.x,he.position.z);d.style.transform=`translate(-50%, -50%) rotate(${c}rad)`,t<1e3&&requestAnimationFrame(e)}()}function Ve(){document.fullscreenElement?document.exitFullscreen&&(c.classList.remove("fullscreen"),document.exitFullscreen(),n.classList.remove("rootfullscreen")):(document.documentElement.requestFullscreen(),c.classList.add("fullscreen"),n.classList.add("rootfullscreen"))}c.addEventListener("click",Ve),c.addEventListener("touchstart",Ve),c.addEventListener("selectstart",Ve),window.addEventListener("resize",(function(e){if(he.aspect=window.innerWidth/window.innerHeight,he.updateProjectionMatrix(),ve.setSize(window.innerWidth,window.innerHeight),fe.setSize(window.innerWidth,window.innerHeight),ve.setPixelRatio(window.devicePixelRatio),Re(),0!==l.style.bottom){let e=l.getBoundingClientRect().height;l.style.bottom="-"+e+"px"}lt()})),H.addEventListener("wheel",(function(e){e.preventDefault();const t=e.deltaY;H.scrollLeft+=t}));let Ye,Ge,Qe=!1;function Je(){Qe=!1,H.style.cursor="grab"}function Ke(e){if(!Qe)return;const t=3*(e.pageX-H.offsetLeft-Ye);H.scrollLeft=Ge-t}function Ze(){document.getElementsByTagName("canvas")[0].style.filter="contrast(1) brightness(1) saturate(1)",M.value="3.5",P.textContent="3.5",Ie(3.5),C.value="1",j.textContent="1",$.value="1",F.textContent="1",_.value="1",D.textContent="1",A.value="1",X.textContent="1",ge.volume="1"}function et(){B.style.opacity="1",R.style.right="-640px"}function tt(){f.style.opacity="0",v.classList.add("infoshow"),document.querySelector("#info-location").scrollTop=0}function nt(){f.style.opacity="1",v.classList.remove("infoshow")}function ot(){y.style.opacity="0",p.classList.add("infoshow")}function rt(){y.style.opacity="1",p.classList.remove("infoshow")}function at(){let e=document.querySelector("#commentbtn").getAttribute("data-embedid");xhrSend("POST","../php/getcomments.php","i="+e).then((e=>{if(e){console.log(e),buildComments(e,e.creator,e.user),document.querySelector("#commentbtn .amount").textContent=e.total_comments;const n=document.querySelector("#closecommentsbtn");function t(){let e=document.querySelector("#commentbtn"),t=document.querySelector("#commentInputField");t.blur(),t.placeholder="Write your comment",e.style.opacity="1";document.querySelector("#comments").innerHTML="",L.classList.remove("commentshow")}n.removeEventListener("click",t),n.removeEventListener("touchstart",t),n.removeEventListener("selectstart",t),n.addEventListener("click",t),n.addEventListener("touchstart",t),n.addEventListener("selectstart",t)}else console.log("fail")})).catch((e=>{console.error("XHR request failed:",e)})),g.style.opacity="0",L.classList.add("commentshow"),document.querySelector("#commentInputField").focus()}H.addEventListener("mousedown",(function(e){e.preventDefault(),Qe=!0,Ye=e.pageX-H.offsetLeft,Ge=H.scrollLeft,H.style.cursor="grabbing"})),H.addEventListener("touchstart",(function(e){e.preventDefault(),Qe=!0,Ye=e.pageX-H.offsetLeft,Ge=H.scrollLeft,H.style.cursor="grabbing"})),H.addEventListener("mouseup",Je),H.addEventListener("touchstart",Je),H.addEventListener("mouseleave",Je),H.addEventListener("mousemove",(e=>{Ke(e)})),H.addEventListener("touchmove",(e=>{Ke(e)})),A.addEventListener("input",(()=>{const e=A.value;ge.volume=e,document.querySelectorAll("audio").forEach((t=>{t.volume=e})),X.textContent=e})),M.addEventListener("input",(()=>{const e=M.value;Ie(e),P.textContent=e})),C.addEventListener("input",(()=>{const e=document.getElementsByTagName("canvas")[0],t=e.style.filter||"contrast(1) brightness(1) saturate(1)",n=parseFloat(t.match(/contrast\((\d+(\.\d+)?)\)/)[1]),o=parseFloat(t.match(/saturate\((\d+(\.\d+)?)\)/)[1]),r=C.value;e.style.filter=`contrast(${n}) brightness(${r}) saturate(${o})`,j.textContent=r})),$.addEventListener("input",(()=>{const e=document.getElementsByTagName("canvas")[0],t=e.style.filter||"contrast(1) brightness(1) saturate(1)",n=parseFloat(t.match(/brightness\((\d+(\.\d+)?)\)/)[1]),o=parseFloat(t.match(/saturate\((\d+(\.\d+)?)\)/)[1]),r=$.value;e.style.filter=`contrast(${r}) brightness(${n}) saturate(${o})`,F.textContent=r})),_.addEventListener("input",(()=>{const e=document.getElementsByTagName("canvas")[0],t=e.style.filter||"contrast(1) brightness(1) saturate(1)",n=parseFloat(t.match(/brightness\((\d+(\.\d+)?)\)/)[1]),o=parseFloat(t.match(/contrast\((\d+(\.\d+)?)\)/)[1]),r=_.value;e.style.filter=`contrast(${o}) brightness(${n}) saturate(${r})`,D.textContent=r})),N.addEventListener("click",Ze),N.addEventListener("touchstart",Ze),N.addEventListener("selectstart",Ze),W.addEventListener("click",et),W.addEventListener("touchstart",et),W.addEventListener("selectstart",et),f.addEventListener("click",tt),f.addEventListener("touchstart",tt),f.addEventListener("selectstart",tt),h.addEventListener("click",nt),h.addEventListener("touchstart",nt),h.addEventListener("selectstart",nt),y.addEventListener("click",ot),y.addEventListener("touchstart",ot),y.addEventListener("selectstart",ot),m.addEventListener("click",rt),m.addEventListener("touchstart",rt),m.addEventListener("selectstart",rt),g.addEventListener("click",at),g.addEventListener("touchstart",at),g.addEventListener("selectstart",at),document.addEventListener("DOMContentLoaded",(function(){}));const st=document.getElementById("map"),it=document.getElementById("mapimage"),ct=document.getElementById("mapimg");ct.src="https://snallapojkar.se/360/img/"+e.project.map_filename,e.project.map_links.forEach((e=>{let t=`<div class="maplink ${e.pos_left>50?" linktextleft":""}" data-id="${e.link_location_id}" data-order_index="${e.link_order_index}" style="top: ${e.pos_top}%; left: ${e.pos_left}%">\n            <span class="hint">${e.link_title}</span>\n        </div>`;it.insertAdjacentHTML("beforeend",t)}));function lt(){it.style.width="100%",it.style.height="100%";const e=it.clientWidth,t=it.clientHeight,n=ct.naturalWidth,o=ct.naturalHeight;let r,a;e/t<n/o?(r=e,a=e/n*o):(a=t,r=t/o*n),it.style.width=r+"px",it.style.height=a+"px"}function dt(){"none"===st.style.display||""===st.style.display?(st.style.display="flex",lt()):st.style.display="none"}function ut(e){console.log(e);const[t,n,o]=e.split(":").map(parseFloat);let[r,a]=[0,0];if("string"==typeof o&&o.includes(",")){const e=o.split(",");r=parseFloat(e[0]),a=parseFloat(e[1])}else r=parseFloat(o);return 3600*t+60*n+r+a/1e3}document.querySelectorAll(".maplink").forEach((e=>{e.addEventListener("click",(e=>{const t=parseInt(e.target.getAttribute("data-order_index"));st.style.display="none",listItems.forEach((e=>{e.classList.remove("active")}));document.querySelector(`#locations [data-id="${t}"]`).classList.add("active"),We(parseInt(t))}))})),s.addEventListener("click",dt),s.addEventListener("touchstart",dt),s.addEventListener("selectstart",dt),lt(),navigator.userAgent.toLowerCase().match(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i)&&(console.log("You are using a mobile device."),window.addEventListener("deviceorientation",(function(e){he.rotation.x=e.beta*Math.PI/180,he.rotation.y=e.gamma*Math.PI/180,he.rotation.z=e.alpha*Math.PI/180})))}xhrSend("POST",fileCheckData,uri).then((e=>{if(console.log(e),!e.haspass&&e.ispublic)xhrSend("POST",fileGetData,uri).then((e=>{console.log(e),buildHtml(),start(e)})).catch((e=>{console.error("XHR request failed:",e)}));else{if(e.haspass&&e.ispublic)return console.log("This has password ON."),void buildPasswordHtml();if(!e.haspass&&!e.ispublic)return void console.log("This is private.");if(e.haspass&&!e.ispublic)return void console.log("This is private and has password.")}})).catch((e=>{console.error("XHR request failed:",e)}));