import*as THREE from"three";import{OrbitControls}from"three/examples/jsm/controls/OrbitControls";import{CSS2DRenderer,CSS2DObject}from"three/addons/renderers/CSS2DRenderer.js";import{rootHTML,haspassHTML}from"./360template.min.js";import{buildComments}from"./comments.min.js";import{receiveMessage}from"./functions.min.js";import{testInternetSpeed,xhrSend,getUrlParameter,formatNumber,copyToClipboard}from"./functions.min.js";var listItems,marker,editmode,userSubscriber,userInteracted=!1,dataType="",markerData=[],highSpeed=!1,sceneType="image",overidePassword=!1;const eventListenerPromise=new Promise((e=>{window.addEventListener("message",(function(t){const n=receiveMessage(t);n&&e(n)}),!1)}));async function waitForEventListener(){const e=await eventListenerPromise;editmode=e.editmode,userSubscriber=e.subscriber,console.log("Edit mode:",editmode,"Subscriber:",userSubscriber)}function imageClickHandler(e){const t=document.querySelector("#root"),n=document.createElement("div"),o=e.target.cloneNode(!0),a="zoom-div-"+Date.now();n.id=a,n.classList.add("zoomedimage"),o.classList.remove("zoom-image"),n.appendChild(o),t.appendChild(n),n.addEventListener("click",(function(){t.removeChild(n)}))}waitForEventListener();const root=new THREE.Group;window.addEventListener("load",(function(){testInternetSpeed().then((e=>{console.log("Internet speed:",e,"Kbps"),e>=1e3?(console.log("High-speed connection detected. Load high-quality."),highSpeed=!0):(console.log("Low-speed connection detected. Load low-quality."),highSpeed=!1)})).catch((e=>{console.error("Error testing internet speed:",e)}))}));const embedId=getUrlParameter("i");var locId=getUrlParameter("loc");locId||(locId=1);const baseUri="localhost/360/",uri="i="+embedId+"&loc="+locId;var startLocX=0,startLocY=0,currentLocX=0,currentLocY=0,selectStartLocation=locId,shareLink=baseUri+"watch/?="+embedId+"&loc="+selectStartLocation+"&x="+startLocX+"&y="+startLocY,embedLink=baseUri+"embed/?="+embedId+"&loc"+selectStartLocation+"&x="+startLocX+"&y"+startLocY,setEmbedWidth="640",setEmbedHeight="480",embedIframeLink=`<iframe width="${setEmbedWidth}" height="${setEmbedHeight}" src="${embedLink}" title="360 player"></iframe>`;function updateShareLink(){shareLink=baseUri+"watch/?="+embedId+"&loc="+selectStartLocation+"&x="+startLocX+"&y="+startLocY,embedIframeLink=`<iframe width="${setEmbedWidth}" height="${setEmbedHeight}" src="${embedLink=baseUri+"embed/?="+embedId+"&loc="+selectStartLocation}" title="360 player"></iframe>`}const fileCheckData="../php/checkdata.php",fileGetData="../php/getdata.php";function buildHtml(){document.getElementById("root").innerHTML=rootHTML}function buildPasswordHtml(){document.getElementById("root").innerHTML=haspassHTML,document.querySelector("#haspass-password").focus(),document.querySelector("#enter-password").addEventListener("click",(e=>{e.preventDefault();const t=document.querySelector("#haspass-login form"),n=document.querySelector("#haspass-password").value.trim();t.insertAdjacentHTML("beforebegin",'<div class="loader"></div>');const o=document.querySelector(".loader");if(t.style.display="none",""===n)return alert("Password can not be empty."),t.style.display="block",void o.remove();if(n.length<5)return alert("Password must be 5 letters or longer."),t.style.display="block",void o.remove();xhrSend("POST","../php/checkpass.php","i="+embedId+"&loc="+locId+"&pass="+n).then((e=>{console.log(e),e.success?(document.querySelector("#haspass-login").remove(),xhrSend("POST",fileGetData,uri).then((e=>{console.log(e),overidePassword=!0,buildHtml(),start(e)})).catch((e=>{console.error("Start after password check. XHR request failed:",e)}))):setTimeout((()=>{alert("Wrong password."),t.style.display="block",o.remove()}),3e3)})).catch((e=>{console.error("Check password. XHR request failed:",e)}))}))}const parser=new DOMParser;function start(e){dataType=e.hasOwnProperty("project")?"project":"location",console.log("Data Type:",dataType),editmode&&document.querySelector("#logo").classList.add("editmode");const t="http://localhost/360/",n=document.querySelector("#root"),o=document.getElementById("view-container"),a=document.querySelector("#zoombtn"),r=document.querySelector("#zoomlevel"),i=document.querySelector("#mapbtn"),s=document.querySelector(".rightbuttons"),c=document.querySelector("#fullscreenbtn"),l=document.getElementById("locations"),d=document.getElementById("angleIndicator"),u=document.querySelector("#indicatorbtn"),m=document.querySelector("#closesharebtn"),p=document.querySelector("#share"),v=document.querySelector("#sharebtn"),y=document.querySelector("#closeinfobtn"),h=document.querySelector("#info"),f=document.querySelector("#infobtn"),g=document.querySelector("#resizer"),b=(document.querySelector("#likebtn"),document.querySelector("#commentbtn")),E=document.querySelector("#comments"),L=document.querySelector("#btn-playvideo"),S=document.querySelector("#videoplayer"),k=document.querySelector("#playvideo"),q=document.querySelector("#videoduration"),w=document.querySelector("#caption"),x=document.querySelector("#captionselect"),T=document.querySelector("#captionselect ul"),H=document.querySelector("#scrollable"),I=document.querySelector("#labels"),A=document.querySelector("#settings"),$=document.getElementById("brightness"),C=document.getElementById("contrast"),R=document.getElementById("saturation"),M=document.getElementById("ambient"),_=document.getElementById("volume"),j=document.getElementById("brightnessNo"),P=document.getElementById("contrastNo"),F=document.getElementById("saturationNo"),D=document.getElementById("ambientNo"),N=document.getElementById("volumeNo"),B=document.querySelector(".settingsbtn"),X=document.getElementById("reset"),W=document.querySelector(".closebtn"),z=document.querySelector(".show-loc"),U=document.querySelector(".show-info"),O=document.querySelector("#info-location"),Y=document.querySelector("#info-details");z.addEventListener("click",(()=>{O.style.display="block",document.querySelector("#info-location").scrollTop=0,Y.style.display="none",z.classList.add("showactive"),U.classList.remove("showactive")})),U.addEventListener("click",(()=>{Y.style.display="block",document.querySelector("#info-details").scrollTop=0,O.style.display="none",z.classList.remove("showactive"),U.classList.add("showactive")}));const G=document.querySelector(".show-link"),V=document.querySelector(".show-embed"),Q=document.querySelector("#share-link"),J=document.querySelector("#share-embed");G.addEventListener("click",(()=>{Q.style.display="block",J.style.display="none",G.classList.add("showactive"),V.classList.remove("showactive")})),V.addEventListener("click",(()=>{J.style.display="block",Q.style.display="none",G.classList.remove("showactive"),V.classList.add("showactive")}));const Z=460,K=680;let ee,te,ne,oe=!1;function ae(e,t=null){var n,o,a,r,i=e.target.closest(".edit-mc");i&&(i.getAttribute("data-id")?(o=i.getAttribute("data-id"),a="marker",n=document.querySelector('.marker-content[data-id="'+o+'"]')):(o=i.getAttribute("data-location_id"),a="info",n=document.getElementById("info-location")));if("h1"===t||"h2"===t||"p"===t||"ul"===t){let t=e.target.value.trim();if(""===t){let e=i.parentNode;return 2===e.querySelectorAll(".edit-mc").length&&(e.querySelector(".edit-mc").style.display="block"),void i.remove()}document.querySelector("#logo").classList.add("saving");var s=function(e){var t=/{([^}]*)}/g;if(!t.test(e))return e;var n=e.match(t),o="<ul>";return n.forEach((function(e){var t=e.replace(/{|}/g,"").trim();o+="<li>"+t+"</li>"})),o+="</ul>"}(t);e.target.parentNode.innerHTML=s}else if("button"===t){let t;var c=e.target.closest(".edit-mc"),l=c.querySelector(".addbuttonlink"),d=c.querySelector(".addbuttontext");if(!l||!d)return void console.log("Input elements not found");var u,m=l.value.trim(),p=d.value.trim();if(m.startsWith("http"))t="external",u=`<a href="${m}" class="button externallink" target="_blank" data-external="true">${p}</a>`;else{if(isNaN(m)||!Number.isInteger(Number(m)))return void alert("You can only have a number or start your link with http.");t="internal",u=`<div class="button gotobutton" data-order_id="${parseInt(m)}">${p}</div>`}e.target.parentNode.insertAdjacentHTML("beforeend",u),"internal"===t&&c.querySelector(".gotobutton").addEventListener("click",(e=>{let t=e.target.getAttribute("data-order_id");listItems.forEach((e=>{e.classList.remove("active")}));document.querySelector(`#locationlist [data-id="${t.toString()}"]`).classList.add("active"),ze(parseInt(t))})),e.target.parentNode.querySelectorAll("*").forEach((e=>{e.classList.contains("gotobutton")||e.classList.contains("externallink")||e.remove()}))}else if("youtube"===t){var v=e.target.value.trim();if(""===v){let e=i.parentNode;return 2===e.querySelectorAll(".edit-mc").length&&(e.querySelector(".edit-mc").style.display="block"),void i.remove()}document.querySelector("#logo").classList.add("saving");if(!/<iframe.*?src=".*?\/\/(?:www\.|)youtu(?:\.be\/|be\.com\/embed\/)([a-zA-Z0-9_-]+)(?:\?[^"]*)?".*?<\/iframe>/.test(v))return void alert("We did not recognize the embeded code as a youtube embed.");e.target.parentNode.innerHTML=v,document.querySelector("#logo").classList.add("saving")}else document.querySelector("#logo").classList.add("saving");r=n.innerHTML;let y=parser.parseFromString(r,"text/html");y.querySelectorAll(".edit-markercontent").forEach((e=>{e.parentNode.removeChild(e)})),y.querySelector(".firstedit").remove(),y.querySelectorAll(".edit-mc").forEach((e=>{e.removeAttribute("data-id"),Array.from(e.querySelectorAll("input, textarea")).some((e=>e.matches("input, textarea")))&&e.remove()})),y.querySelectorAll("span").forEach((e=>{e.remove()}));var h={type:a,id:o,html:y.body.innerHTML},f=JSON.stringify(h);xhrSend("POST","../php/savecontent.php",f).then((e=>{console.log("Content saved..."),setTimeout((()=>{document.querySelector("#logo").classList.remove("saving")}),1e3)})).catch((e=>{console.error("Saving content. XHR request failed:",e)}))}function re(e){oe=!0,ee=e.clientX||e.touches[0].clientX,te=parseInt(document.defaultView.getComputedStyle(h).width,10),document.body.addEventListener("mousemove",ie),document.body.addEventListener("touchmove",ie),document.body.addEventListener("mouseup",se),document.body.addEventListener("touchstart",se),document.body.addEventListener("selectend",se)}function ie(e){if(!oe)return;const t=e.clientX||e.touches[0].clientX;let n=te-(t-ee);n=Math.max(Z,Math.min(K,n)),h.style.width=n+"px"}function se(){oe=!1,document.removeEventListener("mousemove",ie),document.removeEventListener("touchmove",ie),document.removeEventListener("mouseup",se),document.removeEventListener("touchstart",se),document.removeEventListener("selectend",se)}function ce(){if(0===parseFloat(l.style.bottom)){let e=l.getBoundingClientRect().height;l.style.bottom="-"+e+"px",u.classList.remove("rotate180")}else u.classList.add("rotate180"),l.style.bottom="0"}function le(){l.style.opacity="1",d.style.opacity="1",B.style.opacity="1",a.style.opacity="1",i.style.opacity="1",s.style.opacity="1"}function de(){l.style.opacity="0",d.style.opacity="0",B.style.opacity="0",a.style.opacity="0",i.style.opacity="0",s.style.opacity="0"}function ue(){clearTimeout(ne),"1"!==a.style.opacity&&le(),ne=setTimeout((()=>{de()}),7e3)}function me(){A.style.right="0px",B.style.opacity="0"}g.addEventListener("mousedown",re),g.addEventListener("touchstart",re),g.addEventListener("selectstart",re),u.addEventListener("click",ce),u.addEventListener("touchstart",ce),u.addEventListener("selectend",ce),le(),document.addEventListener("keydown",(e=>{if("h"===e.key||"H"===e.key){const e=document.querySelector("#view-container"),t=document.querySelector("#outside"),n=document.querySelectorAll("input, textarea");let o=!1;if(n.forEach((e=>{e.contains(document.activeElement)&&(o=!0)})),o)return;"none"===e.style.display?(e.style.display="block",t.style.display="block"):(e.style.display="none",t.style.display="none")}})),ne=setTimeout((()=>{de()}),7e3),document.addEventListener("mousemove",(function(e){ue()})),document.addEventListener("touchmove",(function(e){ue()})),B.addEventListener("click",me),B.addEventListener("touchstart",me),B.addEventListener("selectstart",me);const pe=document.querySelector("#locationlist");e.locations.forEach((e=>{pe.insertAdjacentHTML("afterbegin","<li></li>")})),"project"===dataType&&e.project&&!0===e.project.showlocations||document.querySelector("#indicatorbtn").remove();let ve=75;const ye=new THREE.Scene,he=new THREE.PerspectiveCamera(ve,window.innerWidth/window.innerHeight,.1,1e3),fe=new THREE.WebGLRenderer({alpha:!1});fe.setSize(window.innerWidth,window.innerHeight),fe.setClearColor(0),n.appendChild(fe.domElement);const ge=new CSS2DRenderer;ge.setSize(window.innerWidth,window.innerHeight),ge.domElement.style.position="absolute",ge.domElement.style.top="0px",ge.domElement.style.pointerEvents="none",n.appendChild(ge.domElement);const be=new OrbitControls(he,fe.domElement);be.enablePan=!1,be.enableDamping=!0,be.dampingFactor=.05,be.rotateSpeed=-1,be.autoRotate=!1,be.autoRotateSpeed*=.25,he.position.set(0,0,0),he.rotation.order="YXZ";Ye(new THREE.Vector3(0,0,0),(new THREE.Quaternion).setFromEuler(new THREE.Euler(0,150,0))),be.minDistance=30,be.maxDistance=280,be.zoomSpeed=3;const Ee=document.createElement("video");let Le,Se,ke;const qe=new THREE.SphereGeometry(360,180,180),we=new THREE.DataTexture(new Uint8Array([0,0,0]),1,1,THREE.RGBFormat);we.needsUpdate=!0;const xe=new THREE.MeshStandardMaterial({map:we,side:THREE.DoubleSide}),Te=new THREE.Mesh(qe,xe);ye.add(Te),ye.add(root);let He,Ie=4;function Ae(e){Ie=e,He&&ye.remove(He),He=new THREE.AmbientLight(16777215,e),ye.add(He)}function $e(){fe.render(ye,he),ge.render(ye,he)}function Ce(){requestAnimationFrame(Ce),be.update(),$e();const e=-Math.atan2(he.position.x,he.position.z);d.style.transform=`translate(-50%, -50%) rotate(${e}rad)`}function Re(e,t){const n=t.getViewerPose();if(n){const e=n.views;for(let t of e){const e=xrLayer.getViewport(t),n=t.projectionMatrix;fe.setViewport(e.x,e.y,e.width,e.height),fe.setProjectionMatrix(n),fe.render(ye,he)}}t.session.requestAnimationFrame(Re)}Ae(3.5),"xr"in navigator?(console.log("WebXR is supported in this browser."),"requestDevice"in navigator.xr?navigator.xr.requestDevice().then((e=>{console.log("XR device obtained:",e),e.requestSession({immersive:!0}).then((e=>{console.log("XR session started:",e);const t=fe.getContext(),n=new XRWebGLLayer(e,t);e.updateRenderState({baseLayer:n}),e.requestAnimationFrame(Re)})).catch((e=>{console.error("Failed to start XR session:",e),Ce()}))})).catch((e=>{console.error("Failed to obtain XR device:",e),Ce()})):"requestSession"in navigator.xr?navigator.xr.requestSession("immersive-vr").then((e=>{console.log("XR session started:",e);const t=fe.getContext(),n=new XRWebGLLayer(e,t);e.updateRenderState({baseLayer:n}),e.requestAnimationFrame(Re)})).catch((e=>{console.error("Failed to start XR session:",e),Ce()})):(console.error("WebXR APIs are present, but neither requestDevice nor requestSession methods are available."),Ce())):(console.log("WebXR not supported in this browser."),Ce());let Me="";console.log("Render locations list for project...");for(let vt=0;vt<e.locations.length;vt++){const yt=e.locations[vt];let ht=0===vt&&"video"===yt.file_type?"active":"",ft=yt.file_name.replace(/\.\w+$/,".jpg");if("video"===yt.file_type){sceneType="video";const gt=ft.split(".").slice(0,-1).join(".");Me+=`<li class="${ht}" data-file="${yt.file_name}" data-id="${yt.id}" data-order_index="${yt.order_index}" data-type="${yt.file_type}">\n                            <span class="icon-video">${yt.duration}</span>\n                            <div>${yt.location_title}</div>\n                            <img src="${t}video/${gt}-low.jpg" alt="" />\n                        </li>`}else{sceneType="image";const bt=yt.file_name.split(".").slice(0,-1).join(".");Me+=`<li class="${ht}" data-file="${yt.file_name}" data-id="${yt.id}" data-order_index="${yt.order_index}" data-type="${yt.file_type}">\n                            <div>${yt.location_title}</div>\n                            <img src="${t}img/${bt}-low.jpg" alt="" />\n                        </li>`}}function _e(e){listItems.forEach((e=>{e.classList.remove("active")})),e.classList.add("active");const t=e.getAttribute("data-order_index");ze(parseInt(t))}document.querySelector("#locationlist").innerHTML=Me,(listItems=document.querySelectorAll("#locationlist li")).forEach((e=>{e.addEventListener("click",(function(){_e(e)})),e.addEventListener("touchstart",(function(){_e(e)})),e.addEventListener("selectend",(function(){_e(e)}))})),function t(){const n=document.querySelector("#locations .container ul li:first-child");if(n)if(locId>e.locations.length){const t=e.locations[0].order_index;ze(parseInt(t)),n.classList.add("active")}else{document.querySelector(`#locations .container ul li[data-order_index='${locId}']`).classList.add("active"),ze(parseInt(locId))}else setTimeout(t,1e3)}();document.querySelectorAll(".startlocations").forEach((n=>{var o="";e.locations.map((e=>{const n=e.file_name.replace(/\.\w+$/,".jpg").split(".").slice(0,-1).join("."),a="video"===e.file_type?"video":"img";o+=`<div class="start-location" data-id="${e.id}" data-order_index="${e.order_index}">\n\t\t\t\t\t<h5 class="title">${e.location_title}</h5>\n\t\t\t\t\t<div class="locimage">\n\t\t\t\t\t\t<img src="${t}${a}/${n}-low.jpg" alt="" />\n\t\t\t\t\t</div>\n\t\t\t\t</div>`})),n.innerHTML=o}));const je=document.querySelector("#linktoshare"),Pe=document.querySelector("#embedcode"),Fe=document.querySelectorAll(".start-location");e.locations.length<locId&&(selectStartLocation=1),Fe.forEach((e=>{e.addEventListener("click",(()=>{Fe.forEach((e=>{e.classList.remove("active")}));const t=e.getAttribute("data-order_index");Array.from(Fe).filter((function(e){return e.getAttribute("data-order_index")===t})).forEach((e=>{e.classList.add("active")})),selectStartLocation=t,updateShareLink(),je.querySelector("span").textContent=shareLink,Pe.querySelector("textarea").textContent=embedIframeLink}))})),document.querySelectorAll('.start-location[data-order_index="'+selectStartLocation+'"]').forEach((e=>{e.classList.add("active")})),updateShareLink(),je.querySelector("span").textContent=shareLink,Pe.querySelector("textarea").textContent=embedIframeLink;const De=document.querySelector("#copylink"),Ne=document.querySelector("#copyembed");function Be(){const e=THREE.MathUtils.degToRad(currentLocX),t=THREE.MathUtils.degToRad(currentLocY);he.position.set(e,t,he.position.z),he.rotation.set(e,t,he.position.z),he.lookAt(ye.position),he.updateProjectionMatrix()}function Xe(e){e.preventDefault();const t=e.target.getAttribute("data-order_index");ze(parseInt(t))}function We(e){if(!e.target.closest(".marker-container")){e.preventDefault();let t=e.target,n=t.querySelector(".hint"),o=t.querySelector(".marker-container");if("none"===getComputedStyle(o).display){if(t.classList.add("markeron"),o.style.display="block",o){o.querySelector(".marker-content").scrollTop=0;let e=o.querySelector(".soundplay");if(e){if("true"===e.getAttribute("data-autoplay")){let t=e.querySelector("audio");t&&(t.paused||(t.pause(),t.currentTime=0),t.play())}}}n.style.display="none"}else t.classList.remove("markeron"),o.style.display="none",n.style.display="block"}}function ze(n){it(),ot(),rt(),L.style.display="none",S.style.display="none";let o=document.querySelectorAll(".intlink"),a=document.querySelectorAll(".infodot");o.forEach((e=>{e.removeEventListener("click",Xe)})),a.forEach((e=>{e.removeEventListener("click",We)}));let r,i=document.querySelectorAll(".zoom-image");i.forEach((e=>{e.removeEventListener("click",imageClickHandler)})),I.innerHTML="",h.classList.remove("infoshow"),r="project"===dataType&&e.project?e.locations.find((e=>e.order_index===n)):e.locations[0];let s=r.embed_id;document.querySelector("#commentbtn").setAttribute("data-embedid",s);let c=r.file_name,l=r.file_type,d=r.info;markerData=r.markers,root.clear();const u=document.querySelector(".show-loc"),m=document.querySelector(".show-info");if(""!==markerData&&null!=markerData&&(console.log("Creating markers..."),async function(e){return new Promise((t=>{if(0===e.length)return void t();let n=0;const o=()=>{let o=document.querySelectorAll(".intlink"),r=document.querySelectorAll(".infodot");(o.length>0||r.length>0)&&(clearInterval(a),o.length>0&&o.forEach((e=>{e.addEventListener("click",Xe)})),r.length>0&&r.forEach((e=>{e.addEventListener("click",We)})),n===e.length&&t())};o();const a=setInterval(o,50);e.forEach(((e,t)=>{const{id:o,marker_title:a,pos_x:r,pos_y:i,pos_z:s,info:c,link:l,sound:d,autoplay:u,customcss:m}=e,p=new THREE.Vector3(r,i,s);let v=`<span class="hint">${a}</span>`;if("string"!=typeof l||""===l||isNaN(l))if("string"==typeof l&&""!==l)(marker=document.createElement("a")).href=l,marker.target="_blank",marker.classList.add("extlink"),marker.innerHTML=v;else{(marker=document.createElement("div")).classList.add("infodot");let e=v+`<div class="marker-container" data-id="${o}"><div class="marker-content" data-id="${o}"></div>`;marker.innerHTML=e;let n=marker.querySelector(".marker-content");n.insertAdjacentHTML("afterbegin",c);let a=marker.querySelector(".marker-container");if(editmode){let e=n.querySelectorAll(".edit-mc"),t='<div class="edit-mc firstedit"';e.length>0&&(t+=' style="display:none"'),t+="></div>",n.insertAdjacentHTML("afterbegin",t),e=n.querySelectorAll(".edit-mc"),e.forEach((e=>{e.setAttribute("data-id",o);let t='<div class="edit-markercontent">\n\t\t\t\t\t\t\t<div class="btn-add-h1">H1</div>\n\t\t\t\t\t\t\t<div class="btn-add-h2">H2</div>\n\t\t\t\t\t\t\t<div class="btn-add-p"></div>\n\t\t\t\t\t\t\t<div class="btn-add-image"></div>\n\t\t\t\t\t\t\t<div class="btn-add-ul"></div>\n\t\t\t\t\t\t\t<div class="btn-add-button"></div>\n\t\t\t\t\t\t\t<div class="btn-add-youtube"></div>\n\t\t\t\t\t\t\t<div class="btn-add-audio"></div>\n\t\t\t\t\t\t\t<div class="btn-content-edit"></div>\n\t\t\t\t\t\t\t<div class="btn-remove"></div>\n\t\t\t\t\t\t</div>';e.insertAdjacentHTML("afterbegin",t)}))}let r="";null!==d&&""!==d&&(r+='<div class="soundplay"',r+=u?` data-autoplay="${u}">`:">",editmode&&(r+=`<div class="btn-content-edit" data-id=${o}></div>\n\t\t\t\t\t\t\t<div class="btn-remove" data-id=${o}></div>`),r+=`<audio controls id="audio${t}">\n\t\t\t\t\t\t\t\t\t<source src="../sound/${d}" type="audio/mpeg">\n\t\t\t\t\t\t\t\t</audio>\n\t\t\t\t\t\t\t</div>`,a.insertAdjacentHTML("afterbegin",r))}else(marker=document.createElement("div")).dataset.id=parseInt(o),marker.dataset.order_index=parseInt(l),marker.classList.add("intlink"),marker.innerHTML=v;marker.classList.add("marker");let y=t;if(marker.id="marker"+y,""!==m&&null!==m){var h=JSON.parse(m),f="";h.forEach(((e,t)=>{f+="#marker"+y+e,t!==h.length-1&&(f+=" ")}));var g=document.querySelector("style[data-customcss]");if(g)g.textContent+=f;else{var b=document.createElement("style");b.textContent=f,b.setAttribute("data-customcss",""),document.head.appendChild(b)}}if(editmode){let e=`<div class="edit-marker" data-id="${o}">\n\t\t\t\t\t\t<div class="btn-marker-edit" data-id="${o}"></div>\n\t\t\t\t\t\t<div class="btn-marker-move" data-id="${o}"></div>\n\t\t\t\t\t\t<div class="btn-marker-delete" data-id="${o}"></div>\n\t\t\t\t\t</div>`;marker.insertAdjacentHTML("beforeend",e)}const E=new CSS2DObject(marker);E.position.copy(p),root.add(E),n++})),he.position.set(360,0,0),he.rotation.set(360,0,0),he.lookAt(ye.position),he.updateProjectionMatrix(),he.position.x=-360,he.rotation.x=-360,he.lookAt(ye.position),he.updateProjectionMatrix(),$e(),console.log("Markers added to root.")}))}(markerData).then((()=>{setTimeout((()=>{i=document.querySelectorAll(".zoom-image"),i.forEach((e=>{e.addEventListener("click",imageClickHandler)})),console.log("Added eventlistener to images..."),console.log("Markers created.")}),100)}))),"video"===l){if(Le===c)return;sceneType="video";let j=c;Se="",Te.material.map=null,Ee.pause(),Ee.src="",Le="";const P=c.split(".").slice(0,-1).join(".");if(highSpeed||(j=P+"-low.mp4",function(e,n){const o=document.createElement("video");o.src=t+"video/"+n,o.addEventListener("canplay",(function(){const t=setInterval((function(){if(4===o.readyState){clearInterval(t),e.pause();let n=e.currentTime;e.src="",e.src=o.src,e.currentTime=n,e.play(),console.log("High-quality video loaded and switched.")}}),100)}))}(Ee,c)),Ee.src=t+"video/"+j,Ee.load(),Ee.crossOrigin="anonymous",Ee.loop=!0,Ee.playsInline=!0,Le=c,""!==r.captions){x.style.display="block";const D=document.querySelector("#captionselect ul");let N="";r.captions.forEach((e=>{N+=`<li data-caption="${e.caption_language}" data-id="${r.id}">${e.caption_language}</li>`})),N+='<li id="captionoff" class="active">Captions off</li>',D.innerHTML=N;const B=document.querySelectorAll("#captionselect ul li");function p(n){const o=n.target.getAttribute("data-id");e.locations.find((e=>e.id===parseInt(o)));const a=n.target.getAttribute("data-caption"),r=c.split(".").slice(0,-1).join("."),i=`${t}video/${r}-${a}.srt`;console.log(i),w.style.display="block",B.forEach((e=>{e.classList.remove("active")})),n.target.classList.add("active"),x.classList.add("on"),fetch(i).then((e=>e.blob())).then((e=>{!function(e){const t=new FileReader;t.onload=function(e){const t=function(e){const t=e.trim().split(/\r?\n/),n=[];let o={};for(let e=0;e<t.length;e++){const a=t[e].trim();if(a)if(o.id)if(o.start)o.text?(n.push(o),o={}):o.text=a;else{const e=a.split(" --\x3e ");if(2!==e.length){o={};continue}o.start=pt(e[0]),o.end=pt(e[1])}else o.id=parseInt(a)}return console.log(n),n}(e.target.result);console.log(t),function(e){Ee.addEventListener("timeupdate",(function(){const t=Ee.currentTime,n=document.getElementById("caption");for(const o of e)if(t>=o.start&&t<=o.end)return void(n.innerHTML=`<p>${o.text}</p>`);n.innerHTML=""}))}(t)},t.readAsText(e)}(e)})).catch((e=>{console.error("Error fetching or converting SRT file:",e)}))}B.forEach((e=>{e.addEventListener("click",p),e.addEventListener("touchstart",p),e.addEventListener("selectstart",p)}));const X=document.querySelector("#captionoff");function v(){B.forEach((e=>{e.classList.remove("active")})),X.classList.add("active"),x.classList.remove("on"),w.style.display="none"}X.addEventListener("click",v),X.addEventListener("touchstart",v),X.addEventListener("selectstart",v)}else x.style.display="none";function y(){"none"===T.style.display?T.style.display="block":T.style.display="none"}function f(){k.classList.contains("playing")?(k.classList.remove("playing"),Ee.pause()):(k.classList.add("playing"),Ee.play())}k.classList.add("playing"),x.addEventListener("click",y),x.addEventListener("touchstart",y),x.addEventListener("selectstart",y),k.addEventListener("click",f),k.addEventListener("touchstart",f),k.addEventListener("selectstart",f);const F=document.querySelector("#currenttime");function g(){const e=parseFloat(q.value);Ee.currentTime=e*Ee.duration;const t=E(Ee.currentTime);F.textContent=t}function b(){Ee.removeEventListener("timeupdate",(()=>{})),g()}function E(e){const t=Math.floor(e/3600),n=Math.floor(e%3600/60),o=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}Ee.addEventListener("timeupdate",(()=>{const e=Ee.currentTime/Ee.duration;q.value=e.toFixed(2);const t=E(Ee.currentTime);F.textContent=t})),q.addEventListener("input",g),q.addEventListener("mousedown",b),q.addEventListener("touchstart",b),q.addEventListener("selectstart",b),userInteracted?(S.style.display="flex",Ee.play()):L.style.display="block",ke=new THREE.VideoTexture(Ee),ke.encoding=THREE.LinearEncoding,ke.needsUpdate=!0,ke.wrapS=THREE.RepeatWrapping,ke.repeat.x=-1,ke.mapping=THREE.UVMapping,ke.encoding=THREE.sRGBEncoding,ke.gammaFactor=2.2,Te.material.map=ke,Te.material.needsUpdate=!0}else if("image"===l){if(Se===c)return;sceneType="image",S.style.display="none",Te.material.map=null,Ee.pause(),Ee.src="",Le="";const W=c.split(".").slice(0,-1).join(".");let z=t+"img/"+c;highSpeed||(z=t+"img/"+W+"-low.jpg");const U=(new THREE.TextureLoader).load(`${z}`,(function(e){e.wrapS=THREE.RepeatWrapping,e.repeat.x=-1,e.mapping=THREE.UVMapping,e.encoding=THREE.sRGBEncoding,e.gammaFactor=2.2}));if(Te.material.map=U,Te.material.needsUpdate=!0,!highSpeed){!function(e,t){const n=new Image;n.src=e,n.onload=function(){const e=new THREE.Texture(n);e.needsUpdate=!0,e.wrapS=THREE.RepeatWrapping,e.repeat.x=-1,e.mapping=THREE.UVMapping,e.encoding=THREE.sRGBEncoding,e.gammaFactor=2.2,t(e)}}(t+"img/"+c,(function(e){Te.material.map=e,Te.material.needsUpdate=!0}))}Se=c,console.log("Image type done...")}else console.log("Invalid file type");let H=document.querySelector("#likebtn");const A=H.cloneNode(!0);if(H.parentNode.replaceChild(A,H),A.querySelector(".amount").textContent=formatNumber(r.likes_count),A.setAttribute("data-id",r.id),A.classList.remove("liked"),r.has_liked&&A.classList.add("liked"),""!==d&&null!=d?(O.style.display="block",O.innerHTML=d,u.style.display="block",u.classList.add("showactive"),m.classList.remove("showactive")):(O.style.display="none",u.style.display="none",m.classList.add("showactive")),editmode){let Y=O.querySelectorAll(".edit-mc"),G='<div class="edit-mc firstedit"';Y.length>0&&(G+=' style="display:none"'),G+="></div>",O.insertAdjacentHTML("afterbegin",G),Y=O.querySelectorAll(".edit-mc"),Y.forEach((function(e){e.setAttribute("data-location_id",r.id);e.insertAdjacentHTML("afterbegin",'<div class="edit-markercontent">\n\t\t\t\t\t\t\t<div class="btn-add-h1">H1</div>\n\t\t\t\t\t\t\t<div class="btn-add-h2">H2</div>\n\t\t\t\t\t\t\t<div class="btn-add-p"></div>\n\t\t\t\t\t\t\t<div class="btn-add-image"></div>\n\t\t\t\t\t\t\t<div class="btn-add-ul"></div>\n\t\t\t\t\t\t\t<div class="btn-add-button"></div>\n\t\t\t\t\t\t\t<div class="btn-add-youtube"></div>\n\t\t\t\t\t\t\t<div class="btn-content-edit"></div>\n\t\t\t\t\t\t\t<div class="btn-remove"></div>\n\t\t\t\t\t\t</div>')}))}else{document.querySelectorAll(".edit-mc").forEach((e=>{e.classList.add("contain-html"),e.classList.remove("edit-mc")}))}function $(e){let t=e.target.closest(".edit-mc"),n=t.parentNode;if(2===n.querySelectorAll(".edit-mc").length){n.querySelector(".firstedit").style.display="block"}t.remove(),ae(e)}function C(e,t){let n,o,a,r=e.target.closest(".edit-mc"),i=r.getAttribute("data-id");null==i?(i=r.getAttribute("data-location_id"),o=`data-location_id="${i}"`,a=!0):(o=`data-id="${i}"`,a=!1),"h1"===t?n=`<div class="edit-mc" ${o}><h1><textarea class="editheader" type="text" placeholder="Header 1"></textarea></h1></div>`:"h2"===t?n=`<div class="edit-mc" ${o}><h2><textarea class="editheader2" type="text" placeholder="Header 2"></textarea></h2></div>`:"p"===t?n=`<div class="edit-mc" ${o}><p><textarea class="editp" type="text" placeholder="Write text here..."></textarea></p></div>`:"image"===t?n=`<div class="edit-mc" ${o}>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<input type="text" class="editimage" placeholder="https://pathtoimage.com" />\n\t\t\t\t\t\t<div class="dropzone" id="dropzone">\n\t\t\t\t\t\t\t<div class="button-wrap">\n\t\t\t\t\t\t\t\t<label class="button" for="upload">Drop/Select Image</label>\n\t\t\t\t\t\t\t\t<input type="file" id="imageInput" class="imageInput" accept="image/*">\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="button addimagesave">Save</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>`:"ul"===t?n=`<div class="edit-mc" ${o}><p><span>"Enclose each list item within curly braces. For example: {This is line one}"</span><textarea class="editul" type="text" placeholder="Example: {This is line one}"></textarea></p></div>`:"button"===t?n=`<div class="edit-mc" ${o}><div><span>Enter an external link beginning with 'http' or type the location's order number to navigate within your project.</span><input class="editbutton addbuttonlink" type="text" placeholder="https://example.com/externallink" /><input class="editbutton addbuttontext" type="text" placeholder="Button text" /><div class="button addbuttonsave">Save</div></div></div>`:"youtube"===t&&(n=`<div class="edit-mc" ${o}><div><span>Paste your youtube embed code into the textarea.</span><textarea class="edityoutube" type="text" placeholder="Paste your Youtube embed code here..."></textarea></div></div>`),r.insertAdjacentHTML("afterend",n);let s='<div class="edit-markercontent">\n\t\t\t\t\t\t\t<div class="btn-add-h1">H1</div>\n\t\t\t\t\t\t\t<div class="btn-add-h2">H2</div>\n\t\t\t\t\t\t\t<div class="btn-add-p"></div>\n\t\t\t\t\t\t\t<div class="btn-add-image"></div>\n\t\t\t\t\t\t\t<div class="btn-add-ul"></div>\n\t\t\t\t\t\t\t<div class="btn-add-button"></div>\n\t\t\t\t\t\t\t<div class="btn-add-youtube"></div>';a||(s+='<div class="btn-add-audio"></div>'),s+='<div class="btn-content-edit"></div>\n\t\t\t\t\t\t\t<div class="btn-remove"></div>\n\t\t\t\t\t\t</div>';let c=r.nextElementSibling;if(c.insertAdjacentHTML("afterbegin",s),"h1"===t||"h2"===t||"p"===t||"ul"===t||"youtube"===t)c.querySelector("textarea").addEventListener("blur",(e=>{ae(e,t)}));else if("button"===t)c.querySelector(".addbuttonsave").addEventListener("click",(e=>{let n=e.target.closest(".edit-mc"),o=n.querySelector(".addbuttonlink"),a=n.querySelector(".addbuttontext"),r=o.value;""!==a.value&&""!==r?r.startsWith("http")||!isNaN(parseInt(r))?ae(e,t):alert("You can only write a http link or a number."):alert("Please provide both button text and a valid link. Use 'http' for external links or a location order number for internal navigation.")}));else if("image"===t){const d=c.querySelector(".dropzone"),u=c.querySelector(".imageInput");function l(e){for(const t of e)if(t.type.startsWith("image/")){const e=new FileReader;e.readAsDataURL(t),e.onload=function(){const t=document.createElement("div");t.classList.add("new-image"),u.style.display="none";const n=new Image;n.src=e.result,n.style.maxWidth="100%";const o=document.createElement("button");o.addEventListener("click",(function(){t.remove(),u.style.display="block"})),t.appendChild(n),t.appendChild(o),d.appendChild(t)}}else alert("Please drop only image files.")}d.addEventListener("dragover",(e=>{e.preventDefault(),d.classList.add("dragover")})),d.addEventListener("dragleave",(()=>{d.classList.remove("dragover")})),d.addEventListener("drop",(e=>{e.preventDefault(),d.classList.remove("dragover");l(e.dataTransfer.files)})),u.addEventListener("change",(e=>{l(e.target.files)}))}"h1"===t||"h2"===t||"p"===t||"ul"===t||"youtube"===t?c.querySelector("textarea").focus():"button"===t?c.querySelector("input").focus():"image"===t&&c.querySelector(".editimage").focus(),c.querySelector(".btn-add-h1").addEventListener("click",(e=>C(e,"h1"))),c.querySelector(".btn-add-h2").addEventListener("click",(e=>C(e,"h2"))),c.querySelector(".btn-add-p").addEventListener("click",(e=>C(e,"p"))),c.querySelector(".btn-add-image").addEventListener("click",(e=>C(e,"image"))),c.querySelector(".btn-add-ul").addEventListener("click",(e=>C(e,"ul"))),c.querySelector(".btn-add-button").addEventListener("click",(e=>C(e,"button"))),c.querySelector(".btn-add-youtube").addEventListener("click",(e=>C(e,"youtube"))),c.querySelector(".btn-remove").addEventListener("click",(e=>$(e))),r.classList.value.includes("firstedit")&&(r.style.display="none")}function R(e){let t=e.target.getAttribute("data-order_id");listItems.forEach((e=>{e.classList.remove("active")}));const n=document.querySelector(`#locationlist [data-id="${t.toString()}"]`);console.log(n),n.classList.add("active"),ze(parseInt(t))}document.querySelectorAll(".btn-add-h1").forEach((e=>{e.addEventListener("click",(e=>C(e,"h1")))})),document.querySelectorAll(".btn-add-h2").forEach((e=>{e.addEventListener("click",(e=>C(e,"h2")))})),document.querySelectorAll(".btn-add-p").forEach((e=>{e.addEventListener("click",(e=>C(e,"p")))})),document.querySelectorAll(".btn-add-image").forEach((e=>{e.addEventListener("click",(e=>C(e,"image")))})),document.querySelectorAll(".btn-add-ul").forEach((e=>{e.addEventListener("click",(e=>C(e,"ul")))})),document.querySelectorAll(".btn-add-button").forEach((e=>{e.addEventListener("click",(e=>C(e,"button")))})),document.querySelectorAll(".btn-add-youtube").forEach((e=>{e.addEventListener("click",(e=>C(e,"youtube")))})),document.querySelectorAll(".btn-remove").forEach((e=>{e.addEventListener("click",(e=>$(e)))})),document.querySelectorAll(".gotobutton").forEach((e=>{e.removeEventListener("click",R),e.addEventListener("click",R)})),console.log("Added events to all goto buttons..."),A.addEventListener("click",(function(){let e=A.classList.toggle("liked"),t=A.querySelector(".amount"),n=parseInt(t.textContent.trim());n+=e?1:-1,t.textContent=formatNumber(n)}));const M=document.querySelector(".user-details .userinfo a");M.textContent=e.user.username,M.href="https://yourwebsite.com/profile/"+e.user.username;const _=document.querySelector(".user-details .thumbnail");_.href="https://yourwebsite.com/profile/"+e.user.username;_.querySelector("img").src=e.user.thumbnail,document.querySelector("#info-details .title").textContent=r.location_title,document.querySelector("#info-details .description").textContent=r.location_description,document.querySelector(".details-likes span").textContent=formatNumber(r.likes_count),document.querySelector(".details-views span").textContent=formatNumber(r.views_count),document.querySelector(".details-created span").textContent=r.registered,document.querySelector(".details-comments span").textContent=formatNumber(r.total_comments),document.querySelector("#commentbtn .amount").textContent=formatNumber(r.total_comments),he.updateProjectionMatrix(),console.log("End of the content creation function...")}De.addEventListener("click",(()=>{copyToClipboard("#linktoshare span")})),Ne.addEventListener("click",(()=>{copyToClipboard("#embedcode textarea")})),document.querySelector("#lookatx").addEventListener("change",(e=>{startLocX=parseInt(e.target.value),currentLocX=parseInt(e.target.value),updateShareLink(),Be(),je.querySelector("span").textContent=shareLink,Pe.querySelector("textarea").textContent=embedIframeLink})),document.querySelector("#lookaty").addEventListener("change",(e=>{startLocY=parseInt(e.target.value),currentLocY=parseInt(e.target.value),updateShareLink(),Be(),je.querySelector("span").textContent=shareLink,Pe.querySelector("textarea").textContent=embedIframeLink})),userInteracted||L.addEventListener("click",(()=>{userInteracted=!0,S.style.display="flex",Ee.play(),L.style.display="none"}));parseFloat(r.value);document.addEventListener("wheel",(function(e){if(function(e){if(e&&e.target){const t=e.target;return null!==t.closest("#scrollable")||null!==t.closest("#info")||null!==t.closest(".marker-container")||null!==t.closest("#comments")||null!==t.closest("#music")||null!==t.closest("#share")}return!1}(e))return;const t=.1*e.deltaY,n=-be.object.position.length();be.rotateSpeed=.005*n,ve+=.1*t,ve=Math.max(10,Math.min(90,ve)),he.aspect=window.innerWidth/window.innerHeight,he.fov=ve,he.updateProjectionMatrix(),r.value=(ve-10)/80})),r.addEventListener("input",(function(){const e=parseFloat(r.value),t=10+80*e,n=be.maxDistance,o=be.minDistance,a=o+e*(n-o);he.fov=t,he.maxDistance=a,he.updateProjectionMatrix()})),d.textContent="↑",o.appendChild(d),d.addEventListener("click",(()=>{Ye()}));he.rotation.clone(),he.position.clone();const Ue=new THREE.Vector3(0,0,0),Oe=(new THREE.Quaternion).setFromEuler(new THREE.Euler(0,0,0));function Ye(e=Ue,t=Oe){const n=(new THREE.Quaternion).setFromEuler(he.rotation.clone()),o=(new THREE.Quaternion).setFromEuler(t),a=he.position.clone(),r=e.clone(),i=performance.now();!function e(){const t=performance.now()-i,s=Math.min(t/1e3,1);he.quaternion.slerpQuaternions(n,o,s),he.position.lerpVectors(a,r,s),be.target.copy(he.position).add(new THREE.Vector3(0,0,-1).applyQuaternion(he.quaternion));const c=-Math.atan2(he.position.x,he.position.z);d.style.transform=`translate(-50%, -50%) rotate(${c}rad)`,t<1e3&&requestAnimationFrame(e)}()}function Ge(){document.fullscreenElement?document.exitFullscreen&&(c.classList.remove("fullscreen"),document.exitFullscreen(),n.classList.remove("rootfullscreen")):(document.documentElement.requestFullscreen(),c.classList.add("fullscreen"),n.classList.add("rootfullscreen"))}c.addEventListener("click",Ge),c.addEventListener("touchstart",Ge),c.addEventListener("selectstart",Ge),window.addEventListener("resize",(function(e){if(he.aspect=window.innerWidth/window.innerHeight,he.updateProjectionMatrix(),fe.setSize(window.innerWidth,window.innerHeight),ge.setSize(window.innerWidth,window.innerHeight),fe.setPixelRatio(window.devicePixelRatio),$e(),0!==l.style.bottom){let e=l.getBoundingClientRect().height;l.style.bottom="-"+e+"px"}ut()})),H.addEventListener("wheel",(function(e){e.preventDefault();const t=e.deltaY;H.scrollLeft+=t}));let Ve,Qe,Je=!1;function Ze(){Je=!1,H.style.cursor="grab"}function Ke(e){if(!Je)return;const t=3*(e.pageX-H.offsetLeft-Ve);H.scrollLeft=Qe-t}function et(){document.getElementsByTagName("canvas")[0].style.filter="contrast(1) brightness(1) saturate(1)",M.value="3.5",D.textContent="3.5",Ae(3.5),$.value="1",j.textContent="1",C.value="1",P.textContent="1",R.value="1",F.textContent="1",_.value="1",N.textContent="1",Ee.volume="1"}function tt(){B.style.opacity="1",A.style.right="-640px"}function nt(){f.style.opacity="0",h.classList.add("infoshow"),document.querySelector("#info-location").scrollTop=0}function ot(){f.style.opacity="1",h.classList.remove("infoshow")}function at(){v.style.opacity="0",p.classList.add("infoshow")}function rt(){v.style.opacity="1",p.classList.remove("infoshow")}function it(){let e=document.querySelector("#commentbtn"),t=document.querySelector("#commentInputField");t&&(t.blur(),t.placeholder="Write your comment"),e.style.opacity="1";document.querySelector("#comments").innerHTML="",E.classList.remove("commentshow")}function st(){let e="i="+document.querySelector("#commentbtn").getAttribute("data-embedid");console.log("Comments URI:",e),xhrSend("POST","../php/getcomments.php",e).then((e=>{if(e){console.log(e),buildComments(e,e.creator,e.user),document.querySelector("#commentbtn .amount").textContent=e.total_comments;const t=document.querySelector("#closecommentsbtn");b.style.opacity="0",E.classList.add("commentshow"),document.querySelector("#commentInputField").focus(),t.removeEventListener("click",it),t.removeEventListener("touchstart",it),t.removeEventListener("selectstart",it),t.addEventListener("click",it),t.addEventListener("touchstart",it),t.addEventListener("selectstart",it)}else console.log("fail")})).catch((e=>{console.error("Get comments. XHR request failed:",e)}))}H.addEventListener("mousedown",(function(e){e.preventDefault(),Je=!0,Ve=e.pageX-H.offsetLeft,Qe=H.scrollLeft,H.style.cursor="grabbing"})),H.addEventListener("touchstart",(function(e){e.preventDefault(),Je=!0,Ve=e.pageX-H.offsetLeft,Qe=H.scrollLeft,H.style.cursor="grabbing"})),H.addEventListener("mouseup",Ze),H.addEventListener("touchstart",Ze),H.addEventListener("mouseleave",Ze),H.addEventListener("mousemove",(e=>{Ke(e)})),H.addEventListener("touchmove",(e=>{Ke(e)})),_.addEventListener("input",(()=>{const e=_.value;Ee.volume=e,document.querySelectorAll("audio").forEach((t=>{t.volume=e})),N.textContent=e})),M.addEventListener("input",(()=>{const e=M.value;Ae(e),D.textContent=e})),$.addEventListener("input",(()=>{const e=document.getElementsByTagName("canvas")[0],t=e.style.filter||"contrast(1) brightness(1) saturate(1)",n=parseFloat(t.match(/contrast\((\d+(\.\d+)?)\)/)[1]),o=parseFloat(t.match(/saturate\((\d+(\.\d+)?)\)/)[1]),a=$.value;e.style.filter=`contrast(${n}) brightness(${a}) saturate(${o})`,j.textContent=a})),C.addEventListener("input",(()=>{const e=document.getElementsByTagName("canvas")[0],t=e.style.filter||"contrast(1) brightness(1) saturate(1)",n=parseFloat(t.match(/brightness\((\d+(\.\d+)?)\)/)[1]),o=parseFloat(t.match(/saturate\((\d+(\.\d+)?)\)/)[1]),a=C.value;e.style.filter=`contrast(${a}) brightness(${n}) saturate(${o})`,P.textContent=a})),R.addEventListener("input",(()=>{const e=document.getElementsByTagName("canvas")[0],t=e.style.filter||"contrast(1) brightness(1) saturate(1)",n=parseFloat(t.match(/brightness\((\d+(\.\d+)?)\)/)[1]),o=parseFloat(t.match(/contrast\((\d+(\.\d+)?)\)/)[1]),a=R.value;e.style.filter=`contrast(${o}) brightness(${n}) saturate(${a})`,F.textContent=a})),X.addEventListener("click",et),X.addEventListener("touchstart",et),X.addEventListener("selectstart",et),W.addEventListener("click",tt),W.addEventListener("touchstart",tt),W.addEventListener("selectstart",tt),f.addEventListener("click",nt),f.addEventListener("touchstart",nt),f.addEventListener("selectstart",nt),y.addEventListener("click",ot),y.addEventListener("touchstart",ot),y.addEventListener("selectstart",ot),v.addEventListener("click",at),v.addEventListener("touchstart",at),v.addEventListener("selectstart",at),m.addEventListener("click",rt),m.addEventListener("touchstart",rt),m.addEventListener("selectstart",rt),b.addEventListener("click",st),b.addEventListener("touchstart",st),b.addEventListener("selectstart",st),document.addEventListener("DOMContentLoaded",(function(){}));const ct=document.getElementById("map"),lt=document.getElementById("mapimage"),dt=document.getElementById("mapimg");if(null!==e.project.map_filename){i.style.display="block",dt.src="https://snallapojkar.se/360/img/"+e.project.map_filename,e.project.map_links.forEach((e=>{let t=`<div class="maplink ${e.pos_left>50?" linktextleft":""}" data-id="${e.link_location_id}" data-order_index="${e.link_order_index}" style="top: ${e.pos_top}%; left: ${e.pos_left}%">\n            <span class="hint">${e.link_title}</span>\n        </div>`;lt.insertAdjacentHTML("beforeend",t)}));function ut(){lt.style.width="100%",lt.style.height="100%";const e=lt.clientWidth,t=lt.clientHeight,n=dt.naturalWidth,o=dt.naturalHeight;let a,r;e/t<n/o?(a=e,r=e/n*o):(r=t,a=t/o*n),lt.style.width=a+"px",lt.style.height=r+"px"}function mt(){"none"===ct.style.display||""===ct.style.display?(ct.style.display="flex",ct.querySelector("img").style.display="block",ut()):(ct.classList.add("removeblur"),ct.querySelector("img").style.display="none",setTimeout((()=>{ct.classList.remove("removeblur"),ct.style.display="none"}),600))}document.querySelectorAll(".maplink").forEach((e=>{e.addEventListener("click",(e=>{const t=parseInt(e.target.getAttribute("data-order_index"));ct.style.display="none",listItems.forEach((e=>{e.classList.remove("active")}));document.querySelector(`#locations [data-id="${t}"]`).classList.add("active"),ze(parseInt(t))}))})),i.addEventListener("click",mt),i.addEventListener("touchstart",mt),i.addEventListener("selectstart",mt),ut()}else i.style.display="none";function pt(e){console.log(e);const[t,n,o]=e.split(":").map(parseFloat);let[a,r]=[0,0];if("string"==typeof o&&o.includes(",")){const e=o.split(",");a=parseFloat(e[0]),r=parseFloat(e[1])}else a=parseFloat(o);return 3600*t+60*n+a+r/1e3}navigator.userAgent.toLowerCase().match(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i)&&(console.log("You are using a mobile device."),window.addEventListener("deviceorientation",(function(e){he.rotation.x=e.beta*Math.PI/180,he.rotation.y=e.gamma*Math.PI/180,he.rotation.z=e.alpha*Math.PI/180})))}xhrSend("POST",fileCheckData,uri).then((e=>{if(console.log(e),!e.haspass&&e.ispublic)xhrSend("POST",fileGetData,uri).then((e=>{console.log(e),buildHtml(),start(e)})).catch((e=>{console.error("Start. XHR request failed:",e)}));else{if(e.haspass&&e.ispublic)return console.log("This has password ON."),void buildPasswordHtml();if(!e.haspass&&!e.ispublic)return void console.log("This is private.");if(e.haspass&&!e.ispublic)return void console.log("This is private and has password.")}})).catch((e=>{console.error("Check if it has password. XHR request failed:",e)}));