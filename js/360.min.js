import*as THREE from"three";import{OrbitControls}from"three/examples/jsm/controls/OrbitControls";import{CSS2DRenderer,CSS2DObject}from"three/addons/renderers/CSS2DRenderer.js";import{rootHTML,haspassHTML}from"./360template.min.js";import{buildComments}from"./comments.min.js";import{testInternetSpeed,xhrSend,getUrlParameter,formatNumber,countComments}from"./functions.min.js";var listItems,marker,dataType="",markerData=[],highSpeed=!1,sceneType="image";function imageClickHandler(e){const t=document.querySelector("#root"),n=document.createElement("div"),o=e.target.cloneNode(!0),r="zoom-div-"+Date.now();n.id=r,n.classList.add("zoomedimage"),o.classList.remove("zoom-image"),n.appendChild(o),t.appendChild(n),n.addEventListener("click",(function(){t.removeChild(n)}))}const root=new THREE.Group;window.addEventListener("load",(function(){testInternetSpeed().then((e=>{console.log("Internet speed:",e,"Kbps"),e>=1e3?(console.log("High-speed connection detected. Load high-quality."),highSpeed=!0):(console.log("Low-speed connection detected. Load low-quality."),highSpeed=!1)})).catch((e=>{console.error("Error testing internet speed:",e)}))}));const embedId=getUrlParameter("i"),locId=getUrlParameter("loc"),uri="i="+embedId+"&loc="+locId,fileCheckData="../php/checkdata.php",fileGetData="../php/getdata.php";function buildHtml(){document.getElementById("root").innerHTML=rootHTML}function buildPasswordHtml(){document.getElementById("root").innerHTML=haspassHTML,document.querySelector("#haspass-password").focus(),document.querySelector("#enter-password").addEventListener("click",(e=>{e.preventDefault();const t=document.querySelector("#haspass-login form"),n=document.querySelector("#haspass-password").value.trim();t.insertAdjacentHTML("beforebegin",'<div class="loader"></div>');const o=document.querySelector(".loader");if(t.style.display="none",""===n)return alert("Password can not be empty."),t.style.display="block",void o.remove();if(n.length<5)return alert("Password must be 5 letters or longer."),t.style.display="block",void o.remove();xhrSend("POST","../php/checkpass.php","i="+embedId+"&loc="+locId+"&pass="+n).then((e=>{console.log(e),e.success?(document.querySelector("#haspass-login").remove(),xhrSend("POST",fileGetData,uri).then((e=>{console.log(e),buildHtml(),start(e)})).catch((e=>{console.error("XHR request failed:",e)}))):setTimeout((()=>{alert("Wrong password."),t.style.display="block",o.remove()}),3e3)})).catch((e=>{console.error("XHR request failed:",e)}))}))}function start(e){dataType=e.hasOwnProperty("project")?"project":"location",console.log("Data Type:",dataType);const t="http://localhost/360/",n=document.querySelector("#root"),o=document.getElementById("view-container"),r=document.querySelector("#zoombtn"),s=document.querySelector("#zoomlevel"),i=document.querySelector("#mapbtn"),a=document.querySelector(".rightbuttons"),c=document.querySelector("#fullscreenbtn"),l=document.getElementById("locations"),d=document.getElementById("angleIndicator"),u=document.querySelector("#indicatorbtn"),m=document.querySelector("#closeinfobtn"),p=document.querySelector("#info"),y=document.querySelector("#infobtn"),v=document.querySelector("#resizer"),f=document.querySelector("#likebtn"),E=document.querySelector("#commentbtn"),h=document.querySelector("#comments"),g=document.querySelector("#videoplayer"),L=document.querySelector("#playvideo"),S=document.querySelector("#videoduration"),w=document.querySelector("#caption"),b=document.querySelector("#captionselect"),k=document.querySelector("#captionselect ul"),x=document.querySelector("#scrollable"),q=document.querySelector("#labels"),T=document.querySelector("#settings"),H=document.getElementById("brightness"),R=document.getElementById("contrast"),C=document.getElementById("saturation"),I=document.getElementById("ambient"),M=document.getElementById("volume"),$=document.getElementById("brightnessNo"),_=document.getElementById("contrastNo"),j=document.getElementById("saturationNo"),D=document.getElementById("ambientNo"),F=document.getElementById("volumeNo"),A=document.querySelector(".settingsbtn"),B=document.getElementById("reset"),P=document.querySelector(".closebtn"),X=document.querySelector(".show-loc"),N=document.querySelector(".show-info"),W=document.querySelector("#info-location"),z=document.querySelector("#info-details");X.addEventListener("click",(()=>{W.style.display="block",z.style.display="none",X.classList.add("showactive"),N.classList.remove("showactive")})),N.addEventListener("click",(()=>{z.style.display="block",W.style.display="none",X.classList.remove("showactive"),N.classList.add("showactive")}));const O=460,U=1800;let V,G,Q,Y=!1;function J(e){Y=!0,V=e.clientX||e.touches[0].clientX,G=parseInt(document.defaultView.getComputedStyle(p).width,10),document.body.addEventListener("mousemove",K),document.body.addEventListener("touchmove",K),document.body.addEventListener("mouseup",Z),document.body.addEventListener("touchstart",Z),document.body.addEventListener("selectend",Z)}function K(e){if(!Y)return;const t=e.clientX||e.touches[0].clientX;let n=G-(t-V);n=Math.max(O,Math.min(U,n)),p.style.width=n+"px"}function Z(){Y=!1,document.removeEventListener("mousemove",K),document.removeEventListener("touchmove",K),document.removeEventListener("mouseup",Z),document.removeEventListener("touchstart",Z),document.removeEventListener("selectend",Z)}function ee(){if(0===parseFloat(l.style.bottom)){let e=l.getBoundingClientRect().height;l.style.bottom="-"+e+"px",u.classList.remove("rotate180")}else u.classList.add("rotate180"),l.style.bottom="0"}function te(){l.style.opacity="1",d.style.opacity="1",A.style.opacity="1",r.style.opacity="1",i.style.opacity="1",a.style.opacity="1"}function ne(){l.style.opacity="0",d.style.opacity="0",A.style.opacity="0",r.style.opacity="0",i.style.opacity="0",a.style.opacity="0"}function oe(){clearTimeout(Q),"1"!==r.style.opacity&&te(),Q=setTimeout((()=>{ne()}),7e3)}function re(){T.style.right="0px",A.style.opacity="0"}v.addEventListener("mousedown",J),v.addEventListener("touchstart",J),v.addEventListener("selectstart",J),u.addEventListener("click",ee),u.addEventListener("touchstart",ee),u.addEventListener("selectend",ee),te(),document.addEventListener("keydown",(e=>{if("h"===e.key||"H"===e.key){const e=document.querySelector("#view-container"),t=document.querySelector("#outside");if(document.querySelector("#commentinput").contains(document.activeElement))return;"none"===e.style.display?(e.style.display="block",t.style.display="block"):(e.style.display="none",t.style.display="none")}})),Q=setTimeout((()=>{ne()}),7e3),document.addEventListener("mousemove",(function(e){oe()})),document.addEventListener("touchmove",(function(e){oe()})),A.addEventListener("click",re),A.addEventListener("touchstart",re),A.addEventListener("selectstart",re);const se=document.querySelector("#locationlist");e.locations.forEach((e=>{se.insertAdjacentHTML("afterbegin","<li></li>")})),"project"===dataType&&e.project&&!0===e.project.showlocations||document.querySelector("#indicatorbtn").remove();let ie=75;const ae=new THREE.Scene,ce=new THREE.PerspectiveCamera(ie,window.innerWidth/window.innerHeight,.1,1e3),le=new THREE.WebGLRenderer({alpha:!1});le.setSize(window.innerWidth,window.innerHeight),le.setClearColor(0),n.appendChild(le.domElement);const de=new CSS2DRenderer;de.setSize(window.innerWidth,window.innerHeight),de.domElement.style.position="absolute",de.domElement.style.top="0px",de.domElement.style.pointerEvents="none",n.appendChild(de.domElement);const ue=new OrbitControls(ce,le.domElement);ue.enablePan=!1,ue.enableDamping=!0,ue.dampingFactor=.05,ue.rotateSpeed=-1,ue.autoRotate=!1,ue.autoRotateSpeed*=.25,ce.position.set(0,0,0),ce.rotation.order="YXZ";$e(new THREE.Vector3(0,0,0),(new THREE.Quaternion).setFromEuler(new THREE.Euler(0,150,0))),ue.minDistance=30,ue.maxDistance=280,ue.zoomSpeed=3;const me=document.createElement("video");let pe,ye,ve;const fe=new THREE.SphereGeometry(360,180,180),Ee=new THREE.DataTexture(new Uint8Array([0,0,0]),1,1,THREE.RGBFormat);Ee.needsUpdate=!0;const he=new THREE.MeshStandardMaterial({map:Ee,side:THREE.DoubleSide}),ge=new THREE.Mesh(fe,he);ae.add(ge),ae.add(root);let Le,Se=4;function we(e){Se=e,Le&&ae.remove(Le),Le=new THREE.AmbientLight(16777215,e),ae.add(Le)}function be(){le.render(ae,ce),de.render(ae,ce)}function ke(){requestAnimationFrame(ke),ue.update(),be();const e=-Math.atan2(ce.position.x,ce.position.z);d.style.transform=`translate(-50%, -50%) rotate(${e}rad)`}function xe(e,t){const n=t.getViewerPose();if(n){const e=n.views;for(let t of e){const e=xrLayer.getViewport(t),n=t.projectionMatrix;le.setViewport(e.x,e.y,e.width,e.height),le.setProjectionMatrix(n),le.render(ae,ce)}}t.session.requestAnimationFrame(xe)}we(3.5),"xr"in navigator?(console.log("WebXR is supported in this browser."),"requestDevice"in navigator.xr?navigator.xr.requestDevice().then((e=>{console.log("XR device obtained:",e),e.requestSession({immersive:!0}).then((e=>{console.log("XR session started:",e);const t=le.getContext(),n=new XRWebGLLayer(e,t);e.updateRenderState({baseLayer:n}),e.requestAnimationFrame(xe)})).catch((e=>{console.error("Failed to start XR session:",e),ke()}))})).catch((e=>{console.error("Failed to obtain XR device:",e),ke()})):"requestSession"in navigator.xr?navigator.xr.requestSession("immersive-vr").then((e=>{console.log("XR session started:",e);const t=le.getContext(),n=new XRWebGLLayer(e,t);e.updateRenderState({baseLayer:n}),e.requestAnimationFrame(xe)})).catch((e=>{console.error("Failed to start XR session:",e),ke()})):(console.error("WebXR APIs are present, but neither requestDevice nor requestSession methods are available."),ke())):(console.log("WebXR not supported in this browser."),ke());let qe="";console.log("Render locations list for project...");for(let n=0;n<e.locations.length;n++){const o=e.locations[n];let r=0===n&&"video"===o.file_type?"active":"",s=o.file_name.replace(/\.\w+$/,".jpg");if("video"===o.file_type){sceneType="video";const e=s.split(".").slice(0,-1).join(".");qe+=`<li class="${r}" data-file="${o.file_name}" data-id="${o.id}" data-order_index="${o.order_index}" data-type="${o.file_type}">\n                            <span class="icon-video">${o.duration}</span>\n                            <div>${o.location_title}</div>\n                            <img src="${t}video/${e}.jpg" alt="" />\n                        </li>`}else{sceneType="image";const e=o.file_name.split(".").slice(0,-1).join(".");qe+=`<li class="${r}" data-file="${o.file_name}" data-id="${o.id}" data-order_index="${o.order_index}" data-type="${o.file_type}">\n                            <div>${o.location_title}</div>\n                            <img src="${t}img/${e}-low.jpg" alt="" />\n                        </li>`}}function Te(e){listItems.forEach((e=>{e.classList.remove("active")})),e.classList.add("active");const t=e.getAttribute("data-order_index");Ce(parseInt(t))}function He(e){e.preventDefault();const t=e.target.getAttribute("data-order_index");Ce(parseInt(t))}function Re(e){if(!e.target.closest(".marker-container")){e.preventDefault();let t=e.target,n=t.querySelector(".hint"),o=t.querySelector(".marker-container");"none"===getComputedStyle(o).display?(o.style.display="block",n.style.display="none"):(o.style.display="none",n.style.display="block")}}function Ce(n){let o=document.querySelectorAll(".intlink"),r=document.querySelectorAll(".infodot");o.forEach((e=>{e.removeEventListener("click",He)})),r.forEach((e=>{e.removeEventListener("click",Re)}));let s=document.querySelectorAll(".zoom-image");s.forEach((e=>{e.removeEventListener("click",imageClickHandler)})),q.innerHTML="",p.classList.remove("infoshow");let i=e.locations.find((e=>e.order_index===n)),a=i.file_name,c=i.file_type,l=i.info;if(markerData=i.markers,root.clear(),""!==markerData&&null!=markerData&&(console.log("Creating markers..."),async function(e){return new Promise((t=>{if(0===e.length)return void t();let n=0;const o=()=>{let o=document.querySelectorAll(".intlink"),s=document.querySelectorAll(".infodot");o.length>0&&s.length>0&&(clearInterval(r),o.forEach((e=>{e.addEventListener("click",He)})),s.forEach((e=>{e.addEventListener("click",Re)})),n===e.length&&t())};o();const r=setInterval(o,50);e.forEach(((e,t)=>{const{marker_title:o,pos_x:r,pos_y:s,pos_z:i,info:a,link:c,sound:l,autoplay:d,customcss:u}=e,m=new THREE.Vector3(r,s,i);"string"!=typeof c||""===c||isNaN(c)?"string"==typeof c&&""!==c?((marker=document.createElement("a")).href=c,marker.target="_blank",marker.classList.add("extlink")):(marker=document.createElement("div")).classList.add("infodot"):((marker=document.createElement("div")).dataset.order_index=parseInt(c),marker.classList.add("intlink"));let p=t;if(marker.id="marker"+p,""!==u&&null!==u){var y=JSON.parse(u),v="";y.forEach(((e,t)=>{v+="#marker"+p+e,t!==y.length-1&&(v+=" ")}));var f=document.querySelector("style[data-customcss]");if(f)f.textContent+=v;else{var E=document.createElement("style");E.textContent=v,E.setAttribute("data-customcss",""),document.head.appendChild(E)}}marker.classList.add("marker");let h=`<span class="hint">${o}</span><div class="marker-container"></div>`;marker.innerHTML=h,marker.querySelector(".marker-container").insertAdjacentHTML("afterbegin",a);const g=new CSS2DObject(marker);g.position.copy(m),root.add(g),n++})),ce.position.set(360,0,0),ce.rotation.set(360,0,0),ce.lookAt(ae.position),ce.updateProjectionMatrix(),ce.position.x=-360,ce.rotation.x=-360,ce.lookAt(ae.position),ce.updateProjectionMatrix(),be(),console.log("Markers added to root.")}))}(markerData).then((()=>{setTimeout((()=>{s=document.querySelectorAll(".zoom-image"),s.forEach((e=>{e.addEventListener("click",imageClickHandler),console.log(e)})),console.log("Added eventlistener to images...",s),console.log("Markers created.")}),100)}))),"video"===c){if(pe===a)return;sceneType="video";let M=a;ye="",ge.material.map=null,me.pause(),me.src="",pe="";const $=i.file_name.split(".").slice(0,-1).join(".");if(highSpeed||(M=$+"-low.mp4",function(e,n){const o=document.createElement("video");o.src=t+"video/"+n,o.addEventListener("canplay",(function(){const t=setInterval((function(){if(4===o.readyState){clearInterval(t),e.pause();let n=e.currentTime;e.src="",e.src=o.src,e.currentTime=n,e.play(),console.log("High-quality video loaded and switched.")}}),100)}))}(me,a)),me.src=t+"video/"+M,me.load(),me.crossOrigin="anonymous",me.loop=!0,me.playsInline=!0,me.play(),pe=a,""!==i.captions){b.style.display="block";const j=document.querySelector("#captionselect ul");let D="";i.captions.forEach((e=>{D+=`<li data-caption="${e}" data-id="${i.id}">${e}</li>`})),D+='<li id="captionoff" class="active">Captions off</li>',j.innerHTML=D;const F=document.querySelectorAll("#captionselect ul li");function d(n){const o=n.target.getAttribute("data-id");let r=e.locations.find((e=>e.id===parseInt(o)));const s=n.target.getAttribute("data-caption"),i=r.file_name.split(".").slice(0,-1).join("."),a=`${t}video/${i}-${s}.srt`;console.log(a),w.style.display="block",F.forEach((e=>{e.classList.remove("active")})),n.target.classList.add("active"),b.classList.add("on"),fetch(a).then((e=>e.blob())).then((e=>{!function(e){const t=new FileReader;t.onload=function(e){const t=function(e){const t=e.trim().split(/\r?\n/),n=[];let o={};for(let e=0;e<t.length;e++){const r=t[e].trim();if(r)if(o.id)if(o.start)o.text?(n.push(o),o={}):o.text=r;else{const e=r.split(" --\x3e ");if(2!==e.length){o={};continue}o.start=Ye(e[0]),o.end=Ye(e[1])}else o.id=parseInt(r)}return console.log(n),n}(e.target.result);console.log(t),function(e){me.addEventListener("timeupdate",(function(){const t=me.currentTime,n=document.getElementById("caption");for(const o of e)if(t>=o.start&&t<=o.end)return void(n.innerHTML=`<p>${o.text}</p>`);n.innerHTML=""}))}(t)},t.readAsText(e)}(e)})).catch((e=>{console.error("Error fetching or converting SRT file:",e)}))}F.forEach((e=>{e.addEventListener("click",d),e.addEventListener("touchstart",d),e.addEventListener("selectstart",d)}));const A=document.querySelector("#captionoff");function u(){F.forEach((e=>{e.classList.remove("active")})),A.classList.add("active"),b.classList.remove("on"),w.style.display="none"}A.addEventListener("click",u),A.addEventListener("touchstart",u),A.addEventListener("selectstart",u)}else b.style.display="none";function m(){"none"===k.style.display?k.style.display="block":k.style.display="none"}function v(){L.classList.contains("playing")?(L.classList.remove("playing"),me.pause()):(L.classList.add("playing"),me.play())}L.classList.add("playing"),b.addEventListener("click",m),b.addEventListener("touchstart",m),b.addEventListener("selectstart",m),L.addEventListener("click",v),L.addEventListener("touchstart",v),L.addEventListener("selectstart",v);const _=document.querySelector("#currenttime");function x(){const e=parseFloat(S.value);me.currentTime=e*me.duration;const t=H(me.currentTime);_.textContent=t}function T(){me.removeEventListener("timeupdate",(()=>{})),x()}function H(e){const t=Math.floor(e/3600),n=Math.floor(e%3600/60),o=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}me.addEventListener("timeupdate",(()=>{const e=me.currentTime/me.duration;S.value=e.toFixed(2);const t=H(me.currentTime);_.textContent=t})),S.addEventListener("input",x),S.addEventListener("mousedown",T),S.addEventListener("touchstart",T),S.addEventListener("selectstart",T),g.style.display="flex",ve=new THREE.VideoTexture(me),ve.encoding=THREE.LinearEncoding,ve.needsUpdate=!0,ve.wrapS=THREE.RepeatWrapping,ve.repeat.x=-1,ve.mapping=THREE.UVMapping,ve.encoding=THREE.sRGBEncoding,ve.gammaFactor=2.2,ge.material.map=ve,ge.material.needsUpdate=!0}else if("image"===c){if(ye===a)return;sceneType="image",g.style.display="none",ge.material.map=null,me.pause(),me.src="",pe="";const B=i.file_name.split(".").slice(0,-1).join(".");let P=t+"img/"+a;highSpeed||(P=t+"img/"+B+"-low.jpg");const X=(new THREE.TextureLoader).load(`${P}`,(function(e){e.wrapS=THREE.RepeatWrapping,e.repeat.x=-1,e.mapping=THREE.UVMapping,e.encoding=THREE.sRGBEncoding,e.gammaFactor=2.2}));if(ge.material.map=X,ge.material.needsUpdate=!0,!highSpeed){!function(e,t){const n=new Image;n.src=e,n.onload=function(){const e=new THREE.Texture(n);e.needsUpdate=!0,e.wrapS=THREE.RepeatWrapping,e.repeat.x=-1,e.mapping=THREE.UVMapping,e.encoding=THREE.sRGBEncoding,e.gammaFactor=2.2,t(e)}}(t+"img/"+a,(function(e){ge.material.map=e,ge.material.needsUpdate=!0}))}ye=a}else console.log("Invalid file type");""!==l&&null!=l?(W.innerHTML=l,p.style.display="block",y.style.display="block",y.style.opacity="1"):(p.style.display="none",y.style.opacity="0",y.style.display="none"),buildComments(i.comments);document.querySelectorAll(".btn-showreplies").forEach((e=>{e.addEventListener("click",(e=>{e.preventDefault();let t=e.target.parentNode.querySelector(".replies-container");t?(t.style.display="block",e.target.remove()):console.error("Replies container not found.")}))}));const R=document.querySelector("#closecommentsbtn");function C(){document.querySelector("#commentbtn").style.opacity="1",h.classList.remove("commentshow")}R.addEventListener("click",C),R.addEventListener("touchstart",C),R.addEventListener("selectstart",C);const I=countComments(i.comments);E.querySelector(".amount").textContent=formatNumber(I),f.querySelector(".amount").textContent=formatNumber(i.likes_count),document.querySelector("#info-details .title").textContent=i.location_title,document.querySelector("#info-details .description").textContent=i.location_description,document.querySelector(".details-likes span").textContent=formatNumber(i.likes_count),document.querySelector(".details-views span").textContent=formatNumber(i.views_count),document.querySelector(".details-comments span").textContent=formatNumber(I),document.querySelector(".details-created span").textContent=i.registered,ce.updateProjectionMatrix()}document.querySelector("#locationlist").innerHTML=qe,(listItems=document.querySelectorAll("#locationlist li")).forEach((e=>{e.addEventListener("click",(function(){Te(e)})),e.addEventListener("touchstart",(function(){Te(e)})),e.addEventListener("selectend",(function(){Te(e)}))})),function t(){const n=document.querySelector("#locations .container ul li:first-child");if(n){const t=e.locations[0].order_index;Ce(parseInt(t)),n.classList.add("active")}else setTimeout(t,1e3)}();parseFloat(s.value);document.addEventListener("wheel",(function(e){if(function(e){if(e&&e.target){const t=e.target;return null!==t.closest("#scrollable")||null!==t.closest("#info")||null!==t.closest(".marker-container")||null!==t.closest("#comments")}return!1}(e))return;const t=.1*e.deltaY,n=-ue.object.position.length();ue.rotateSpeed=.005*n,ie+=.1*t,ie=Math.max(10,Math.min(90,ie)),ce.aspect=window.innerWidth/window.innerHeight,ce.fov=ie,ce.updateProjectionMatrix(),s.value=(ie-10)/80})),s.addEventListener("input",(function(){const e=parseFloat(s.value),t=10+80*e,n=ue.maxDistance,o=ue.minDistance,r=o+e*(n-o);ce.fov=t,ce.maxDistance=r,ce.updateProjectionMatrix()})),d.textContent="↑",o.appendChild(d),d.addEventListener("click",(()=>{$e()}));ce.rotation.clone(),ce.position.clone();const Ie=new THREE.Vector3(0,0,0),Me=(new THREE.Quaternion).setFromEuler(new THREE.Euler(0,0,0));function $e(e=Ie,t=Me){const n=(new THREE.Quaternion).setFromEuler(ce.rotation.clone()),o=(new THREE.Quaternion).setFromEuler(t),r=ce.position.clone(),s=e.clone(),i=performance.now();!function e(){const t=performance.now()-i,a=Math.min(t/1e3,1);ce.quaternion.slerpQuaternions(n,o,a),ce.position.lerpVectors(r,s,a),ue.target.copy(ce.position).add(new THREE.Vector3(0,0,-1).applyQuaternion(ce.quaternion));const c=-Math.atan2(ce.position.x,ce.position.z);d.style.transform=`translate(-50%, -50%) rotate(${c}rad)`,t<1e3&&requestAnimationFrame(e)}()}function _e(){document.fullscreenElement?document.exitFullscreen&&(c.classList.remove("fullscreen"),document.exitFullscreen(),n.classList.remove("rootfullscreen")):(document.documentElement.requestFullscreen(),c.classList.add("fullscreen"),n.classList.add("rootfullscreen"))}c.addEventListener("click",_e),c.addEventListener("touchstart",_e),c.addEventListener("selectstart",_e),window.addEventListener("resize",(function(e){if(ce.aspect=window.innerWidth/window.innerHeight,ce.updateProjectionMatrix(),le.setSize(window.innerWidth,window.innerHeight),de.setSize(window.innerWidth,window.innerHeight),le.setPixelRatio(window.devicePixelRatio),be(),0!==l.style.bottom){let e=l.getBoundingClientRect().height;l.style.bottom="-"+e+"px"}Ge()})),x.addEventListener("wheel",(function(e){e.preventDefault();const t=e.deltaY;x.scrollLeft+=t}));let je,De,Fe=!1;function Ae(){Fe=!1,x.style.cursor="grab"}function Be(e){if(!Fe)return;const t=3*(e.pageX-x.offsetLeft-je);x.scrollLeft=De-t}function Pe(){document.getElementsByTagName("canvas")[0].style.filter="contrast(1) brightness(1) saturate(1)",I.value="3.5",D.textContent="3.5",we(3.5),H.value="1",$.textContent="1",R.value="1",_.textContent="1",C.value="1",j.textContent="1",M.value="1",F.textContent="1",me.volume="1"}function Xe(){A.style.opacity="1",T.style.right="-640px"}function Ne(){y.style.opacity="0",p.classList.add("infoshow")}function We(){E.style.opacity="0",h.classList.add("commentshow")}function ze(){y.style.opacity="1",p.classList.remove("infoshow")}x.addEventListener("mousedown",(function(e){e.preventDefault(),Fe=!0,je=e.pageX-x.offsetLeft,De=x.scrollLeft,x.style.cursor="grabbing"})),x.addEventListener("touchstart",(function(e){e.preventDefault(),Fe=!0,je=e.pageX-x.offsetLeft,De=x.scrollLeft,x.style.cursor="grabbing"})),x.addEventListener("mouseup",Ae),x.addEventListener("touchstart",Ae),x.addEventListener("mouseleave",Ae),x.addEventListener("mousemove",(e=>{Be(e)})),x.addEventListener("touchmove",(e=>{Be(e)})),M.addEventListener("input",(()=>{const e=M.value;me.volume=e,F.textContent=e})),I.addEventListener("input",(()=>{const e=I.value;we(e),D.textContent=e})),H.addEventListener("input",(()=>{const e=document.getElementsByTagName("canvas")[0],t=e.style.filter||"contrast(1) brightness(1) saturate(1)",n=parseFloat(t.match(/contrast\((\d+(\.\d+)?)\)/)[1]),o=parseFloat(t.match(/saturate\((\d+(\.\d+)?)\)/)[1]),r=H.value;e.style.filter=`contrast(${n}) brightness(${r}) saturate(${o})`,$.textContent=r})),R.addEventListener("input",(()=>{const e=document.getElementsByTagName("canvas")[0],t=e.style.filter||"contrast(1) brightness(1) saturate(1)",n=parseFloat(t.match(/brightness\((\d+(\.\d+)?)\)/)[1]),o=parseFloat(t.match(/saturate\((\d+(\.\d+)?)\)/)[1]),r=R.value;e.style.filter=`contrast(${r}) brightness(${n}) saturate(${o})`,_.textContent=r})),C.addEventListener("input",(()=>{const e=document.getElementsByTagName("canvas")[0],t=e.style.filter||"contrast(1) brightness(1) saturate(1)",n=parseFloat(t.match(/brightness\((\d+(\.\d+)?)\)/)[1]),o=parseFloat(t.match(/contrast\((\d+(\.\d+)?)\)/)[1]),r=C.value;e.style.filter=`contrast(${o}) brightness(${n}) saturate(${r})`,j.textContent=r})),B.addEventListener("click",Pe),B.addEventListener("touchstart",Pe),B.addEventListener("selectstart",Pe),P.addEventListener("click",Xe),P.addEventListener("touchstart",Xe),P.addEventListener("selectstart",Xe),y.addEventListener("click",Ne),y.addEventListener("touchstart",Ne),y.addEventListener("selectstart",Ne),E.addEventListener("click",We),E.addEventListener("touchstart",We),E.addEventListener("selectstart",We),m.addEventListener("click",ze),m.addEventListener("touchstart",ze),m.addEventListener("selectstart",ze),document.addEventListener("DOMContentLoaded",(function(){}));const Oe=document.getElementById("map"),Ue=document.getElementById("mapimage"),Ve=document.getElementById("mapimg");Ve.src="https://snallapojkar.se/360/img/"+e.project.map_filename,e.project.map_links.forEach((e=>{let t=`<div class="maplink ${e.pos_left>50?" linktextleft":""}" data-id="${e.link_location_id}" data-order_index="${e.link_order_index}" style="top: ${e.pos_top}%; left: ${e.pos_left}%">\n            <span class="hint">${e.link_title}</span>\n        </div>`;Ue.insertAdjacentHTML("beforeend",t)}));function Ge(){Ue.style.width="100%",Ue.style.height="100%";const e=Ue.clientWidth,t=Ue.clientHeight,n=Ve.naturalWidth,o=Ve.naturalHeight;let r,s;e/t<n/o?(r=e,s=e/n*o):(s=t,r=t/o*n),Ue.style.width=r+"px",Ue.style.height=s+"px"}function Qe(){"none"===Oe.style.display?(Oe.style.display="flex",Ge()):Oe.style.display="none"}function Ye(e){console.log(e);const[t,n,o]=e.split(":").map(parseFloat);let[r,s]=[0,0];if("string"==typeof o&&o.includes(",")){const e=o.split(",");r=parseFloat(e[0]),s=parseFloat(e[1])}else r=parseFloat(o);return 3600*t+60*n+r+s/1e3}document.querySelectorAll(".maplink").forEach((e=>{e.addEventListener("click",(e=>{const t=parseInt(e.target.getAttribute("data-order_index"));Oe.style.display="none",listItems.forEach((e=>{e.classList.remove("active")}));document.querySelector(`#locations [data-id="${t}"]`).classList.add("active"),Ce(parseInt(t))}))})),i.addEventListener("click",Qe),i.addEventListener("touchstart",Qe),i.addEventListener("selectstart",Qe),Ge(),navigator.userAgent.toLowerCase().match(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i)&&(console.log("You are using a mobile device."),window.addEventListener("deviceorientation",(function(e){ce.rotation.x=e.beta*Math.PI/180,ce.rotation.y=e.gamma*Math.PI/180,ce.rotation.z=e.alpha*Math.PI/180})))}xhrSend("POST",fileCheckData,uri).then((e=>{if(console.log(e),!e.haspass&&e.ispublic)xhrSend("POST",fileGetData,uri).then((e=>{console.log(e),buildHtml(),start(e)})).catch((e=>{console.error("XHR request failed:",e)}));else{if(e.haspass&&e.ispublic)return console.log("This has password ON."),void buildPasswordHtml();if(!e.haspass&&!e.ispublic)return void console.log("This is private.");if(e.haspass&&!e.ispublic)return void console.log("This is private and has password.")}})).catch((e=>{console.error("XHR request failed:",e)}));