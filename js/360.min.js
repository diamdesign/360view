import*as THREE from"three";import{OrbitControls}from"three/examples/jsm/controls/OrbitControls";import{CSS2DRenderer,CSS2DObject}from"three/addons/renderers/CSS2DRenderer.js";var listItems,marker,dataType="",markerData=[],highSpeed=!1,sceneType="image";window.addEventListener("load",(function(){testInternetSpeed().then((e=>{console.log("Internet speed:",e,"Kbps"),e>=1e3?(console.log("High-speed connection detected. Load high-quality."),highSpeed=!0):(console.log("Low-speed connection detected. Load low-quality."),highSpeed=!1)})).catch((e=>{console.error("Error testing internet speed:",e)}))}));const embedId=getUrlParameter("i"),locId=getUrlParameter("loc"),data="i="+embedId+"&loc="+locId,file="../php/getdata.php";function start(e){dataType=e.hasOwnProperty("project")?"project":"location",console.log("Data Type:",dataType);const t="http://localhost/360/",n=document.querySelector("#root"),o=document.getElementById("view-container"),a=document.querySelector("#zoombtn"),i=document.querySelector("#zoomlevel"),s=document.querySelector("#mapbtn"),r=document.querySelector(".rightbuttons"),c=document.querySelector("#fullscreenbtn"),l=document.getElementById("locations"),d=document.getElementById("angleIndicator"),u=document.querySelector("#indicatorbtn"),m=document.querySelector("#closeinfobtn"),p=document.querySelector("#info"),y=document.querySelector("#infobtn"),v=document.querySelector("#resizer"),E=(document.querySelector("#likebtn"),document.querySelector("#closecommentsbtn")),f=document.querySelector("#comments"),g=document.querySelector("#commentbtn"),h=document.querySelector("#videoplayer"),L=document.querySelector("#playvideo"),w=document.querySelector("#videoduration"),S=document.querySelector("#caption"),b=document.querySelector("#captionselect"),x=document.querySelector("#captionselect ul"),k=document.querySelector("#scrollable"),T=document.querySelector("#labels"),q=document.querySelector("#settings"),R=document.getElementById("brightness"),H=document.getElementById("contrast"),I=document.getElementById("saturation"),$=document.getElementById("ambient"),C=document.getElementById("volume"),_=document.getElementById("brightnessNo"),M=document.getElementById("contrastNo"),F=document.getElementById("saturationNo"),j=document.getElementById("ambientNo"),B=document.getElementById("volumeNo"),D=document.querySelector(".settingsbtn"),A=document.getElementById("reset"),P=document.querySelector(".closebtn"),X=document.querySelector(".show-loc"),W=document.querySelector(".show-info"),z=document.querySelector("#info-location"),N=document.querySelector("#info-details");X.addEventListener("click",(()=>{z.style.display="block",N.style.display="none",X.classList.add("showactive"),W.classList.remove("showactive")})),W.addEventListener("click",(()=>{N.style.display="block",z.style.display="none",X.classList.remove("showactive"),W.classList.add("showactive")}));const V=460,O=1800;let U,G,Q,Y=!1;function J(e){Y=!0,U=e.clientX||e.touches[0].clientX,G=parseInt(document.defaultView.getComputedStyle(p).width,10),document.body.addEventListener("mousemove",K),document.body.addEventListener("touchmove",K),document.body.addEventListener("mouseup",Z),document.body.addEventListener("touchstart",Z),document.body.addEventListener("selectend",Z)}function K(e){if(!Y)return;const t=e.clientX||e.touches[0].clientX;let n=G-(t-U);n=Math.max(V,Math.min(O,n)),p.style.width=n+"px"}function Z(){Y=!1,document.removeEventListener("mousemove",K),document.removeEventListener("touchmove",K),document.removeEventListener("mouseup",Z),document.removeEventListener("touchstart",Z),document.removeEventListener("selectend",Z)}function ee(){if(0===parseFloat(l.style.bottom)){let e=l.getBoundingClientRect().height;l.style.bottom="-"+e+"px",u.classList.remove("rotate180")}else u.classList.add("rotate180"),l.style.bottom="0"}function te(){l.style.opacity="1",d.style.opacity="1",D.style.opacity="1",a.style.opacity="1",s.style.opacity="1",r.style.opacity="1"}function ne(){l.style.opacity="0",d.style.opacity="0",D.style.opacity="0",a.style.opacity="0",s.style.opacity="0",r.style.opacity="0"}function oe(){clearTimeout(Q),"1"!==a.style.opacity&&te(),Q=setTimeout((()=>{ne()}),7e3)}function ae(){q.style.right="0px",D.style.opacity="0"}if(v.addEventListener("mousedown",J),v.addEventListener("touchstart",J),v.addEventListener("selectstart",J),u.addEventListener("click",ee),u.addEventListener("touchstart",ee),u.addEventListener("selectend",ee),te(),document.addEventListener("keydown",(e=>{if("h"===e.key||"H"===e.key){const e=document.querySelector("#view-container"),t=document.querySelector("#outside");if(document.querySelector("#commentinput").contains(document.activeElement))return;"none"===e.style.display?(e.style.display="block",t.style.display="block"):(e.style.display="none",t.style.display="none")}})),Q=setTimeout((()=>{ne()}),7e3),document.addEventListener("mousemove",(function(e){oe()})),document.addEventListener("touchmove",(function(e){oe()})),D.addEventListener("click",ae),D.addEventListener("touchstart",ae),D.addEventListener("selectstart",ae),"project"===dataType&&e.project&&!0===e.project.showlocations){const Qe=document.querySelector("#locationlist");e.locations.forEach((e=>{Qe.insertAdjacentHTML("afterbegin","<li></li>")}))}let ie=75;const se=new THREE.Scene,re=new THREE.PerspectiveCamera(ie,window.innerWidth/window.innerHeight,.1,1e3),ce=new THREE.WebGLRenderer({alpha:!1});ce.setSize(window.innerWidth,window.innerHeight),ce.setClearColor(0),n.appendChild(ce.domElement);const le=new CSS2DRenderer;le.setSize(window.innerWidth,window.innerHeight),le.domElement.style.position="absolute",le.domElement.style.top="0px",le.domElement.style.pointerEvents="none",n.appendChild(le.domElement);const de=new OrbitControls(re,ce.domElement);de.enablePan=!1,de.enableDamping=!0,de.dampingFactor=.05,de.rotateSpeed=-1,de.autoRotate=!1,de.autoRotateSpeed*=.25,re.position.set(0,0,0),re.rotation.order="YXZ";Ie(new THREE.Vector3(0,0,0),(new THREE.Quaternion).setFromEuler(new THREE.Euler(0,150,0))),de.minDistance=30,de.maxDistance=280,de.zoomSpeed=3;const ue=document.createElement("video");let me,pe;const ye=new THREE.SphereGeometry(360,180,180),ve=new THREE.DataTexture(new Uint8Array([0,0,0]),1,1,THREE.RGBFormat);ve.needsUpdate=!0;const Ee=new THREE.MeshStandardMaterial({map:ve,side:THREE.DoubleSide}),fe=new THREE.Mesh(ye,Ee);se.add(fe);const ge=new THREE.Group;se.add(ge);let he,Le=4;function we(e){Le=e,he&&se.remove(he),he=new THREE.AmbientLight(16777215,e),se.add(he)}function Se(){ce.render(se,re),le.render(se,re)}function be(){requestAnimationFrame(be),de.update(),Se();const e=-Math.atan2(re.position.x,re.position.z);d.style.transform=`translate(-50%, -50%) rotate(${e}rad)`}function xe(e,t){const n=t.getViewerPose();if(n){const e=n.views;for(let t of e){const e=xrLayer.getViewport(t),n=t.projectionMatrix;ce.setViewport(e.x,e.y,e.width,e.height),ce.setProjectionMatrix(n),ce.render(se,re)}}t.session.requestAnimationFrame(xe)}we(3.5),"xr"in navigator?(console.log("WebXR is supported in this browser."),"requestDevice"in navigator.xr?navigator.xr.requestDevice().then((e=>{console.log("XR device obtained:",e),e.requestSession({immersive:!0}).then((e=>{console.log("XR session started:",e);const t=ce.getContext(),n=new XRWebGLLayer(e,t);e.updateRenderState({baseLayer:n}),e.requestAnimationFrame(xe)})).catch((e=>{console.error("Failed to start XR session:",e),be()}))})).catch((e=>{console.error("Failed to obtain XR device:",e),be()})):"requestSession"in navigator.xr?navigator.xr.requestSession("immersive-vr").then((e=>{console.log("XR session started:",e);const t=ce.getContext(),n=new XRWebGLLayer(e,t);e.updateRenderState({baseLayer:n}),e.requestAnimationFrame(xe)})).catch((e=>{console.error("Failed to start XR session:",e),be()})):(console.error("WebXR APIs are present, but neither requestDevice nor requestSession methods are available."),be())):(console.log("WebXR not supported in this browser."),be());let ke="";if("project"===dataType&&e.project&&!0===e.project.showlocations){console.log("Render locations list for project...");for(let Ye=0;Ye<e.locations.length;Ye++){const Je=e.locations[Ye];let Ke=0===Ye&&"video"===Je.file_type?"active":"",Ze=Je.file_name.replace(/\.\w+$/,".jpg");if("video"===Je.file_type){sceneType="video";const et=Ze.split(".").slice(0,-1).join(".");ke+=`<li class="${Ke}" data-file="${Je.file_name}" data-id="${Je.id}" data-order_index="${Je.order_index}" data-type="${Je.file_type}">\n                            <span class="icon-video">${Je.duration}</span>\n                            <div>${Je.location_title}</div>\n                            <img src="${t}video/${et}.jpg" alt="" />\n                        </li>`}else{sceneType="image";const tt=Je.file_name.split(".").slice(0,-1).join(".");ke+=`<li class="${Ke}" data-file="${Je.file_name}" data-id="${Je.id}" data-order_index="${Je.order_index}" data-type="${Je.file_type}">\n                            <div>${Je.location_title}</div>\n                            <img src="${t}img/${tt}-low.jpg" alt="" />\n                        </li>`}}function Te(e){listItems.forEach((e=>{e.classList.remove("active")})),e.classList.add("active");const t=e.getAttribute("data-order_index");qe(parseInt(t))}document.querySelector("#locationlist").innerHTML=ke,(listItems=document.querySelectorAll("#locationlist li")).forEach((e=>{e.addEventListener("click",(function(){Te(e)})),e.addEventListener("touchstart",(function(){Te(e)})),e.addEventListener("selectend",(function(){Te(e)}))}))}function qe(o){T.innerHTML="",p.classList.remove("infoshow");let a=e.locations.find((e=>e.order_index===o)),i=a.file_name,s=a.file_type,r=a.info;if("video"===s){if(me===i)return;sceneType="video";let f=i;fe.material.map=null,ue.pause(),ue.src="",me="";const g=a.file_name.split(".").slice(0,-1).join(".");if(highSpeed||(f=g+"-low.mp4",function(e,n){const o=document.createElement("video");o.src=t+"video/"+n,o.addEventListener("canplay",(function(){const t=setInterval((function(){if(4===o.readyState){clearInterval(t),e.pause();let n=e.currentTime;e.src="",e.src=o.src,e.currentTime=n,e.play(),console.log("High-quality video loaded and switched.")}}),100)}))}(ue,i)),ue.src=t+"video/"+f,ue.load(),ue.crossOrigin="anonymous",ue.loop=!0,ue.playsInline=!0,ue.play(),me=i,""!==a.captions){b.style.display="block";const q=document.querySelector("#captionselect ul");let R="";a.captions.forEach((e=>{R+=`<li data-caption="${e}" data-id="${a.id}">${e}</li>`})),R+='<li id="captionoff" class="active">Captions off</li>',q.innerHTML=R;const H=document.querySelectorAll("#captionselect ul li");function c(n){const o=n.target.getAttribute("data-id");let a=e.locations.find((e=>e.id===parseInt(o)));const i=n.target.getAttribute("data-caption"),s=a.file_name.split(".").slice(0,-1).join("."),r=`${t}video/${s}-${i}.srt`;console.log(r),S.style.display="block",H.forEach((e=>{e.classList.remove("active")})),n.target.classList.add("active"),b.classList.add("on"),fetch(r).then((e=>e.blob())).then((e=>{!function(e){const t=new FileReader;t.onload=function(e){const t=function(e){const t=e.trim().split(/\r?\n/),n=[];let o={};for(let e=0;e<t.length;e++){const a=t[e].trim();if(a)if(o.id)if(o.start)o.text?(n.push(o),o={}):o.text=a;else{const e=a.split(" --\x3e ");if(2!==e.length){o={};continue}o.start=Ge(e[0]),o.end=Ge(e[1])}else o.id=parseInt(a)}return console.log(n),n}(e.target.result);console.log(t),function(e){ue.addEventListener("timeupdate",(function(){const t=ue.currentTime,n=document.getElementById("caption");for(const o of e)if(t>=o.start&&t<=o.end)return void(n.innerHTML=`<p>${o.text}</p>`);n.innerHTML=""}))}(t)},t.readAsText(e)}(e)})).catch((e=>{console.error("Error fetching or converting SRT file:",e)}))}H.forEach((e=>{e.addEventListener("click",c),e.addEventListener("touchstart",c),e.addEventListener("selectstart",c)}));const I=document.querySelector("#captionoff");function l(){H.forEach((e=>{e.classList.remove("active")})),I.classList.add("active"),b.classList.remove("on"),S.style.display="none"}I.addEventListener("click",l),I.addEventListener("touchstart",l),I.addEventListener("selectstart",l)}else b.style.display="none";function d(){"none"===x.style.display?x.style.display="block":x.style.display="none"}function u(){L.classList.contains("playing")?(L.classList.remove("playing"),ue.pause()):(L.classList.add("playing"),ue.play())}L.classList.add("playing"),b.addEventListener("click",d),b.addEventListener("touchstart",d),b.addEventListener("selectstart",d),L.addEventListener("click",u),L.addEventListener("touchstart",u),L.addEventListener("selectstart",u);const k=document.querySelector("#currenttime");function m(){const e=parseFloat(w.value);ue.currentTime=e*ue.duration;const t=E(ue.currentTime);k.textContent=t}function v(){ue.removeEventListener("timeupdate",(()=>{})),m()}function E(e){const t=Math.floor(e/3600),n=Math.floor(e%3600/60),o=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}ue.addEventListener("timeupdate",(()=>{const e=ue.currentTime/ue.duration;w.value=e.toFixed(2);const t=E(ue.currentTime);k.textContent=t})),w.addEventListener("input",m),w.addEventListener("mousedown",v),w.addEventListener("touchstart",v),w.addEventListener("selectstart",v),h.style.display="flex",pe=new THREE.VideoTexture(ue),pe.encoding=THREE.LinearEncoding,pe.needsUpdate=!0,pe.wrapS=THREE.RepeatWrapping,pe.repeat.x=-1,pe.mapping=THREE.UVMapping,pe.encoding=THREE.sRGBEncoding,pe.gammaFactor=2.2,fe.material.map=pe,fe.material.needsUpdate=!0}else if("image"===s){sceneType="image",h.style.display="none",fe.material.map=null,ue.pause(),ue.src="",me="";const $=a.file_name.split(".").slice(0,-1).join(".");let C=t+"img/"+i;highSpeed||(C=t+"img/"+$+"-low.jpg");const _=(new THREE.TextureLoader).load(`${C}`,(function(e){e.wrapS=THREE.RepeatWrapping,e.repeat.x=-1,e.mapping=THREE.UVMapping,e.encoding=THREE.sRGBEncoding,e.gammaFactor=2.2}));if(fe.material.map=_,fe.material.needsUpdate=!0,!highSpeed){!function(e,t){const n=new Image;n.src=e,n.onload=function(){const e=new THREE.Texture(n);e.needsUpdate=!0,e.wrapS=THREE.RepeatWrapping,e.repeat.x=-1,e.mapping=THREE.UVMapping,e.encoding=THREE.sRGBEncoding,e.gammaFactor=2.2,t(e)}}(t+"img/"+i,(function(e){fe.material.map=e,fe.material.needsUpdate=!0}))}}else console.log("Invalid file type");""!==r&&null!=r?(z.innerHTML=r,p.style.display="block",y.style.display="block",y.style.opacity="1"):(p.style.display="none",y.style.opacity="0",y.style.display="none"),re.updateProjectionMatrix(),markerData=a.markers,ge.clear(),""!==markerData&&null!=markerData&&async function(e){e.forEach(((e,t)=>{const{marker_title:n,pos_x:o,pos_y:a,pos_z:i,info:s,link:r,sound:c,autoplay:l,customcss:d}=e,u=new THREE.Vector3(o,a,i);"string"!=typeof r||""===r||isNaN(r)?"string"==typeof r&&""!==r?((marker=document.createElement("a")).href=r,marker.target="_blank",marker.classList.add("extlink")):(marker=document.createElement("div")).classList.add("infodot"):((marker=document.createElement("div")).dataset.order_index=parseInt(r),marker.classList.add("intlink"));let m=t;if(marker.id="marker"+m,""!==d&&null!==d){var p=JSON.parse(d);console.log(p);var y="";p.forEach(((e,t)=>{y+="#marker"+m+e,t!==p.length-1&&(y+=" ")}));var v=document.querySelector("style[data-customcss]");if(v)v.textContent+=y;else{var E=document.createElement("style");E.textContent=y,E.setAttribute("data-customcss",""),document.head.appendChild(E)}}marker.classList.add("marker");let f=`<span class="hint">${n}</span><div class="marker-container"></div>`;marker.innerHTML=f,marker.querySelector(".marker-container").insertAdjacentHTML("afterbegin",s);const g=new CSS2DObject(marker);g.position.copy(u),ge.add(g)}));const t=()=>new Promise((e=>{const t=setInterval((()=>{const o=document.querySelectorAll(".intlink"),a=document.querySelectorAll(".infodot");if(o.length>0&&a.length>0){clearInterval(t),o.forEach((e=>{e.addEventListener("click",(t=>{t.preventDefault();const n=e.getAttribute("data-order_index");qe(parseInt(n))}))})),a.forEach((e=>{e.addEventListener("click",(t=>{if(!t.target.closest(".marker-container")){t.preventDefault();let n=e.querySelector(".hint"),o=e.querySelector(".marker-container");"none"===getComputedStyle(o).display?(o.style.display="block",n.style.display="none"):(o.style.display="none",n.style.display="block")}}))}));document.querySelectorAll(".zoom-image").forEach((e=>{e.addEventListener("click",(function(){const t=document.createElement("div"),o=e.cloneNode(!0),a="zoom-div-"+Date.now();t.id=a,t.classList.add("zoomedimage"),o.classList.remove("zoom-image"),t.appendChild(o),n.appendChild(t),t.addEventListener("click",(function(){n.removeChild(t)}))}))})),e()}}),25)}));await t(),console.log("Event listeners added to markers.")}(markerData).then((()=>{console.log("Markers created and event listeners added.")}))}parseFloat(i.value);document.addEventListener("wheel",(function(e){if(function(e){if(e&&e.target){const t=e.target;return null!==t.closest("#scrollable")||null!==t.closest("#info")||null!==t.closest(".marker-container")||null!==t.closest("#comments")}return!1}(e))return;const t=.1*e.deltaY,n=-de.object.position.length();de.rotateSpeed=.005*n,ie+=.1*t,ie=Math.max(10,Math.min(90,ie)),re.aspect=window.innerWidth/window.innerHeight,re.fov=ie,re.updateProjectionMatrix(),i.value=(ie-10)/80})),i.addEventListener("input",(function(){const e=parseFloat(i.value),t=10+80*e,n=de.maxDistance,o=de.minDistance,a=o+e*(n-o);re.fov=t,re.maxDistance=a,re.updateProjectionMatrix()})),d.textContent="↑",o.appendChild(d),d.addEventListener("click",(()=>{Ie()}));re.rotation.clone(),re.position.clone();const Re=new THREE.Vector3(0,0,0),He=(new THREE.Quaternion).setFromEuler(new THREE.Euler(0,0,0));function Ie(e=Re,t=He){const n=(new THREE.Quaternion).setFromEuler(re.rotation.clone()),o=(new THREE.Quaternion).setFromEuler(t),a=re.position.clone(),i=e.clone(),s=performance.now();!function e(){const t=performance.now()-s,r=Math.min(t/1e3,1);re.quaternion.slerpQuaternions(n,o,r),re.position.lerpVectors(a,i,r),de.target.copy(re.position).add(new THREE.Vector3(0,0,-1).applyQuaternion(re.quaternion));const c=-Math.atan2(re.position.x,re.position.z);d.style.transform=`translate(-50%, -50%) rotate(${c}rad)`,t<1e3&&requestAnimationFrame(e)}()}function $e(){document.fullscreenElement?document.exitFullscreen&&(c.classList.remove("fullscreen"),document.exitFullscreen(),n.classList.remove("rootfullscreen")):(document.documentElement.requestFullscreen(),c.classList.add("fullscreen"),n.classList.add("rootfullscreen"))}c.addEventListener("click",$e),c.addEventListener("touchstart",$e),c.addEventListener("selectstart",$e),window.addEventListener("resize",(function(e){if(re.aspect=window.innerWidth/window.innerHeight,re.updateProjectionMatrix(),ce.setSize(window.innerWidth,window.innerHeight),le.setSize(window.innerWidth,window.innerHeight),ce.setPixelRatio(window.devicePixelRatio),Se(),0!==l.style.bottom){let e=l.getBoundingClientRect().height;l.style.bottom="-"+e+"px"}Oe()})),k.addEventListener("wheel",(function(e){e.preventDefault();const t=e.deltaY;k.scrollLeft+=t}));let Ce,_e,Me=!1;function Fe(){Me=!1,k.style.cursor="grab"}function je(e){if(!Me)return;const t=3*(e.pageX-k.offsetLeft-Ce);k.scrollLeft=_e-t}function Be(){document.getElementsByTagName("canvas")[0].style.filter="contrast(1) brightness(1) saturate(1)",$.value="3.5",j.textContent="3.5",we(3.5),R.value="1",_.textContent="1",H.value="1",M.textContent="1",I.value="1",F.textContent="1",C.value="1",B.textContent="1",ue.volume="1"}function De(){D.style.opacity="1",q.style.right="-640px"}function Ae(){y.style.opacity="0",p.classList.add("infoshow")}function Pe(){g.style.opacity="0",f.classList.add("commentshow")}function Xe(){y.style.opacity="1",p.classList.remove("infoshow")}function We(){g.style.opacity="1",f.classList.remove("commentshow")}k.addEventListener("mousedown",(function(e){e.preventDefault(),Me=!0,Ce=e.pageX-k.offsetLeft,_e=k.scrollLeft,k.style.cursor="grabbing"})),k.addEventListener("touchstart",(function(e){e.preventDefault(),Me=!0,Ce=e.pageX-k.offsetLeft,_e=k.scrollLeft,k.style.cursor="grabbing"})),k.addEventListener("mouseup",Fe),k.addEventListener("touchstart",Fe),k.addEventListener("mouseleave",Fe),k.addEventListener("mousemove",(e=>{je(e)})),k.addEventListener("touchmove",(e=>{je(e)})),C.addEventListener("input",(()=>{const e=C.value;ue.volume=e,B.textContent=e})),$.addEventListener("input",(()=>{const e=$.value;we(e),j.textContent=e})),R.addEventListener("input",(()=>{const e=document.getElementsByTagName("canvas")[0],t=e.style.filter||"contrast(1) brightness(1) saturate(1)",n=parseFloat(t.match(/contrast\((\d+(\.\d+)?)\)/)[1]),o=parseFloat(t.match(/saturate\((\d+(\.\d+)?)\)/)[1]),a=R.value;e.style.filter=`contrast(${n}) brightness(${a}) saturate(${o})`,_.textContent=a})),H.addEventListener("input",(()=>{const e=document.getElementsByTagName("canvas")[0],t=e.style.filter||"contrast(1) brightness(1) saturate(1)",n=parseFloat(t.match(/brightness\((\d+(\.\d+)?)\)/)[1]),o=parseFloat(t.match(/saturate\((\d+(\.\d+)?)\)/)[1]),a=H.value;e.style.filter=`contrast(${a}) brightness(${n}) saturate(${o})`,M.textContent=a})),I.addEventListener("input",(()=>{const e=document.getElementsByTagName("canvas")[0],t=e.style.filter||"contrast(1) brightness(1) saturate(1)",n=parseFloat(t.match(/brightness\((\d+(\.\d+)?)\)/)[1]),o=parseFloat(t.match(/contrast\((\d+(\.\d+)?)\)/)[1]),a=I.value;e.style.filter=`contrast(${o}) brightness(${n}) saturate(${a})`,F.textContent=a})),A.addEventListener("click",Be),A.addEventListener("touchstart",Be),A.addEventListener("selectstart",Be),P.addEventListener("click",De),P.addEventListener("touchstart",De),P.addEventListener("selectstart",De),y.addEventListener("click",Ae),y.addEventListener("touchstart",Ae),y.addEventListener("selectstart",Ae),g.addEventListener("click",Pe),g.addEventListener("touchstart",Pe),g.addEventListener("selectstart",Pe),m.addEventListener("click",Xe),m.addEventListener("touchstart",Xe),m.addEventListener("selectstart",Xe),E.addEventListener("click",We),E.addEventListener("touchstart",We),E.addEventListener("selectstart",We),document.addEventListener("DOMContentLoaded",(function(){!function t(){const n=document.querySelector("#locations .container ul li:first-child");if(n){const t=e.locations[0].order_index;qe(parseInt(t)),n.classList.add("active")}else setTimeout(t,1e3)}()}));const ze=document.getElementById("map"),Ne=document.getElementById("mapimage"),Ve=document.getElementById("mapimg");Ve.src="https://snallapojkar.se/360/img/"+e.project.map_filename,e.project.map_links.forEach((e=>{let t=`<div class="maplink ${e.pos_left>50?" linktextleft":""}" data-id="${e.link_location_id}" data-order_index="${e.link_order_index}" style="top: ${e.pos_top}%; left: ${e.pos_left}%">\n            <span class="hint">${e.link_title}</span>\n        </div>`;Ne.insertAdjacentHTML("beforeend",t)}));function Oe(){Ne.style.width="100%",Ne.style.height="100%";const e=Ne.clientWidth,t=Ne.clientHeight,n=Ve.naturalWidth,o=Ve.naturalHeight;let a,i;e/t<n/o?(a=e,i=e/n*o):(i=t,a=t/o*n),Ne.style.width=a+"px",Ne.style.height=i+"px"}function Ue(){"none"===ze.style.display?(ze.style.display="flex",Oe()):ze.style.display="none"}function Ge(e){console.log(e);const[t,n,o]=e.split(":").map(parseFloat);let[a,i]=[0,0];if("string"==typeof o&&o.includes(",")){const e=o.split(",");a=parseFloat(e[0]),i=parseFloat(e[1])}else a=parseFloat(o);return 3600*t+60*n+a+i/1e3}document.querySelectorAll(".maplink").forEach((e=>{e.addEventListener("click",(e=>{const t=parseInt(e.target.getAttribute("data-order_index"));ze.style.display="none",listItems.forEach((e=>{e.classList.remove("active")}));document.querySelector(`#locations [data-id="${t}"]`).classList.add("active"),console.log(t),qe(parseInt(t))}))})),s.addEventListener("click",Ue),s.addEventListener("touchstart",Ue),s.addEventListener("selectstart",Ue),Oe(),navigator.userAgent.toLowerCase().match(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i)&&(console.log("You are using a mobile device."),window.addEventListener("deviceorientation",(function(e){re.rotation.x=e.beta*Math.PI/180,re.rotation.y=e.gamma*Math.PI/180,re.rotation.z=e.alpha*Math.PI/180})))}xhrSend("POST",file,data).then((e=>{console.log(e),start(e)})).catch((e=>{console.error("XHR request failed:",e)}));