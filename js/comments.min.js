import{getTimeAgo,formatNumber,xhrSend}from"./functions.min.js";import{installEmoji}from"./emoji.min.js";export function buildComments(t,e,n){const r=t.id,l=t.allowcomments,o=t.total_comments,a=t.comments;var i,s;function c(t){return t.replace(/([\u{1F300}-\u{1F6FF}\u{1F900}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}])/gu,'<span class="emoji">$1</span>')}function d(t){try{t.map((t=>{let e=t.user_id;i+=`<div class="comment" data-id="${t.id}">\n\t\t\t\t<a href="${p+t.username}" class="thumb"  target="_blank">\n\t\t\t\t\t<img src="${t.thumbnail}" alt="" />\n\t\t\t\t</a>\n\t\t\t\t<div class="commentinfo">\n\t\t\t\t\t<a href="${p+t.username}" class="profilename" target="_blank">\n\t\t\t\t\t\t${t.username}`,e===m&&(i+='<span class="creator">· Creator</span>'),i+=`</a>\n\t\t\t\t\t<p class="message">${c(t.comment)}</p>\n\t\t\t\t\t<span class="timeago">${getTimeAgo(t.registered)}</span>\n\t\t\t\t\t<a href="#like" class="likecomment${t.has_liked?" likedcomment":""}" data-hasliked="${t.has_liked}" data-id="${t.id}">\n\t\t\t\t\t\t<svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t\t\t\t<rect fill="none" height="256" width="256" />\n\t\t\t\t\t\t\t<path\n\t\t\t\t\t\t\t\td="M176,32a60,60,0,0,0-48,24A60,60,0,0,0,20,92c0,71.9,99.9,128.6,104.1,131a7.8,7.8,0,0,0,3.9,1,7.6,7.6,0,0,0,3.9-1,314.3,314.3,0,0,0,51.5-37.6C218.3,154,236,122.6,236,92A60,60,0,0,0,176,32Z"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t<span>\n\t\t\t\t\t\t${formatNumber(t.likes_count).trim()}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</a>\n\t\t\t\t\t<a href="#reply" class="replybtn" data-id="${t.id}" data-name="${t.username}">Reply</a>\n\t\t\t\t</div>\n\t\t\t</div>`,t.reply_count>0&&(i+=`<div class="replies" data-parent_id="${t.id}" data-reply_count="${t.reply_count}">\n\t\t\t\t\t<div class="btn-showreplies" data-parent_id="${t.id}" data-reply_count="${t.reply_count}">+ View ${t.reply_count} replies</div>\n\t\t\t\t\t<div class="replies-container" data-parent_id="${t.id}" data-reply_count="${t.reply_count}"></div>\n\t\t\t\t</div>`)}))}catch(t){console.error("Error occurred during mapping:",t)}}console.log("Building comments...");const m=e.id,p="https://360.com/profile/",u=document.querySelector("#comments");if(u.innerHTML="",i=`<h4 class="amount-comments">${o} comments</h4>\n                <div id="closecommentsbtn"></div><div class="container">`,l){d(a);const t=document.querySelectorAll(".comment:not(.reply)");o>t&&(i+='<div class="btn-showmorecomments">Show more</div>')}else i+='<div style="padding:2rem;">Creator has disabled comments.</div>';i+='</div>\n            <div class="writecomment">\n                <div class="thumb"></div>\n                <div id="emojiplugin"></div>\n            </div>',u.innerHTML=i,console.log("Building comments complete...");var h=document.querySelector(".btn-showmorecomments");if(h){h.addEventListener("click",(function t(){h=document.querySelector(".btn-showmorecomments");var e=document.querySelectorAll(".comment");const l=e.length,a="id="+r+"&user="+n.id+"&offset="+l,s=h.cloneNode(!0);h.remove(),xhrSend("POST","../php/morecomments.php",a).then((n=>{i="",d(n),u.querySelector(".container").insertAdjacentHTML("beforeend",i),i="",(e=document.querySelectorAll(".comment")).length<o&&(u.querySelector(".container").insertAdjacentElement("beforeend",s),(h=document.querySelector(".btn-showmorecomments")).addEventListener("click",t)),g(),y()})).catch((t=>{console.error("XHR request failed:",t)}))}))}function y(){const t=document.querySelectorAll(".replybtn"),e=document.querySelector("#commentInputField"),n=document.querySelectorAll(".likecomment");function r(t){let n=t.target.getAttribute("data-name"),r=t.target.getAttribute("data-id");e.placeholder="Reply to "+n,e.dataset.replytoid=r,e.focus()}function l(t){t.preventDefault();let e=t.target.closest(".likecomment"),n=e.querySelector("span"),r=parseInt(n.textContent.trim());r+=e.classList.toggle("likedcomment")?1:-1,n.textContent=r.toString()}t.forEach((t=>{t.onclick=null,t.removeEventListener("click",r),t.addEventListener("click",r)})),n.forEach((t=>{let e=t.cloneNode(!0);t.parentNode.replaceChild(e,t),e.addEventListener("click",l)}))}function g(){document.querySelectorAll(".btn-showreplies").forEach((t=>{t.removeEventListener("click",v),t.addEventListener("click",v)}));document.querySelectorAll(".btn-showmorereplies").forEach((t=>{t.removeEventListener("click",v),t.addEventListener("click",v)}));document.querySelectorAll(".hide-replies").forEach((t=>{t.removeEventListener("click",f),t.addEventListener("click",f)}))}function v(t){let r,l,o,a;if(t.preventDefault(),"btn-showmorereplies"===t.target.className?(r=t.target.parentNode.getAttribute("data-parent_id"),l=t.target.parentNode.parentNode.querySelector(".replies-container"),o=l.getAttribute("data-reply_count"),a=l.querySelectorAll(".reply")):(r=t.target.getAttribute("data-parent_id"),l=t.target.parentNode.querySelector(".replies-container"),o=l.getAttribute("data-reply_count"),a=l.querySelectorAll(".reply")),"btn-showmorereplies"!==t.target.className&&a.length>0)return l.style.display="block",t.target.style.display="none",t.target.parentNode.querySelector(".hide-replies").style.display="block",void y();let i=a.length;const d="id="+r+"&user="+n.id+"&offset="+i;xhrSend("POST","../php/morereplies.php",d).then((n=>{s="",function(t){t.map((t=>{let n=t.user_id;s+=`<div class="comment reply" data-id="${t.id}" data-reply_id="${t.reply_id}" data-parent_id="${t.parent_id}">\n\t\t\t\t\t\t<a href="${p+t.username}" class="thumb" target="_blank"><img src="${t.thumbnail}" alt="" /></a>\n\t\t\t\t\t\t<div class="commentinfo">\n\t\t\t\t\t\t\t<div class="repliedto">\n\t\t\t\t\t\t\t\t<a href="${p+t.username}" class="profilename" target="_blank">${t.username}`,n===m&&(s+='<span class="creator">· Creator</span>'),s+=`</a> > <a href="${p+t.reply_username}" class="profilename replyto" target="_blank">${t.reply_username}`,t.reply_username===e.username&&(s+='<span class="creator">· Creator</span>'),s+=`</a>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p class="message">${c(t.comment)}</p>\n\t\t\t\t\t\t\t<span class="timeago">${getTimeAgo(t.registered)}</span>\n\t\t\t\t\t\t\t<a href="#like" class="likecomment${t.has_liked?" likedcomment":""}" data-hasliked="${t.has_liked}" data-id="${t.id}">\n\t\t\t\t\t\t\t\t<svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t\t\t\t\t\t<rect fill="none" height="256" width="256" />\n\t\t\t\t\t\t\t\t\t<path\n\t\t\t\t\t\t\t\t\t\td="M176,32a60,60,0,0,0-48,24A60,60,0,0,0,20,92c0,71.9,99.9,128.6,104.1,131a7.8,7.8,0,0,0,3.9,1,7.6,7.6,0,0,0,3.9-1,314.3,314.3,0,0,0,51.5-37.6C218.3,154,236,122.6,236,92A60,60,0,0,0,176,32Z"\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t\t<span>\n\t\t\t\t\t\t\t\t${formatNumber(t.likes_count).trim()}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t\t<a href="#reply" class="replybtn" data-id="${t.id}" data-parent_id="${t.parent_id}" data-name="${t.username}">Reply</a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\n\t\t\t\t\t</div>`})),s+='</div><div class="hide-replies">- Hide replies</div>'}(n);let r=l.querySelector(".hide-replies"),a=t.target.closest(".btn-showmorereplies");t.target.closest(".btn-showmorereplies")?a.insertAdjacentHTML("beforebegin",s):r?r.insertAdjacentHTML("beforebegin",s):l.insertAdjacentHTML("beforeend",s);let i=l.querySelectorAll(".reply");if(s="",l?(l.style.display="block",t.target.style.display="none",t.target.parentNode.querySelector(".hide-replies").style.display="block",g(),y()):console.error("Replies container not found."),o>i.length){if(!t.target.querySelector(".btn-showmorereplies")){let t='<div class="btn-showmorereplies">Show more</div>';r=l.querySelector(".hide-replies"),r.insertAdjacentHTML("beforebegin",t)}}else if(o<=i.length){let t=document.querySelector(".btn-showmorereplies");t&&t.remove()}const d=l.querySelectorAll(".hide-replies");for(let t=1;t<d.length;t++)d[t].remove();g(),y()})).catch((t=>{console.error("XHR request failed:",t)}))}function f(t){t.preventDefault();let e=t.target.closest(".replies-container");e?(t.target.parentNode.parentNode.querySelector(".btn-showreplies").style.display="block",e.style.display="none",t.target.style.display="none"):console.error("Replies container not found.")}g();const b=document.querySelector(".writecomment");if(n){let t=`<a href="https://360.com/profile/${n.username}" target="_blank" class="thumb">\n\t\t\t\t<img src="${n.thumbnail}" alt="" /></a><div id="emojiplugin"></div>`;b.innerHTML=t,installEmoji("emojiplugin"),y();let e=document.querySelector("#commentInputField");e.addEventListener("keydown",(t=>{"Escape"===t.key&&(delete e.dataset.replytoid,e.placeholder="Write your comment",e.value="",e.blur())}))}else{const t="<p>Need to login. Put login signup stuff here.</p>";b.innerHTML=t}}