import{getTimeAgo,formatNumber,xhrSend}from"./functions.min.js";import{installEmoji}from"./emoji.min.js";export function buildComments(t,e,n){const r=t.id,a=t.allowcomments,s=t.total_comments,i=t.comments;var o,l;function c(t){return t.replace(/([\u{1F300}-\u{1F6FF}\u{1F900}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}])/gu,'<span class="emoji">$1</span>')}function d(t){try{t.map((t=>{let e=t.user_id;o+=`<div class="comment" data-id="${t.id}">\n\t\t\t\t<a href="${p+t.username}" class="thumb"  target="_blank">\n\t\t\t\t\t<img src="${t.thumbnail}" alt="" />\n\t\t\t\t</a>\n\t\t\t\t<div class="commentinfo">\n\t\t\t\t\t<a href="${p+t.username}" class="profilename" target="_blank">\n\t\t\t\t\t\t${t.username}`,e===m&&(o+='<span class="creator">· Creator</span>'),o+=`</a>\n\t\t\t\t\t<p class="message">${c(t.comment)}</p>\n\t\t\t\t\t<span class="timeago">${getTimeAgo(t.registered)}</span>\n\t\t\t\t\t<a href="#like" class="likecomment${t.has_liked?" likedcomment":""}" data-hasliked="${t.has_liked}" data-id="${t.id}">\n\t\t\t\t\t\t<svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t\t\t\t<rect fill="none" height="256" width="256" />\n\t\t\t\t\t\t\t<path\n\t\t\t\t\t\t\t\td="M176,32a60,60,0,0,0-48,24A60,60,0,0,0,20,92c0,71.9,99.9,128.6,104.1,131a7.8,7.8,0,0,0,3.9,1,7.6,7.6,0,0,0,3.9-1,314.3,314.3,0,0,0,51.5-37.6C218.3,154,236,122.6,236,92A60,60,0,0,0,176,32Z"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t<span>\n\t\t\t\t\t\t${formatNumber(t.likes_count).trim()}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</a>\n\t\t\t\t\t<a href="#reply" class="replybtn" data-id="${t.id}" data-name="${t.username}">Reply</a>\n\t\t\t\t</div>\n\t\t\t</div>`,t.reply_count>0&&(o+=`<div class="replies" data-parent_id="${t.id}">\n\t\t\t\t<div class="btn-showreplies" data-parent_id="${t.id}">+ View ${t.reply_count} replies</div>\n\t\t\t\t<div class="replies-container" data-parent_id="${t.id}"></div>\n\t\t\t</div>`)}))}catch(t){console.error("Error occurred during mapping:",t)}}console.log("Building comments...");const m=e.id,p="https://360.com/profile/",u=document.querySelector("#comments");u.innerHTML="",o=`<h4 class="amount-comments">${s} comments</h4>\n                <div id="closecommentsbtn"></div><div class="container">`,a?(d(i),s>1&&(o+='<div class="btn-showmorecomments">Show more</div>')):o+='<div style="padding:2rem;">Creator has disabled comments.</div>',o+='</div>\n            <div class="writecomment">\n                <div class="thumb"></div>\n                <div id="emojiplugin"></div>\n            </div>',u.innerHTML=o,console.log("Building comments complete...");var h=document.querySelector(".btn-showmorecomments");if(h){h.addEventListener("click",(function t(){h=document.querySelector(".btn-showmorecomments");var e=document.querySelectorAll(".comment");const a=e.length,i="id="+r+"&user="+n.id+"&offset="+a,l=h.cloneNode(!0);h.remove(),xhrSend("POST","../php/morecomments.php",i).then((n=>{console.log(n),o="",d(n),u.querySelector(".container").insertAdjacentHTML("beforeend",o),o="",(e=document.querySelectorAll(".comment")).length<s&&(u.querySelector(".container").insertAdjacentElement("beforeend",l),(h=document.querySelector(".btn-showmorecomments")).addEventListener("click",t)),g()})).catch((t=>{console.error("XHR request failed:",t)}))}))}function g(){document.querySelectorAll(".btn-showreplies").forEach((t=>{t.removeEventListener("click",v),t.addEventListener("click",v)}));document.querySelectorAll(".hide-replies").forEach((t=>{t.removeEventListener("click",y),t.addEventListener("click",y)}))}function v(t){t.preventDefault();let r=t.target.getAttribute("data-parent_id"),a=t.target.parentNode.querySelector(".replies-container");const s=a.querySelectorAll("*");if(s.length>0)return a.style.display="block",t.target.style.display="none",void(t.target.parentNode.querySelector(".hide-replies").style.display="block");let i=s.length;const o="id="+r+"&user="+n.id+"&offset="+i;xhrSend("POST","../php/morereplies.php",o).then((n=>{console.log(n),l="",function(t){t.map((t=>{let n=t.user_id;l+=`<div class="comment reply" data-id="${t.id}" data-reply_id="${t.reply_id}" data-parent_id="${t.parent_id}">\n\t\t\t\t\t\t<a href="${p+t.username}" class="thumb" target="_blank"><img src="${t.thumbnail}" alt="" /></a>\n\t\t\t\t\t\t<div class="commentinfo">\n\t\t\t\t\t\t\t<div class="repliedto">\n\t\t\t\t\t\t\t\t<a href="${p+t.username}" class="profilename" target="_blank">${t.username}`,n===m&&(l+='<span class="creator">· Creator</span>'),l+=`</a> > <a href="${p+t.reply_username}" class="profilename replyto" target="_blank">${t.reply_username}`,t.reply_username===e.username&&(l+='<span class="creator">· Creator</span>'),l+=`</a>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p class="message">${c(t.comment)}</p>\n\t\t\t\t\t\t\t<span class="timeago">${getTimeAgo(t.registered)}</span>\n\t\t\t\t\t\t\t<a href="#like" class="likecomment${t.has_liked?" likedcomment":""}" data-hasliked="${t.has_liked}" data-id="${t.id}">\n\t\t\t\t\t\t\t\t<svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t\t\t\t\t\t<rect fill="none" height="256" width="256" />\n\t\t\t\t\t\t\t\t\t<path\n\t\t\t\t\t\t\t\t\t\td="M176,32a60,60,0,0,0-48,24A60,60,0,0,0,20,92c0,71.9,99.9,128.6,104.1,131a7.8,7.8,0,0,0,3.9,1,7.6,7.6,0,0,0,3.9-1,314.3,314.3,0,0,0,51.5-37.6C218.3,154,236,122.6,236,92A60,60,0,0,0,176,32Z"\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t\t<span>\n\t\t\t\t\t\t\t\t${formatNumber(t.likes_count).trim()}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t\t<a href="#reply" class="replybtn" data-id="${t.id}" data-parent_id="${t.parent_id}" data-name="${t.username}">Reply</a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\n\t\t\t\t\t</div>`})),l+='</div><div class="hide-replies">- Hide replies</div>'}(n);const r=a.querySelector(".hide-replies");r?r.insertAdjacentHTML("beforebegin",l):a.insertAdjacentHTML("beforeend",l),l="",a?(a.style.display="block",t.target.style.display="none",t.target.parentNode.querySelector(".hide-replies").style.display="block",g()):console.error("Replies container not found.")})).catch((t=>{console.error("XHR request failed:",t)}))}function y(t){t.preventDefault();let e=t.target.closest(".replies-container");e?(t.target.parentNode.parentNode.querySelector(".btn-showreplies").style.display="block",e.style.display="none",t.target.style.display="none"):console.error("Replies container not found.")}g();const f=document.querySelector(".writecomment");if(n){let t=`<a href="https://360.com/profile/${n.username}" target="_blank" class="thumb">\n\t\t\t\t<img src="${n.thumbnail}" alt="" /></a><div id="emojiplugin"></div>`;f.innerHTML=t,installEmoji("emojiplugin");const e=document.querySelectorAll(".replybtn"),r=document.querySelector("#commentInputField");e.forEach((t=>{t.addEventListener("click",(t=>{let e=t.target.getAttribute("data-name"),n=t.target.getAttribute("data-id");r.placeholder="Reply to "+e,r.dataset.replytoid=n,r.focus()}))}));document.querySelectorAll(".likecomment").forEach((t=>{t.addEventListener("click",(t=>{t.preventDefault();let e=t.target.closest(".likecomment"),n=e.querySelector("span"),r=parseInt(n.textContent.trim());e.classList.contains("likedcomment")?(e.classList.remove("likedcomment"),r-=1):(e.classList.add("likedcomment"),r+=1),n.textContent=r.toString()}))})),r.addEventListener("keydown",(t=>{"Escape"===t.key&&(delete r.dataset.replytoid,r.placeholder="Write your comment",r.value="",r.blur())}))}else{const t="<p>Need to login. Put login signup stuff here.</p>";f.innerHTML=t}}