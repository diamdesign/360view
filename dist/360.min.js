import*as THREE from"three";import{OrbitControls}from"three/examples/jsm/controls/OrbitControls";import{CSS2DRenderer,CSS2DObject}from"three/addons/renderers/CSS2DRenderer.js";var mapArray=[{file:"map.png",links:[{name:"Bedroom",top:20,left:80,link:2},{name:"Kitchen",top:70,left:50,link:3},{name:"Outside",top:50,left:10,link:4}]}],contentArray=[{id:1,type:"image",file:"360.jpg",title:"One",info:'<h1>One</h1><img src="https://picsum.photos/600/300" alt="" /><hr><p>Lorem ipsum dolor sit, amet consectetur adipisicing elit. <a href="#">Molestiae distinctio</a> optio consequatur eaque eos asperiores quibusdam rem exercitationem maiores aliquid sequi, a, quae aliquam expedita. Blanditiis saepe esse dolorum molestias.</p><ul><li>One</li><li>Two</li></ul><hr><img src="https://picsum.photos/601/301" alt="" /><p>Lorem ipsum dolor sit, amet consectetur adipisicing elit. Molestiae distinctio optio consequatur eaque eos asperiores quibusdam rem exercitationem maiores aliquid sequi, a, quae aliquam expedita. Blanditiis saepe esse dolorum molestias.</p><a href="#" class="button">Testing</a>',markers:[{name:"Some info here",position:{x:10,y:0,z:360},info:'<h1>One</h1><img src="https://picsum.photos/600/300" alt="" /><hr><p>Lorem ipsum dolor sit, amet consectetur adipisicing elit. <a href="#">Molestiae distinctio</a> optio consequatur eaque eos asperiores quibusdam rem exercitationem maiores aliquid sequi, a, quae aliquam expedita. Blanditiis saepe esse dolorum molestias.</p><ul><li>One</li><li>Two</li></ul><hr><img src="https://picsum.photos/601/301" alt="" /><p>Lorem ipsum dolor sit, amet consectetur adipisicing elit. Molestiae distinctio optio consequatur eaque eos asperiores quibusdam rem exercitationem maiores aliquid sequi, a, quae aliquam expedita. Blanditiis saepe esse dolorum molestias.</p><a href="#" class="button">Testing</a>',link:""},{name:"Link to next scene",position:{x:-5,y:0,z:-360},info:"",link:2},{name:"DIAM",position:{x:20,y:-10,z:360},info:"",link:"https://diam.se"}]},{id:2,type:"image",file:"3602.jpg",title:"Two",info:""},{id:3,type:"image",file:"3603.jpg",title:"Three",info:""},{id:4,type:"image",file:"3604.jpg",title:"Four",info:""},{id:5,type:"image",file:"3605.jpg",title:"Five",info:""},{id:6,type:"image",file:"3606.jpg",title:"Six",info:""},{id:7,type:"image",file:"3607.jpg",title:"Seven",info:""},{id:8,type:"video",file:"360_vr_master_series___free_asset_download____bavarian_alps_wimbachklamm (1080p).mp4",duration:"2:00",title:"Bavarian Alps",captions:["Swedish","English"],info:""},{id:9,type:"video",file:"ayutthaya_-_needs_stabilization_and_horizon_correction___360_vr_master_series___free_download (1080p).mp4",duration:"0:30",title:"Ayutthaya",captions:"",info:""},{id:10,type:"video",file:"ayutthaya_-_easy_tripod_paint___360_vr_master_series___free_download (1080p).mp4",duration:"0:25",title:"Ayutthaya Two",captions:"",info:""},{id:11,type:"video",file:"360_vr_master_series___free_download___london_park_ducks_swans (1080p).mp4",duration:"1:05",title:"London Park",captions:"",info:""},{id:12,type:"video",file:"360_vr_master_series___free_download___london_on_tower_bridge (1080p).mp4",duration:"0:29",title:"London Tower Bridge",captions:"",info:""},{id:13,type:"video",file:"360_vr_master_series___free_download___crystal_shower_falls (1080p).mp4",duration:"2:00",title:"Crystal Shower Falls",captions:"",info:""}],markerData=[];function testInternetSpeed(){return new Promise(((e,t)=>{const n=(new Date).getTime(),o=new Image;o.onload=function(){const t=((509064/(((new Date).getTime()-n)/1e3)).toFixed(2)/1024).toFixed(2);e(t)},o.onerror=function(e){t(e)},o.src="img/360-low.jpg?n="+Math.random()}))}var highSpeed=!1;window.addEventListener("load",(function(){testInternetSpeed().then((e=>{console.log("Internet speed:",e,"Kbps"),e>=1e3?(console.log("High-speed connection detected. Load high-quality."),highSpeed=!0):(console.log("Low-speed connection detected. Load low-quality."),highSpeed=!1)})).catch((e=>{console.error("Error testing internet speed:",e)}))}));var sceneType="image";const viewElem=document.getElementById("view-container"),zoomLevel=document.querySelector("#zoombtn"),zoomLevelInput=document.querySelector("#zoomlevel"),mapButton=document.querySelector("#mapbtn"),fullscreenButton=document.querySelector("#fullscreenbtn"),locationsElem=document.getElementById("locations"),angleIndicator=document.getElementById("angleIndicator"),locationsIndicatorElem=document.querySelector("#indicatorbtn"),closeInfoButton=document.querySelector("#closeinfobtn"),infoElem=document.querySelector("#info"),infoButton=document.querySelector("#infobtn"),infoResizer=document.querySelector("#resizer"),videoplayer=document.querySelector("#videoplayer"),playVideoButton=document.querySelector("#playvideo"),videoduration=document.querySelector("#videoduration"),captionHTML=document.querySelector("#caption"),captionButton=document.querySelector("#captionselect"),captionList=document.querySelector("#captionselect ul"),minWidth=460,maxWidth=1800;let startResizeX,startResizeWidth,isResizing=!1;function onResizeDown(e){isResizing=!0,startResizeX=e.clientX||e.touches[0].clientX,startResizeWidth=parseInt(document.defaultView.getComputedStyle(infoElem).width,10),document.body.addEventListener("mousemove",onResizeMove),document.body.addEventListener("touchmove",onResizeMove),document.body.addEventListener("mouseup",onResizeUp),document.body.addEventListener("touchstart",onResizeUp),document.body.addEventListener("selectend",onResizeUp)}function onResizeMove(e){if(!isResizing)return;const t=e.clientX||e.touches[0].clientX;let n=startResizeWidth-(t-startResizeX);n=Math.max(minWidth,Math.min(maxWidth,n)),infoElem.style.width=n+"px"}function onResizeUp(){isResizing=!1,document.removeEventListener("mousemove",onResizeMove),document.removeEventListener("touchmove",onResizeMove),document.removeEventListener("mouseup",onResizeUp),document.removeEventListener("touchstart",onResizeUp),document.removeEventListener("selectend",onResizeUp)}function showLocationsContent(){if(0===parseFloat(locationsElem.style.bottom)){let e=locationsElem.getBoundingClientRect().height;locationsElem.style.bottom="-"+e+"px",locationsIndicatorElem.classList.remove("rotate180")}else locationsIndicatorElem.classList.add("rotate180"),locationsElem.style.bottom="0"}infoResizer.addEventListener("mousedown",onResizeDown),infoResizer.addEventListener("touchstart",onResizeDown),infoResizer.addEventListener("selectstart",onResizeDown),locationsIndicatorElem.addEventListener("click",showLocationsContent),locationsIndicatorElem.addEventListener("touchstart",showLocationsContent),locationsIndicatorElem.addEventListener("selectend",showLocationsContent);const scrollableContent=document.querySelector("#scrollable"),labelContainerElem=document.querySelector("#labels"),settingsElem=document.querySelector("#settings"),settingsBrightness=document.getElementById("brightness"),settingsContrast=document.getElementById("contrast"),settingsSaturate=document.getElementById("saturation"),settingsAmbient=document.getElementById("ambient"),settingsVolume=document.getElementById("volume"),settingsBrightnessNo=document.getElementById("brightnessNo"),settingsContrastNo=document.getElementById("contrastNo"),settingsSaturateNo=document.getElementById("saturationNo"),settingsAmbientNo=document.getElementById("ambientNo"),settingsVolumeNo=document.getElementById("volumeNo"),settingsButton=document.querySelector(".settingsbtn"),resetButton=document.getElementById("reset"),closeSettingsButton=document.querySelector(".closebtn");function viewContainerFadeIn(){locationsElem.style.opacity="1",angleIndicator.style.opacity="1",settingsButton.style.opacity="1",zoomLevel.style.opacity="1",mapButton.style.opacity="1",fullscreenButton.style.opacity="1"}function viewContainerFadeOut(){locationsElem.style.opacity="0",angleIndicator.style.opacity="0",settingsButton.style.opacity="0",zoomLevel.style.opacity="0",mapButton.style.opacity="0",fullscreenButton.style.opacity="0"}let idleTimeout;function showHideContent(){clearTimeout(idleTimeout),"1"!==zoomLevel.style.opacity&&viewContainerFadeIn(),idleTimeout=setTimeout((()=>{viewContainerFadeOut()}),7e3)}function openSettings(){settingsElem.style.right="0px",settingsButton.style.opacity="0"}viewContainerFadeIn(),document.addEventListener("keydown",(e=>{if("h"===e.key||"H"===e.key){const e=document.querySelector("#view-container"),t=document.querySelector("#outside");"none"===e.style.display?(e.style.display="block",t.style.display="block"):(e.style.display="none",t.style.display="none")}})),idleTimeout=setTimeout((()=>{viewContainerFadeOut()}),7e3),document.addEventListener("mousemove",(function(e){showHideContent()})),document.addEventListener("touchmove",(function(e){showHideContent()})),settingsButton.addEventListener("click",openSettings),settingsButton.addEventListener("touchstart",openSettings),settingsButton.addEventListener("selectstart",openSettings);const locationsUl=document.querySelector("#locationlist");contentArray.forEach((e=>{locationsUl.insertAdjacentHTML("afterbegin","<li></li>")}));let perspective=75;const scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(perspective,window.innerWidth/window.innerHeight,.1,1e3),renderer=new THREE.WebGLRenderer({alpha:!1});renderer.setSize(window.innerWidth,window.innerHeight),renderer.setClearColor(0),document.body.appendChild(renderer.domElement);const labelRenderer=new CSS2DRenderer;labelRenderer.setSize(window.innerWidth,window.innerHeight),labelRenderer.domElement.style.position="absolute",labelRenderer.domElement.style.top="0px",labelRenderer.domElement.style.pointerEvents="none",document.body.appendChild(labelRenderer.domElement);const video=document.createElement("video");let currentVideoSrc,texture;const geometry=new THREE.SphereGeometry(360,180,180),blackTexture=new THREE.DataTexture(new Uint8Array([0,0,0]),1,1,THREE.RGBFormat);blackTexture.needsUpdate=!0;const material=new THREE.MeshStandardMaterial({map:blackTexture,side:THREE.DoubleSide}),sphere=new THREE.Mesh(geometry,material);scene.add(sphere);const root=new THREE.Group;scene.add(root);let ambientLight,ambientIntensity=4;function updateLight(e){ambientIntensity=e,ambientLight&&scene.remove(ambientLight),ambientLight=new THREE.AmbientLight(16777215,e),scene.add(ambientLight)}function render(){renderer.render(scene,camera),labelRenderer.render(scene,camera)}function animate(){requestAnimationFrame(animate),controls.update(),render();const e=-Math.atan2(camera.position.x,camera.position.z);angleIndicator.style.transform=`translate(-50%, -50%) rotate(${e}rad)`}function draw(e){controls&&controls.update(),renderer.render(scene,camera);const t=-Math.atan2(camera.position.x,camera.position.z);angleIndicator.style.transform=`translate(-50%, -50%) rotate(${t}rad)`,e.session.requestAnimationFrame(draw)}function onXRFrame(e,t){const n=t.getViewerPose();if(n){const e=n.views;for(let t of e){const e=xrLayer.getViewport(t),n=t.projectionMatrix;renderer.setViewport(e.x,e.y,e.width,e.height),renderer.setProjectionMatrix(n),renderer.render(scene,camera)}}t.session.requestAnimationFrame(onXRFrame)}updateLight(3.5),"xr"in navigator?(console.log("WebXR is supported in this browser."),"requestDevice"in navigator.xr?navigator.xr.requestDevice().then((e=>{console.log("XR device obtained:",e),e.requestSession({immersive:!0}).then((e=>{console.log("XR session started:",e);const t=renderer.getContext(),n=new XRWebGLLayer(e,t);e.updateRenderState({baseLayer:n}),e.requestAnimationFrame(onXRFrame)})).catch((e=>{console.error("Failed to start XR session:",e),animate()}))})).catch((e=>{console.error("Failed to obtain XR device:",e),animate()})):"requestSession"in navigator.xr?navigator.xr.requestSession("immersive-vr").then((e=>{console.log("XR session started:",e);const t=renderer.getContext(),n=new XRWebGLLayer(e,t);e.updateRenderState({baseLayer:n}),e.requestAnimationFrame(onXRFrame)})).catch((e=>{console.error("Failed to start XR session:",e),animate()})):(console.error("WebXR APIs are present, but neither requestDevice nor requestSession methods are available."),animate())):(console.log("WebXR not supported in this browser."),animate());let locationsArray="";for(let e=0;e<contentArray.length;e++){const t=contentArray[e];let n=0===e&&"video"===t.type?"active":"",o=t.file.replace(/\.\w+$/,".jpg");if("video"===t.type){sceneType="video";const e=o.split(".").slice(0,-1).join(".");locationsArray+=`<li class="${n}" data-file="${t.file}" data-id="${t.id}" data-type="${t.type}">\n                            <span class="icon-video">${t.duration}</span>\n                            <div>${t.title}</div>\n                            <img src="video/${e}.jpg" alt="" />\n                        </li>`}else{sceneType="image";const e=t.file.split(".").slice(0,-1).join(".");locationsArray+=`<li class="${n}" data-file="${t.file}" data-id="${t.id}" data-type="${t.type}">\n                            <div>${t.title}</div>\n                            <img src="img/${e}-low.jpg" alt="" />\n                        </li>`}}const locationUl=document.querySelector("#locationlist");locationUl.innerHTML=locationsArray;const listItems=document.querySelectorAll("#locationlist li");function activateItem(e){listItems.forEach((e=>{e.classList.remove("active")})),e.classList.add("active");const t=e.getAttribute("data-id");change360Content(parseInt(t))}function change360Content(e){labelContainerElem.innerHTML="",infoElem.style.right="-600px";let t=contentArray.find((t=>t.id===e)),n=t.file,o=t.type,i=t.info;if("video"===o){if(currentVideoSrc===n)return;sceneType="video";let m=n;sphere.material.map=null,video.pause(),video.src="",currentVideoSrc="";const p=t.file.split(".").slice(0,-1).join(".");if(highSpeed||(m=p+"-low.mp4",function(e,t){const n=document.createElement("video");n.src="video/"+t,n.addEventListener("canplay",(function(){const t=setInterval((function(){if(4===n.readyState){clearInterval(t),e.pause();let o=e.currentTime;e.src="",e.src=n.src,e.currentTime=o,e.play(),console.log("High-quality video loaded and switched.")}}),100)}))}(video,n)),video.src="video/"+m,video.load(),video.crossOrigin="anonymous",video.loop=!0,video.playsInline=!0,video.play(),currentVideoSrc=n,""!==t.captions){captionButton.style.display="block";const v=document.querySelector("#captionselect ul");let f="";t.captions.forEach((e=>{f+=`<li data-caption="${e}" data-id="${t.id}">${e}</li>`})),f+='<li id="captionoff" class="active">Captions off</li>',v.innerHTML=f;const y=document.querySelectorAll("#captionselect ul li");function a(e){const t=e.target.getAttribute("data-id");let n=contentArray.find((e=>e.id===parseInt(t)));const o=e.target.getAttribute("data-caption"),i=`video/${n.file.split(".").slice(0,-1).join(".")}-${o}.srt`;console.log(i),captionHTML.style.display="block",y.forEach((e=>{e.classList.remove("active")})),e.target.classList.add("active"),captionButton.classList.add("on"),fetch(i).then((e=>e.blob())).then((e=>{readSRTFile(e)})).catch((e=>{console.error("Error fetching or converting SRT file:",e)}))}y.forEach((e=>{e.addEventListener("click",a),e.addEventListener("touchstart",a),e.addEventListener("selectstart",a)}));const E=document.querySelector("#captionoff");function s(){y.forEach((e=>{e.classList.remove("active")})),E.classList.add("active"),captionButton.classList.remove("on"),captionHTML.style.display="none"}E.addEventListener("click",s),E.addEventListener("touchstart",s),E.addEventListener("selectstart",s)}else captionButton.style.display="none";function r(){"none"===captionList.style.display?captionList.style.display="block":captionList.style.display="none"}function l(){playVideoButton.classList.contains("playing")?(playVideoButton.classList.remove("playing"),video.pause()):(playVideoButton.classList.add("playing"),video.play())}playVideoButton.classList.add("playing"),captionButton.addEventListener("click",r),captionButton.addEventListener("touchstart",r),captionButton.addEventListener("selectstart",r),playVideoButton.addEventListener("click",l),playVideoButton.addEventListener("touchstart",l),playVideoButton.addEventListener("selectstart",l);const g=document.querySelector("#currenttime");function c(){const e=parseFloat(videoduration.value);video.currentTime=e*video.duration;const t=u(video.currentTime);g.textContent=t}function d(){video.removeEventListener("timeupdate",(()=>{})),c()}function u(e){const t=Math.floor(e/3600),n=Math.floor(e%3600/60),o=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}video.addEventListener("timeupdate",(()=>{const e=video.currentTime/video.duration;videoduration.value=e.toFixed(2);const t=u(video.currentTime);g.textContent=t})),videoduration.addEventListener("input",c),videoduration.addEventListener("mousedown",d),videoduration.addEventListener("touchstart",d),videoduration.addEventListener("selectstart",d),videoplayer.style.display="flex",texture=new THREE.VideoTexture(video),texture.encoding=THREE.LinearEncoding,texture.needsUpdate=!0,texture.wrapS=THREE.RepeatWrapping,texture.repeat.x=-1,texture.mapping=THREE.UVMapping,texture.encoding=THREE.sRGBEncoding,texture.gammaFactor=2.2,sphere.material.map=texture,sphere.material.needsUpdate=!0}else if("image"===o){sceneType="image",videoplayer.style.display="none",sphere.material.map=null,video.pause(),video.src="",currentVideoSrc="";const h=t.file.split(".").slice(0,-1).join(".");let L="img/"+n;highSpeed||(L="img/"+h+"-low.jpg");const w=(new THREE.TextureLoader).load(`${L}`,(function(e){e.wrapS=THREE.RepeatWrapping,e.repeat.x=-1,e.mapping=THREE.UVMapping,e.encoding=THREE.sRGBEncoding,e.gammaFactor=2.2}));if(sphere.material.map=w,sphere.material.needsUpdate=!0,!highSpeed){!function(e,t){const n=new Image;n.src=e,n.onload=function(){const e=new THREE.Texture(n);e.needsUpdate=!0,e.wrapS=THREE.RepeatWrapping,e.repeat.x=-1,e.mapping=THREE.UVMapping,e.encoding=THREE.sRGBEncoding,e.gammaFactor=2.2,t(e)}}("img/"+n,(function(e){sphere.material.map=e,sphere.material.needsUpdate=!0}))}}else console.log("Invalid file type");""!==i&&null!=i?(infoElem.style.display="block",infoButton.style.display="block",infoButton.style.opacity="1",infoElem.querySelector(".container").innerHTML=i):(infoElem.style.display="none",infoButton.style.opacity="0",infoButton.style.display="none"),camera.updateProjectionMatrix(),createMarkers(markerData=t.markers)}listItems.forEach((e=>{e.addEventListener("click",(function(){activateItem(e)})),e.addEventListener("touchstart",(function(){activateItem(e)})),e.addEventListener("selectend",(function(){activateItem(e)}))}));const initialZoomLevel=parseFloat(zoomLevelInput.value);function handleZoom(e){if(isMouseOverScrollableContent(e))return;const t=e.deltaY*zoomSpeed,n=-controls.object.position.length();controls.rotateSpeed=.005*n;perspective+=t*perspectiveFactor,perspective=Math.max(minPerspective,Math.min(maxPerspective,perspective)),camera.aspect=window.innerWidth/window.innerHeight,camera.fov=perspective,camera.updateProjectionMatrix(),zoomLevelInput.value=(perspective-10)/80}function isMouseOverScrollableContent(e){if(e&&e.target){const t=e.target;return null!==t.closest("#scrollable")||null!==t.closest("#info")}return!1}document.addEventListener("wheel",handleZoom),zoomLevelInput.addEventListener("input",(function(){const e=parseFloat(zoomLevelInput.value),t=10+80*e,n=controls.maxDistance,o=controls.minDistance,i=o+e*(n-o);camera.fov=t,camera.maxDistance=i,camera.updateProjectionMatrix()}));const controls=new OrbitControls(camera,renderer.domElement);controls.enablePan=!1,controls.enableDamping=!0,controls.dampingFactor=.05,controls.rotateSpeed=-1,controls.autoRotate=!1,controls.autoRotateSpeed*=.25,camera.position.set(0,0,0),camera.rotation.order="YXZ";const newPos=new THREE.Vector3(0,0,0),newRot=(new THREE.Quaternion).setFromEuler(new THREE.Euler(0,150,0));resetCameraRotation(newPos,newRot),controls.minDistance=30,controls.maxDistance=280,controls.zoomSpeed=3;const zoomSpeed=.1,perspectiveFactor=.1,minPerspective=10,maxPerspective=90;function createAngleIndicator(){return angleIndicator.textContent="↑",viewElem.appendChild(angleIndicator),angleIndicator.addEventListener("click",(()=>{resetCameraRotation()})),angleIndicator}createAngleIndicator();const initialCameraRotation=camera.rotation.clone(),initialCameraPosition=camera.position.clone(),defaultPosition=new THREE.Vector3(0,0,0),defaultRotation=(new THREE.Quaternion).setFromEuler(new THREE.Euler(0,0,0));function resetCameraRotation(e=defaultPosition,t=defaultRotation){const n=(new THREE.Quaternion).setFromEuler(camera.rotation.clone()),o=(new THREE.Quaternion).setFromEuler(t),i=camera.position.clone(),a=e.clone(),s=performance.now();!function e(){const t=performance.now()-s,r=Math.min(t/1e3,1);camera.quaternion.slerpQuaternions(n,o,r),camera.position.lerpVectors(i,a,r),controls.target.copy(camera.position).add(new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion));const l=-Math.atan2(camera.position.x,camera.position.z);angleIndicator.style.transform=`translate(-50%, -50%) rotate(${l}rad)`,t<1e3&&requestAnimationFrame(e)}()}function toggleFullscreen(){document.fullscreenElement?document.exitFullscreen&&(fullscreenButton.classList.remove("fullscreen"),document.exitFullscreen()):(document.documentElement.requestFullscreen(),fullscreenButton.classList.add("fullscreen"))}fullscreenButton.addEventListener("click",toggleFullscreen),fullscreenButton.addEventListener("touchstart",toggleFullscreen),fullscreenButton.addEventListener("selectstart",toggleFullscreen),window.addEventListener("resize",(function(e){if(camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight),labelRenderer.setSize(window.innerWidth,window.innerHeight),renderer.setPixelRatio(window.devicePixelRatio),render(),0!==locationsElem.style.bottom){let e=locationsElem.getBoundingClientRect().height;locationsElem.style.bottom="-"+e+"px"}updateMapLinkPosition()})),scrollableContent.addEventListener("wheel",(function(e){e.preventDefault();const t=e.deltaY;scrollableContent.scrollLeft+=t}));let startX,scrollLeft,isDragging=!1;function restoreCursor(){isDragging=!1,scrollableContent.style.cursor="grab"}function scrollLocation(e){if(!isDragging)return;const t=3*(e.pageX-scrollableContent.offsetLeft-startX);scrollableContent.scrollLeft=scrollLeft-t}function resetSettings(){document.getElementsByTagName("canvas")[0].style.filter="contrast(1) brightness(1) saturate(1)",settingsAmbient.value="3.5",settingsAmbientNo.textContent="3.5",updateLight(3.5),settingsBrightness.value="1",settingsBrightnessNo.textContent="1",settingsContrast.value="1",settingsContrastNo.textContent="1",settingsSaturate.value="1",settingsSaturateNo.textContent="1",settingsVolume.value="1",settingsVolumeNo.textContent="1",video.volume="1"}function closeSettings(){settingsButton.style.opacity="1",settingsElem.style.right="-640px"}function openInfo(){infoButton.style.opacity="0",infoElem.style.right="0"}function closeInfo(){infoButton.style.opacity="1",infoElem.style.right="-600px",infoElem.style.width="460px"}function readSRTFile(e){const t=new FileReader;t.onload=function(e){const t=parseSRT(e.target.result);console.log(t),displayCaption(t)},t.readAsText(e)}function parseSRT(e){const t=e.trim().split(/\r?\n/),n=[];let o={};for(let e=0;e<t.length;e++){const i=t[e].trim();if(i)if(o.id)if(o.start)o.text?(n.push(o),o={}):o.text=i;else{const e=i.split(" --\x3e ");if(2!==e.length){o={};continue}o.start=srtTimeToSeconds(e[0]),o.end=srtTimeToSeconds(e[1])}else o.id=parseInt(i)}return console.log(n),n}function srtTimeToSeconds(e){console.log(e);const[t,n,o]=e.split(":").map(parseFloat);let[i,a]=[0,0];if("string"==typeof o&&o.includes(",")){const e=o.split(",");i=parseFloat(e[0]),a=parseFloat(e[1])}else i=parseFloat(o);return 3600*t+60*n+i+a/1e3}function displayCaption(e){video.addEventListener("timeupdate",(function(){const t=video.currentTime,n=document.getElementById("caption");for(const o of e)if(t>=o.start&&t<=o.end)return void(n.innerHTML=`<p>${o.text}</p>`);n.innerHTML=""}))}scrollableContent.addEventListener("mousedown",(function(e){e.preventDefault(),isDragging=!0,startX=e.pageX-scrollableContent.offsetLeft,scrollLeft=scrollableContent.scrollLeft,scrollableContent.style.cursor="grabbing"})),scrollableContent.addEventListener("touchstart",(function(e){e.preventDefault(),isDragging=!0,startX=e.pageX-scrollableContent.offsetLeft,scrollLeft=scrollableContent.scrollLeft,scrollableContent.style.cursor="grabbing"})),scrollableContent.addEventListener("mouseup",restoreCursor),scrollableContent.addEventListener("touchstart",restoreCursor),scrollableContent.addEventListener("mouseleave",restoreCursor),scrollableContent.addEventListener("mousemove",(e=>{scrollLocation(e)})),scrollableContent.addEventListener("touchmove",(e=>{scrollLocation(e)})),settingsVolume.addEventListener("input",(()=>{const e=settingsVolume.value;video.volume=e,settingsVolumeNo.textContent=e})),settingsAmbient.addEventListener("input",(()=>{const e=settingsAmbient.value;updateLight(e),settingsAmbientNo.textContent=e})),settingsBrightness.addEventListener("input",(()=>{const e=document.getElementsByTagName("canvas")[0],t=e.style.filter||"contrast(1) brightness(1) saturate(1)",n=parseFloat(t.match(/contrast\((\d+(\.\d+)?)\)/)[1]),o=parseFloat(t.match(/saturate\((\d+(\.\d+)?)\)/)[1]),i=settingsBrightness.value;e.style.filter=`contrast(${n}) brightness(${i}) saturate(${o})`,settingsBrightnessNo.textContent=i})),settingsContrast.addEventListener("input",(()=>{const e=document.getElementsByTagName("canvas")[0],t=e.style.filter||"contrast(1) brightness(1) saturate(1)",n=parseFloat(t.match(/brightness\((\d+(\.\d+)?)\)/)[1]),o=parseFloat(t.match(/saturate\((\d+(\.\d+)?)\)/)[1]),i=settingsContrast.value;e.style.filter=`contrast(${i}) brightness(${n}) saturate(${o})`,settingsContrastNo.textContent=i})),settingsSaturate.addEventListener("input",(()=>{const e=document.getElementsByTagName("canvas")[0],t=e.style.filter||"contrast(1) brightness(1) saturate(1)",n=parseFloat(t.match(/brightness\((\d+(\.\d+)?)\)/)[1]),o=parseFloat(t.match(/contrast\((\d+(\.\d+)?)\)/)[1]),i=settingsSaturate.value;e.style.filter=`contrast(${o}) brightness(${n}) saturate(${i})`,settingsSaturateNo.textContent=i})),resetButton.addEventListener("click",resetSettings),resetButton.addEventListener("touchstart",resetSettings),resetButton.addEventListener("selectstart",resetSettings),closeSettingsButton.addEventListener("click",closeSettings),closeSettingsButton.addEventListener("touchstart",closeSettings),closeSettingsButton.addEventListener("selectstart",closeSettings),infoButton.addEventListener("click",openInfo),infoButton.addEventListener("touchstart",openInfo),infoButton.addEventListener("selectstart",openInfo),closeInfoButton.addEventListener("click",closeInfo),closeInfoButton.addEventListener("touchstart",closeInfo),closeInfoButton.addEventListener("selectstart",closeInfo),document.addEventListener("DOMContentLoaded",(function(){!function e(){const t=document.querySelector("#locations .container ul li:first-child");if(t){const e=contentArray[0].id;change360Content(parseInt(e)),t.classList.add("active")}else setTimeout(e,1e3)}()}));const map=document.getElementById("map"),mapImage=document.getElementById("mapimage"),mapImg=document.getElementById("mapimg");mapImg.src="img/"+mapArray[0].file,mapArray[0].links.forEach((e=>{let t=`<div class="maplink ${e.left>50?" linktextleft":""}" data-id="${e.link}" style="top: ${e.top}%; left: ${e.left}%">\n            <span>${e.name}</span>\n        </div>`;mapImage.insertAdjacentHTML("beforeend",t)}));const mapLinks=document.querySelectorAll(".maplink");function updateMapLinkPosition(){mapImage.style.width="100%",mapImage.style.height="100%";const e=mapImage.clientWidth,t=mapImage.clientHeight,n=mapImg.naturalWidth,o=mapImg.naturalHeight;let i,a;e/t<n/o?(i=e,a=e/n*o):(a=t,i=t/o*n),mapImage.style.width=i+"px",mapImage.style.height=a+"px"}function toggleMap(){"none"===map.style.display?(map.style.display="flex",updateMapLinkPosition()):map.style.display="none"}function createMarkers(e){e.forEach((e=>{const{name:t,position:n,info:o,link:i}=e,a=new THREE.Vector3(n.x,n.y,n.z),s=document.createElement("a");s.className="marker","string"==typeof i&&""!==i?(s.href=i,s.target="_blank",s.classList.add("extlink")):"number"==typeof i?(s.href="#",s.dataset.id=i,s.classList.add("intlink")):(s.href="#",s.classList.add("infodot"));let r=`<span>${t}</span><div class="marker-container"></div>`;s.innerHTML=r,s.querySelector(".marker-container").insertAdjacentHTML("afterbegin",o);const l=new CSS2DObject(s);l.position.copy(a),root.add(l)}))}mapLinks.forEach((e=>{e.addEventListener("click",(e=>{const t=parseInt(e.target.getAttribute("data-id"));map.style.display="none",listItems.forEach((e=>{e.classList.remove("active")}));document.querySelector(`#locations [data-id="${t}"]`).classList.add("active"),change360Content(parseInt(t))}))})),mapButton.addEventListener("click",toggleMap),mapButton.addEventListener("touchstart",toggleMap),mapButton.addEventListener("selectstart",toggleMap),updateMapLinkPosition();